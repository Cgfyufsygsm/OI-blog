<!DOCTYPE html>
<html dir="ltr" lang="zh-CN">
<head><meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1" name="viewport"/><meta content="äºŒå‰æœç´¢æ ‘(BST) BST æ˜¯ä¸€ç§å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹å‚¨å­˜ç€ä¸€ä¸ªå¯ä»¥æ¯”è¾ƒå¤§å°çš„æƒå€¼ï¼Œå¹¶ä¸”å…¶æ»¡è¶³å¦‚ä¸‹æ€§è´¨ï¼šå¯¹äºä»»æ„èŠ‚ç‚¹ \(u\)ï¼Œå…¶å·¦å­æ ‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å†…æ‰€æœ‰èŠ‚ç‚¹çš„æƒå€¼å‡å°äº \(u\) çš„æƒå€¼ï¼Œå…¶å³å­æ ‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å†…æ‰€æœ‰èŠ‚ç‚¹çš„æƒå€¼å‡å¤§äº \(u\) çš„æƒå€¼ã€‚
ä¸éš¾å‘ç°è¿™æ£µæ ‘å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼šè¿™æ£µæ ‘çš„ä¸­åºéå†å°±æ˜¯æ’å¥½åºçš„åºåˆ—ï¼Œå¹¶ä¸”å¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œæ’å…¥åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œï¼ˆåªéœ€å±‚å±‚é€’å½’å³å¯ï¼‰ï¼ŒåŒæ—¶å¯ä»¥ç»Ÿè®¡ä¸€ä¸ªå…ƒç´ çš„æ’åï¼ˆåªéœ€çœ‹å·¦è¾¹æœ‰å¤šå°‘èŠ‚ç‚¹ï¼‰ã€‚
ç„¶è€Œï¼Œå¦‚æœæ’å…¥çš„åºåˆ—æ˜¯ä¸€ä¸ªé€’å¢çš„åºåˆ—ï¼Œåˆ™ BST çš„å¤æ‚åº¦å¯ä»¥é€€åŒ–åˆ° \(O(n)\)ï¼Œè¿™æ ·çš„è¯æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ çš„å¤æ‚åº¦å’Œåœ¨çº¿æ€§è¡¨å†…æŸ¥æ‰¾å°±æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«äº†ï¼Œéœ€è¦è¿›è¡Œä¼˜åŒ–ã€‚
ä¸éš¾å‘ç°ï¼Œå¯¹äºä¸€ä¸ªé›†åˆï¼Œå¦‚æœæˆ‘ä»¬å°†ä»–å»ºæ„æˆä¸€æ£µ BSTï¼Œå¯ä»¥æœ‰å¾ˆå¤šæƒ…å†µï¼Œè€Œå¾ˆæ˜æ˜¾åœ°ï¼šå·¦å³å¹³è¡¡çš„ç»“æ„æ˜¯ç›¸å¯¹æ¯”è¾ƒä¼˜çš„ï¼Œè¿™æ ·å­çš„è¯æ“ä½œçš„æœŸæœ›å¤æ‚åº¦ä¸º \(O(\log n)\)ï¼Œè¾¾åˆ°äº†æˆ‘ä»¬çš„ç›®çš„ã€‚
ä¸‹é¢å­¦ä¹ ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„å¯ä»¥ä½¿ BST å¹³è¡¡çš„æ‰‹æ³•
Treap ç®€ä»‹ Treap=Tree+Heapï¼Œæ˜¯ä¸€ç§ç›¸å¯¹å¥½å†™çš„å¹³è¡¡ BSTï¼ˆç®€ç§°å¹³è¡¡æ ‘ï¼‰ï¼Œä»å…¶å‘½åå¯ä»¥çœ‹å‡ºæ¥å®ƒæ˜¯ä¸€ä¸ªå †ï¼ˆHeap) ä¸ BSTï¼ˆTreeï¼‰çš„ç»“åˆä½“ã€‚
Treap æœ‰å¦‚ä¸‹æ€§è´¨ï¼š
æ˜¯ä¸€æ£µå…³äºå…ƒç´ å€¼ val çš„ BST æ˜¯å…³äºæƒå€¼ priorityï¼ˆä¸€èˆ¬æ˜¯éšæœºçš„ï¼‰çš„å †ï¼ˆå°æ ¹å¤§æ ¹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼‰ val å’Œ priority ç¡®å®šæ—¶ï¼ŒTreap å”¯ä¸€ è¿™æ ·éšæœºç»™å…ƒç´ åˆ†é…æƒå€¼å¯ä»¥ä½¿å¾— Treap ä¸å®¹æ˜“é€€åŒ–æˆé“¾ï¼Œä½¿æŸ¥æ‰¾/æ’å…¥/åˆ é™¤/ç¬¬ \(k\) å¤§/æ’åçš„æ“ä½œéƒ½æ˜¯ \(O(\log n)\) çš„ã€‚
Initialization é¦–å…ˆæ˜¯ Treap çš„æ•°ç»„å½¢å¼å®šä¹‰ï¼ˆæŒ‡é’ˆå¤ªéš¾å†™äº†è€Œä¸”å®¹æ˜“å‡ºå¥‡å¥‡æ€ªæ€ªçš„ bugï¼‰
struct treap { int ch[2];//å­˜å‚¨å·¦/å³å„¿å­çš„ç¼–å· int cnt,size;//å­˜å‚¨å½“å‰å…ƒç´ çš„æ•°é‡å’Œå­æ ‘å¤§å° int val,p;//valä¸ºå…ƒç´ å€¼ï¼Œpä¸ºéšæœºæƒå€¼ }t[maxn]; ä¸‹é¢æ“ä½œç±»ä¼¼äºçº¿æ®µæ ‘çš„ pushupï¼Œä¸»è¦æ˜¯ä¸‹é¢ä¿¡æ¯æ”¹å˜åç»´æŠ¤å­æ ‘å¤§å°ç”¨
#define L t[u].ch[0] #define R t[u].ch[1] inline void maintain(int u) { t[u]." name="description"/><title>å¹³è¡¡æ ‘ç¬”è®°</title>
<link href="https://oi.imyangty.com/note-bst/" rel="canonical"/>
<link href="/scss/style.min.a5821f3d3ab84ce5a0ac21477e347a2e0ca00292e398d16c5e8e36ded6e35a23.css" rel="stylesheet"/><meta content="å¹³è¡¡æ ‘ç¬”è®°" property="og:title"/>
<meta content="äºŒå‰æœç´¢æ ‘(BST) BST æ˜¯ä¸€ç§å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹å‚¨å­˜ç€ä¸€ä¸ªå¯ä»¥æ¯”è¾ƒå¤§å°çš„æƒå€¼ï¼Œå¹¶ä¸”å…¶æ»¡è¶³å¦‚ä¸‹æ€§è´¨ï¼šå¯¹äºä»»æ„èŠ‚ç‚¹ \(u\)ï¼Œå…¶å·¦å­æ ‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å†…æ‰€æœ‰èŠ‚ç‚¹çš„æƒå€¼å‡å°äº \(u\) çš„æƒå€¼ï¼Œå…¶å³å­æ ‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å†…æ‰€æœ‰èŠ‚ç‚¹çš„æƒå€¼å‡å¤§äº \(u\) çš„æƒå€¼ã€‚
ä¸éš¾å‘ç°è¿™æ£µæ ‘å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼šè¿™æ£µæ ‘çš„ä¸­åºéå†å°±æ˜¯æ’å¥½åºçš„åºåˆ—ï¼Œå¹¶ä¸”å¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œæ’å…¥åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œï¼ˆåªéœ€å±‚å±‚é€’å½’å³å¯ï¼‰ï¼ŒåŒæ—¶å¯ä»¥ç»Ÿè®¡ä¸€ä¸ªå…ƒç´ çš„æ’åï¼ˆåªéœ€çœ‹å·¦è¾¹æœ‰å¤šå°‘èŠ‚ç‚¹ï¼‰ã€‚
ç„¶è€Œï¼Œå¦‚æœæ’å…¥çš„åºåˆ—æ˜¯ä¸€ä¸ªé€’å¢çš„åºåˆ—ï¼Œåˆ™ BST çš„å¤æ‚åº¦å¯ä»¥é€€åŒ–åˆ° \(O(n)\)ï¼Œè¿™æ ·çš„è¯æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ çš„å¤æ‚åº¦å’Œåœ¨çº¿æ€§è¡¨å†…æŸ¥æ‰¾å°±æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«äº†ï¼Œéœ€è¦è¿›è¡Œä¼˜åŒ–ã€‚
ä¸éš¾å‘ç°ï¼Œå¯¹äºä¸€ä¸ªé›†åˆï¼Œå¦‚æœæˆ‘ä»¬å°†ä»–å»ºæ„æˆä¸€æ£µ BSTï¼Œå¯ä»¥æœ‰å¾ˆå¤šæƒ…å†µï¼Œè€Œå¾ˆæ˜æ˜¾åœ°ï¼šå·¦å³å¹³è¡¡çš„ç»“æ„æ˜¯ç›¸å¯¹æ¯”è¾ƒä¼˜çš„ï¼Œè¿™æ ·å­çš„è¯æ“ä½œçš„æœŸæœ›å¤æ‚åº¦ä¸º \(O(\log n)\)ï¼Œè¾¾åˆ°äº†æˆ‘ä»¬çš„ç›®çš„ã€‚
ä¸‹é¢å­¦ä¹ ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„å¯ä»¥ä½¿ BST å¹³è¡¡çš„æ‰‹æ³•
Treap ç®€ä»‹ Treap=Tree+Heapï¼Œæ˜¯ä¸€ç§ç›¸å¯¹å¥½å†™çš„å¹³è¡¡ BSTï¼ˆç®€ç§°å¹³è¡¡æ ‘ï¼‰ï¼Œä»å…¶å‘½åå¯ä»¥çœ‹å‡ºæ¥å®ƒæ˜¯ä¸€ä¸ªå †ï¼ˆHeap) ä¸ BSTï¼ˆTreeï¼‰çš„ç»“åˆä½“ã€‚
Treap æœ‰å¦‚ä¸‹æ€§è´¨ï¼š
æ˜¯ä¸€æ£µå…³äºå…ƒç´ å€¼ val çš„ BST æ˜¯å…³äºæƒå€¼ priorityï¼ˆä¸€èˆ¬æ˜¯éšæœºçš„ï¼‰çš„å †ï¼ˆå°æ ¹å¤§æ ¹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼‰ val å’Œ priority ç¡®å®šæ—¶ï¼ŒTreap å”¯ä¸€ è¿™æ ·éšæœºç»™å…ƒç´ åˆ†é…æƒå€¼å¯ä»¥ä½¿å¾— Treap ä¸å®¹æ˜“é€€åŒ–æˆé“¾ï¼Œä½¿æŸ¥æ‰¾/æ’å…¥/åˆ é™¤/ç¬¬ \(k\) å¤§/æ’åçš„æ“ä½œéƒ½æ˜¯ \(O(\log n)\) çš„ã€‚
Initialization é¦–å…ˆæ˜¯ Treap çš„æ•°ç»„å½¢å¼å®šä¹‰ï¼ˆæŒ‡é’ˆå¤ªéš¾å†™äº†è€Œä¸”å®¹æ˜“å‡ºå¥‡å¥‡æ€ªæ€ªçš„ bugï¼‰
struct treap { int ch[2];//å­˜å‚¨å·¦/å³å„¿å­çš„ç¼–å· int cnt,size;//å­˜å‚¨å½“å‰å…ƒç´ çš„æ•°é‡å’Œå­æ ‘å¤§å° int val,p;//valä¸ºå…ƒç´ å€¼ï¼Œpä¸ºéšæœºæƒå€¼ }t[maxn]; ä¸‹é¢æ“ä½œç±»ä¼¼äºçº¿æ®µæ ‘çš„ pushupï¼Œä¸»è¦æ˜¯ä¸‹é¢ä¿¡æ¯æ”¹å˜åç»´æŠ¤å­æ ‘å¤§å°ç”¨
#define L t[u].ch[0] #define R t[u].ch[1] inline void maintain(int u) { t[u]." property="og:description"/>
<meta content="https://oi.imyangty.com/note-bst/" property="og:url"/>
<meta content="æ¸…çƒ›çš„åšå®¢" property="og:site_name"/>
<meta content="article" property="og:type"/><meta content="Post" property="article:section"/><meta content="OI" property="article:tag"/><meta content="ç¬”è®°" property="article:tag"/><meta content="å¹³è¡¡æ ‘" property="article:tag"/><meta content="2020-12-12T14:20:29+08:00" property="article:published_time"/><meta content="2020-12-12T14:20:29+08:00" property="article:modified_time"/><meta content="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg8.webp" property="og:image"/>
<meta content="å¹³è¡¡æ ‘ç¬”è®°" name="twitter:title"/>
<meta content="äºŒå‰æœç´¢æ ‘(BST) BST æ˜¯ä¸€ç§å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹å‚¨å­˜ç€ä¸€ä¸ªå¯ä»¥æ¯”è¾ƒå¤§å°çš„æƒå€¼ï¼Œå¹¶ä¸”å…¶æ»¡è¶³å¦‚ä¸‹æ€§è´¨ï¼šå¯¹äºä»»æ„èŠ‚ç‚¹ \(u\)ï¼Œå…¶å·¦å­æ ‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å†…æ‰€æœ‰èŠ‚ç‚¹çš„æƒå€¼å‡å°äº \(u\) çš„æƒå€¼ï¼Œå…¶å³å­æ ‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å†…æ‰€æœ‰èŠ‚ç‚¹çš„æƒå€¼å‡å¤§äº \(u\) çš„æƒå€¼ã€‚
ä¸éš¾å‘ç°è¿™æ£µæ ‘å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼šè¿™æ£µæ ‘çš„ä¸­åºéå†å°±æ˜¯æ’å¥½åºçš„åºåˆ—ï¼Œå¹¶ä¸”å¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œæ’å…¥åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œï¼ˆåªéœ€å±‚å±‚é€’å½’å³å¯ï¼‰ï¼ŒåŒæ—¶å¯ä»¥ç»Ÿè®¡ä¸€ä¸ªå…ƒç´ çš„æ’åï¼ˆåªéœ€çœ‹å·¦è¾¹æœ‰å¤šå°‘èŠ‚ç‚¹ï¼‰ã€‚
ç„¶è€Œï¼Œå¦‚æœæ’å…¥çš„åºåˆ—æ˜¯ä¸€ä¸ªé€’å¢çš„åºåˆ—ï¼Œåˆ™ BST çš„å¤æ‚åº¦å¯ä»¥é€€åŒ–åˆ° \(O(n)\)ï¼Œè¿™æ ·çš„è¯æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ çš„å¤æ‚åº¦å’Œåœ¨çº¿æ€§è¡¨å†…æŸ¥æ‰¾å°±æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«äº†ï¼Œéœ€è¦è¿›è¡Œä¼˜åŒ–ã€‚
ä¸éš¾å‘ç°ï¼Œå¯¹äºä¸€ä¸ªé›†åˆï¼Œå¦‚æœæˆ‘ä»¬å°†ä»–å»ºæ„æˆä¸€æ£µ BSTï¼Œå¯ä»¥æœ‰å¾ˆå¤šæƒ…å†µï¼Œè€Œå¾ˆæ˜æ˜¾åœ°ï¼šå·¦å³å¹³è¡¡çš„ç»“æ„æ˜¯ç›¸å¯¹æ¯”è¾ƒä¼˜çš„ï¼Œè¿™æ ·å­çš„è¯æ“ä½œçš„æœŸæœ›å¤æ‚åº¦ä¸º \(O(\log n)\)ï¼Œè¾¾åˆ°äº†æˆ‘ä»¬çš„ç›®çš„ã€‚
ä¸‹é¢å­¦ä¹ ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„å¯ä»¥ä½¿ BST å¹³è¡¡çš„æ‰‹æ³•
Treap ç®€ä»‹ Treap=Tree+Heapï¼Œæ˜¯ä¸€ç§ç›¸å¯¹å¥½å†™çš„å¹³è¡¡ BSTï¼ˆç®€ç§°å¹³è¡¡æ ‘ï¼‰ï¼Œä»å…¶å‘½åå¯ä»¥çœ‹å‡ºæ¥å®ƒæ˜¯ä¸€ä¸ªå †ï¼ˆHeap) ä¸ BSTï¼ˆTreeï¼‰çš„ç»“åˆä½“ã€‚
Treap æœ‰å¦‚ä¸‹æ€§è´¨ï¼š
æ˜¯ä¸€æ£µå…³äºå…ƒç´ å€¼ val çš„ BST æ˜¯å…³äºæƒå€¼ priorityï¼ˆä¸€èˆ¬æ˜¯éšæœºçš„ï¼‰çš„å †ï¼ˆå°æ ¹å¤§æ ¹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼‰ val å’Œ priority ç¡®å®šæ—¶ï¼ŒTreap å”¯ä¸€ è¿™æ ·éšæœºç»™å…ƒç´ åˆ†é…æƒå€¼å¯ä»¥ä½¿å¾— Treap ä¸å®¹æ˜“é€€åŒ–æˆé“¾ï¼Œä½¿æŸ¥æ‰¾/æ’å…¥/åˆ é™¤/ç¬¬ \(k\) å¤§/æ’åçš„æ“ä½œéƒ½æ˜¯ \(O(\log n)\) çš„ã€‚
Initialization é¦–å…ˆæ˜¯ Treap çš„æ•°ç»„å½¢å¼å®šä¹‰ï¼ˆæŒ‡é’ˆå¤ªéš¾å†™äº†è€Œä¸”å®¹æ˜“å‡ºå¥‡å¥‡æ€ªæ€ªçš„ bugï¼‰
struct treap { int ch[2];//å­˜å‚¨å·¦/å³å„¿å­çš„ç¼–å· int cnt,size;//å­˜å‚¨å½“å‰å…ƒç´ çš„æ•°é‡å’Œå­æ ‘å¤§å° int val,p;//valä¸ºå…ƒç´ å€¼ï¼Œpä¸ºéšæœºæƒå€¼ }t[maxn]; ä¸‹é¢æ“ä½œç±»ä¼¼äºçº¿æ®µæ ‘çš„ pushupï¼Œä¸»è¦æ˜¯ä¸‹é¢ä¿¡æ¯æ”¹å˜åç»´æŠ¤å­æ ‘å¤§å°ç”¨
#define L t[u].ch[0] #define R t[u].ch[1] inline void maintain(int u) { t[u]." name="twitter:description"/><meta content="summary_large_image" name="twitter:card"/>
<meta content="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg8.webp" name="twitter:image"/>
<link href="https://q1.qlogo.cn/g?b=qq&amp;nk=375836877&amp;s=5" rel="shortcut icon"/>
<link href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.5.1/build/styles/github-dark-dimmed.min.css" rel="stylesheet"/>
<script src="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release/build/highlight.min.js"></script>
<script>hljs.highlightAll();</script>
</head>
<body class="article-page">
<script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky">
<button aria-label="åˆ‡æ¢èœå•" class="hamburger hamburger--spin" id="toggle-menu" type="button">
<span class="hamburger-box">
<span class="hamburger-inner"></span>
</span>
</button>
<header>
<figure class="site-avatar">
<a href="/">
<img alt="Avatar" class="site-logo" height="300" loading="lazy" src="/img/avatar_huea3ce2119467b51fdd2a81393644a76d_51594_300x0_resize_q75_box.jpg" width="300"/>
</a>
<span class="emoji">ğŸ˜…</span>
</figure>
<div class="site-meta">
<h1 class="site-name"><a href="/">æ¸…çƒ›çš„åšå®¢</a></h1>
<h2 class="site-description">çƒŸç«å·²è°¢ï¼Œç¬™æ­Œæœªåœ</h2>
</div>
</header><ol class="social-menu">
<li>
<a href="mailto:i@imyangty.com" target="_blank" title="email">
<svg class="icon icon-tabler icon-tabler-mail" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
<rect height="14" rx="2" width="18" x="3" y="5"></rect>
<polyline points="3 7 12 13 21 7"></polyline>
</svg>
</a>
</li>
<li>
<a href="https://github.com/Cgfyufsygsm" target="_blank" title="GitHub">
<svg class="icon icon-tabler icon-tabler-brand-github" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
<path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5"></path>
</svg>
</a>
</li>
<li>
<a href="https://t.me/Cgfyufsygsm" target="_blank" title="Telegram">
<svg class="icon icon-tabler icon-tabler-brand-telegram" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
<path d="M15 10l-4 4l6 6l4 -16l-18 7l4 2l2 6l3 -4"></path>
</svg>
</a>
</li>
<li>
<a href="https://twitter.com/Cgfyufsygsm" target="_blank" title="Twitter">
<svg class="icon icon-tabler icon-tabler-brand-twitter" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" fill="none" stroke="none"></path>
<path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z"></path>
</svg>
</a>
</li>
</ol><ol class="menu" id="main-menu">
<li>
<a href="/">
<svg class="icon icon-tabler icon-tabler-home" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<polyline points="5 12 3 12 12 3 21 12 19 12"></polyline>
<path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"></path>
<path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"></path>
</svg>
<span>ä¸»é¡µ</span>
</a>
</li>
<li>
<a href="/about/">
<svg class="icon icon-tabler icon-tabler-user" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<circle cx="12" cy="7" r="4"></circle>
<path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2"></path>
</svg>
<span>å…³äº</span>
</a>
</li>
<li>
<a href="/idx/">
<svg class="icon icon-tabler icon-tabler-hash" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<line x1="5" x2="19" y1="9" y2="9"></line>
<line x1="5" x2="19" y1="15" y2="15"></line>
<line x1="11" x2="7" y1="4" y2="20"></line>
<line x1="17" x2="13" y1="4" y2="20"></line>
</svg>
<span>å¯¼èˆª</span>
</a>
</li>
<li>
<a href="/archives/">
<svg class="icon icon-tabler icon-tabler-archive" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<rect height="4" rx="2" width="18" x="3" y="4"></rect>
<path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10"></path>
<line x1="10" x2="14" y1="12" y2="12"></line>
</svg>
<span>å½’æ¡£</span>
</a>
</li>
<li>
<a href="/search/">
<svg class="icon icon-tabler icon-tabler-search" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<circle cx="10" cy="10" r="7"></circle>
<line x1="21" x2="15" y1="21" y2="15"></line>
</svg>
<span>æœç´¢</span>
</a>
</li>
<li>
<a href="/friends/">
<svg class="icon icon-tabler icon-tabler-link" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5"></path>
<path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5"></path>
</svg>
<span>å‹é“¾</span>
</a>
</li>
<li>
<a href="https://blog.imyangty.com" target="_blank">
<svg class="icon icon-tabler icon-tabler-home" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<polyline points="5 12 3 12 12 3 21 12 19 12"></polyline>
<path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7"></path>
<path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6"></path>
</svg>
<span>ä¸»åšå®¢</span>
</a>
</li>
<div class="menu-bottom-section">
<li id="dark-mode-toggle">
<svg class="icon icon-tabler icon-tabler-toggle-left" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<circle cx="8" cy="12" r="2"></circle>
<rect height="12" rx="6" width="20" x="2" y="6"></rect>
</svg>
<svg class="icon icon-tabler icon-tabler-toggle-right" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<circle cx="16" cy="12" r="2"></circle>
<rect height="12" rx="6" width="20" x="2" y="6"></rect>
</svg>
<span>æš—è‰²æ¨¡å¼</span>
</li>
</div>
</ol>
</aside>
<main class="main full-width">
<article class="has-image main-article">
<header class="article-header">
<div class="article-image">
<a href="/note-bst/">
<img alt="Featured image of post å¹³è¡¡æ ‘ç¬”è®°" loading="lazy" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg8.webp"/>
</a>
</div>
<div class="article-details">
<header class="article-category">
<a href="/categories/oi/">
                OI
            </a>
<a href="/categories/note/">
                ç¬”è®°
            </a>
</header>
<div class="article-title-wrapper">
<h2 class="article-title">
<a href="/note-bst/">å¹³è¡¡æ ‘ç¬”è®°</a>
</h2>
</div>
<footer class="article-time">
<div>
<svg class="icon icon-tabler icon-tabler-calendar-time" fill="none" height="56" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="56" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4"></path>
<circle cx="18" cy="18" r="4"></circle>
<path d="M15 3v4"></path>
<path d="M7 3v4"></path>
<path d="M3 11h16"></path>
<path d="M18 16.496v1.504l1 1"></path>
</svg>
<time class="article-time--published">Dec 12, 2020</time>
</div>
<div>
<svg class="icon icon-tabler icon-tabler-clock" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<circle cx="12" cy="12" r="9"></circle>
<polyline points="12 7 12 12 15 15"></polyline>
</svg>
<time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 25 åˆ†é’Ÿ
                </time>
</div>
</footer>
</div>
</header>
<section class="article-content">
<h2 id="äºŒå‰æœç´¢æ ‘bst">äºŒå‰æœç´¢æ ‘(BST)</h2>
<p>BST æ˜¯ä¸€ç§å¸¸ç”¨çš„æ•°æ®ç»“æ„ï¼Œæ¯ä¸ªèŠ‚ç‚¹å‚¨å­˜ç€ä¸€ä¸ªå¯ä»¥æ¯”è¾ƒå¤§å°çš„æƒå€¼ï¼Œå¹¶ä¸”å…¶æ»¡è¶³å¦‚ä¸‹æ€§è´¨ï¼šå¯¹äºä»»æ„èŠ‚ç‚¹ <span class="math inline">\(u\)</span>ï¼Œå…¶å·¦å­æ ‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å†…æ‰€æœ‰èŠ‚ç‚¹çš„æƒå€¼å‡å°äº <span class="math inline">\(u\)</span> çš„æƒå€¼ï¼Œå…¶å³å­æ ‘ï¼ˆå¦‚æœå­˜åœ¨ï¼‰å†…æ‰€æœ‰èŠ‚ç‚¹çš„æƒå€¼å‡å¤§äº <span class="math inline">\(u\)</span> çš„æƒå€¼ã€‚</p>
<p>ä¸éš¾å‘ç°è¿™æ£µæ ‘å¯ä»¥åšå¾ˆå¤šäº‹æƒ…ï¼šè¿™æ£µæ ‘çš„ä¸­åºéå†å°±æ˜¯æ’å¥½åºçš„åºåˆ—ï¼Œå¹¶ä¸”å¯ä»¥å¾ˆæ–¹ä¾¿çš„è¿›è¡Œæ’å…¥åˆ é™¤å’ŒæŸ¥æ‰¾æ“ä½œï¼ˆåªéœ€å±‚å±‚é€’å½’å³å¯ï¼‰ï¼ŒåŒæ—¶å¯ä»¥ç»Ÿè®¡ä¸€ä¸ªå…ƒç´ çš„æ’åï¼ˆåªéœ€çœ‹å·¦è¾¹æœ‰å¤šå°‘èŠ‚ç‚¹ï¼‰ã€‚</p>
<p>ç„¶è€Œï¼Œå¦‚æœæ’å…¥çš„åºåˆ—æ˜¯ä¸€ä¸ªé€’å¢çš„åºåˆ—ï¼Œåˆ™ BST çš„å¤æ‚åº¦å¯ä»¥é€€åŒ–åˆ° <span class="math inline">\(O(n)\)</span>ï¼Œè¿™æ ·çš„è¯æŸ¥æ‰¾ä¸€ä¸ªå…ƒç´ çš„å¤æ‚åº¦å’Œåœ¨çº¿æ€§è¡¨å†…æŸ¥æ‰¾å°±æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«äº†ï¼Œéœ€è¦è¿›è¡Œä¼˜åŒ–ã€‚</p>
<p>ä¸éš¾å‘ç°ï¼Œå¯¹äºä¸€ä¸ªé›†åˆï¼Œå¦‚æœæˆ‘ä»¬å°†ä»–å»ºæ„æˆä¸€æ£µ BSTï¼Œå¯ä»¥æœ‰å¾ˆå¤šæƒ…å†µï¼Œè€Œå¾ˆæ˜æ˜¾åœ°ï¼šå·¦å³å¹³è¡¡çš„ç»“æ„æ˜¯ç›¸å¯¹æ¯”è¾ƒä¼˜çš„ï¼Œè¿™æ ·å­çš„è¯æ“ä½œçš„æœŸæœ›å¤æ‚åº¦ä¸º <span class="math inline">\(O(\log n)\)</span>ï¼Œè¾¾åˆ°äº†æˆ‘ä»¬çš„ç›®çš„ã€‚</p>
<p>ä¸‹é¢å­¦ä¹ ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„å¯ä»¥ä½¿ BST å¹³è¡¡çš„æ‰‹æ³•</p>
<h2 id="treap">Treap</h2>
<h3 id="ç®€ä»‹">ç®€ä»‹</h3>
<p>Treap=Tree+Heapï¼Œæ˜¯ä¸€ç§ç›¸å¯¹å¥½å†™çš„å¹³è¡¡ BSTï¼ˆç®€ç§°å¹³è¡¡æ ‘ï¼‰ï¼Œä»å…¶å‘½åå¯ä»¥çœ‹å‡ºæ¥å®ƒæ˜¯ä¸€ä¸ªå †ï¼ˆHeap) ä¸ BSTï¼ˆTreeï¼‰çš„ç»“åˆä½“ã€‚</p>
<p>Treap æœ‰å¦‚ä¸‹æ€§è´¨ï¼š</p>
<ul>
<li>æ˜¯ä¸€æ£µå…³äºå…ƒç´ å€¼ val çš„ BST</li>
<li>æ˜¯å…³äºæƒå€¼ priorityï¼ˆä¸€èˆ¬æ˜¯éšæœºçš„ï¼‰çš„å †ï¼ˆå°æ ¹å¤§æ ¹æ²¡ä»€ä¹ˆåŒºåˆ«ï¼‰</li>
<li>val å’Œ priority ç¡®å®šæ—¶ï¼ŒTreap å”¯ä¸€</li>
</ul>
<p>è¿™æ ·éšæœºç»™å…ƒç´ åˆ†é…æƒå€¼å¯ä»¥ä½¿å¾— Treap ä¸å®¹æ˜“é€€åŒ–æˆé“¾ï¼Œä½¿æŸ¥æ‰¾/æ’å…¥/åˆ é™¤/ç¬¬ <span class="math inline">\(k\)</span> å¤§/æ’åçš„æ“ä½œéƒ½æ˜¯ <span class="math inline">\(O(\log n)\)</span> çš„ã€‚</p>
<h3 id="initialization">Initialization</h3>
<p>é¦–å…ˆæ˜¯ Treap çš„æ•°ç»„å½¢å¼å®šä¹‰ï¼ˆæŒ‡é’ˆå¤ªéš¾å†™äº†è€Œä¸”å®¹æ˜“å‡ºå¥‡å¥‡æ€ªæ€ªçš„ bugï¼‰</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a aria-hidden="true" href="#cb1-1"></a><span class="kw">struct</span> treap</span>
<span id="cb1-2"><a aria-hidden="true" href="#cb1-2"></a>{</span>
<span id="cb1-3"><a aria-hidden="true" href="#cb1-3"></a>    <span class="dt">int</span> ch[<span class="dv">2</span>];<span class="co">//å­˜å‚¨å·¦/å³å„¿å­çš„ç¼–å·</span></span>
<span id="cb1-4"><a aria-hidden="true" href="#cb1-4"></a>    <span class="dt">int</span> cnt,size;<span class="co">//å­˜å‚¨å½“å‰å…ƒç´ çš„æ•°é‡å’Œå­æ ‘å¤§å°</span></span>
<span id="cb1-5"><a aria-hidden="true" href="#cb1-5"></a>    <span class="dt">int</span> val,p;<span class="co">//valä¸ºå…ƒç´ å€¼ï¼Œpä¸ºéšæœºæƒå€¼</span></span>
<span id="cb1-6"><a aria-hidden="true" href="#cb1-6"></a>}t[maxn];</span></code></pre></div>
<p>ä¸‹é¢æ“ä½œç±»ä¼¼äºçº¿æ®µæ ‘çš„ pushupï¼Œä¸»è¦æ˜¯ä¸‹é¢ä¿¡æ¯æ”¹å˜åç»´æŠ¤å­æ ‘å¤§å°ç”¨</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a aria-hidden="true" href="#cb2-1"></a><span class="pp">#define L </span>t[u].ch[<span class="dv">0</span>]</span>
<span id="cb2-2"><a aria-hidden="true" href="#cb2-2"></a><span class="pp">#define R </span>t[u].ch[<span class="dv">1</span>]</span>
<span id="cb2-3"><a aria-hidden="true" href="#cb2-3"></a><span class="kw">inline</span> <span class="dt">void</span> maintain(<span class="dt">int</span> u)</span>
<span id="cb2-4"><a aria-hidden="true" href="#cb2-4"></a>{</span>
<span id="cb2-5"><a aria-hidden="true" href="#cb2-5"></a>    t[u].size=t[u].cnt+t[L].size+t[R].size;</span>
<span id="cb2-6"><a aria-hidden="true" href="#cb2-6"></a>    <span class="cf">return</span>;</span>
<span id="cb2-7"><a aria-hidden="true" href="#cb2-7"></a>}</span></code></pre></div>
<h3 id="æ—‹è½¬">æ—‹è½¬</h3>
<p>æ¥ä¸‹æ¥äº†è§£ä¸€ä¸‹ Treap çš„æ ¸å¿ƒæ“ä½œï¼šæ—‹è½¬ã€‚</p>
<p>Treap çš„æ—‹è½¬æ“ä½œåªéœ€è¦å®è¡Œä¸€æ¬¡ï¼Œè¯´äººè¯å°±æ˜¯ä¸ºäº†ä¿æŒå †çš„æ€§è´¨ï¼Œå°†æŸèŠ‚ç‚¹çš„å„¿å­æ—‹è½¬ä¸Šæ¥ï¼ŒåŒæ—¶è¦ä½¿æ ‘ä»æ»¡è¶³ BST çš„æ€§è´¨ï¼Œæ€ä¹ˆå®ç°å‘¢ï¼Ÿçœ‹ä¸‹å›¾ï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/treap_rotate.png" title="Treap çš„å•æ—‹"/><figcaption>Treap çš„å•æ—‹</figcaption>
</figure>
<p>ç”»å›¾ç†è§£åï¼Œä»£ç å°±æ¯”è¾ƒå®¹æ˜“å†™äº†ï¼š<span class="math inline">\(d\)</span> æ˜¯æ—‹è½¬æ–¹å¼ï¼Œ0 ä¸ºæ—‹è½¬å·¦å„¿å­ä¸Šæ¥ï¼ˆå³æ—‹ï¼‰ï¼Œ1 åˆ™åä¹‹äº¦ç„¶ã€‚</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a aria-hidden="true" href="#cb3-1"></a><span class="dt">void</span> rotate(<span class="dt">int</span> &amp;x,<span class="dt">int</span> d)<span class="co">// x å¼•ç”¨æ˜¯ä¸ºäº†æ–¹ä¾¿ä¿®æ”¹ï¼Œä¸€èˆ¬ä¼ è¿›æ¥çš„å‚å°±æ˜¯ t[u].ch[x]</span></span>
<span id="cb3-2"><a aria-hidden="true" href="#cb3-2"></a>{</span>
<span id="cb3-3"><a aria-hidden="true" href="#cb3-3"></a>    <span class="dt">int</span> k=t[x].ch[d];<span class="co">//è¦æ—‹è½¬ä¸Šæ¥çš„èŠ‚ç‚¹</span></span>
<span id="cb3-4"><a aria-hidden="true" href="#cb3-4"></a>    t[x].ch[d]=t[k].ch[d^<span class="dv">1</span>];</span>
<span id="cb3-5"><a aria-hidden="true" href="#cb3-5"></a>    t[k].ch[d^<span class="dv">1</span>]=x;</span>
<span id="cb3-6"><a aria-hidden="true" href="#cb3-6"></a>    maintain(x);<span class="co">//è¿™é‡Œä¸€å®šè¦å…ˆç»´æŠ¤ x</span></span>
<span id="cb3-7"><a aria-hidden="true" href="#cb3-7"></a>    maintain(x=k);<span class="co">//ç„¶åå°† x çš„å€¼æ”¹å˜ï¼Œå¹¶ç»´æŠ¤ä¹‹</span></span>
<span id="cb3-8"><a aria-hidden="true" href="#cb3-8"></a>}</span></code></pre></div>
<p><strong>æ³¨æ„ <span class="math inline">\(x\)</span> å’Œ <span class="math inline">\(k\)</span> çš„ç»´æŠ¤é¡ºåº</strong>ï¼Œå› ä¸º <span class="math inline">\(k\)</span> çš„ size æ˜¯è¦ä» <span class="math inline">\(x\)</span> é‚£é‡Œæ›´æ–°æ¥çš„ï¼Œæ‰€ä»¥è¦å…ˆå¤„ç†å¥½å„¿å­çš„ç»“æœã€‚</p>
<h3 id="æ’å…¥åˆ é™¤">æ’å…¥/åˆ é™¤</h3>
<p>æ’å…¥æ“ä½œã€‚ç›´æ¥ä»æ ¹å¼€å§‹ï¼ŒäºŒåˆ†æŸ¥æ‰¾åˆ°å¯¹åº”ä½ç½®ï¼Œå¦‚æœå·²ç»å­˜åœ¨åˆ™ <code>++cnt</code>ï¼Œå¦‚æœä¸å­˜åœ¨å°±æ–°å»ºèŠ‚ç‚¹ã€‚</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a aria-hidden="true" href="#cb4-1"></a><span class="dt">void</span> insert(<span class="dt">int</span> &amp;u,<span class="dt">int</span> val)</span>
<span id="cb4-2"><a aria-hidden="true" href="#cb4-2"></a>{</span>
<span id="cb4-3"><a aria-hidden="true" href="#cb4-3"></a>    <span class="cf">if</span>(!u)<span class="co">//å¦‚æœ val ä¸å­˜åœ¨</span></span>
<span id="cb4-4"><a aria-hidden="true" href="#cb4-4"></a>    {</span>
<span id="cb4-5"><a aria-hidden="true" href="#cb4-5"></a>        u=++cnt;<span class="co">//å¼€ä¸€ä¸ªæ–°èŠ‚ç‚¹</span></span>
<span id="cb4-6"><a aria-hidden="true" href="#cb4-6"></a>        t[u].size=t[u].cnt=<span class="dv">1</span>;</span>
<span id="cb4-7"><a aria-hidden="true" href="#cb4-7"></a>        t[u].val=val;</span>
<span id="cb4-8"><a aria-hidden="true" href="#cb4-8"></a>        t[u].p=rand();<span class="co">//éšæœºä¸€ä¸ªæƒå€¼</span></span>
<span id="cb4-9"><a aria-hidden="true" href="#cb4-9"></a>        <span class="cf">return</span>;</span>
<span id="cb4-10"><a aria-hidden="true" href="#cb4-10"></a>    }</span>
<span id="cb4-11"><a aria-hidden="true" href="#cb4-11"></a>    t[u].size++;<span class="co">//å› ä¸ºåŠ åˆ°å­æ ‘é‡Œé¢äº†ï¼Œæ‰€ä»¥ ++size</span></span>
<span id="cb4-12"><a aria-hidden="true" href="#cb4-12"></a>    <span class="cf">if</span>(t[u].val==val)<span class="co">//æ‰¾åˆ°äº†å°±ç›´æ¥å¢åŠ cnt</span></span>
<span id="cb4-13"><a aria-hidden="true" href="#cb4-13"></a>    {</span>
<span id="cb4-14"><a aria-hidden="true" href="#cb4-14"></a>        t[u].cnt++;</span>
<span id="cb4-15"><a aria-hidden="true" href="#cb4-15"></a>        <span class="cf">return</span>;</span>
<span id="cb4-16"><a aria-hidden="true" href="#cb4-16"></a>    }</span>
<span id="cb4-17"><a aria-hidden="true" href="#cb4-17"></a>    <span class="dt">int</span> d=t[u].val&lt;val;<span class="co">//æ¯”è¾ƒå·§å¦™çš„å†™æ³•ï¼Œå¾…æ’å…¥å€¼å¤§çš„è¯å°±æ˜¯1ï¼Œå¯¹åº”å³å„¿å­ï¼Œåä¹‹äº¦ç„¶</span></span>
<span id="cb4-18"><a aria-hidden="true" href="#cb4-18"></a>    insert(t[u].ch[d],val);</span>
<span id="cb4-19"><a aria-hidden="true" href="#cb4-19"></a>    <span class="cf">if</span>(t[u].p&gt;t[t[u].ch[d]].p)<span class="co">//ç»´æŠ¤å°æ ¹å †ï¼Œå¦‚æœæ’å…¥åç ´åäº†å †çš„æ€§è´¨</span></span>
<span id="cb4-20"><a aria-hidden="true" href="#cb4-20"></a>        rotate(u,d);<span class="co">//å°±æŠŠå¯¹åº”å„¿å­æ—‹ä¸Šæ¥</span></span>
<span id="cb4-21"><a aria-hidden="true" href="#cb4-21"></a>    <span class="cf">return</span>;</span>
<span id="cb4-22"><a aria-hidden="true" href="#cb4-22"></a>}</span></code></pre></div>
<p>åˆ é™¤æ“ä½œã€‚æ¯”è¾ƒéš¾æï¼Œé‡åˆ°ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™åˆ†ä¸ºå¦‚ä¸‹æƒ…å†µï¼š</p>
<ol type="1">
<li>å½“å‰èŠ‚ç‚¹ä¸æ˜¯å¾…åˆ é™¤èŠ‚ç‚¹ï¼Œé€’å½’å„¿å­æŸ¥æ‰¾åˆ é™¤</li>
<li>å½“å‰èŠ‚ç‚¹æ˜¯å¾…åˆ é™¤èŠ‚ç‚¹ä½†æ˜¯ä¸ªæ•°å¤§äº 1ï¼Œä¸ªæ•°â€“ ç„¶åè¿”å›</li>
<li>å½“å‰èŠ‚ç‚¹æ˜¯å¾…åˆ é™¤èŠ‚ç‚¹ä¸”ä¸ªæ•°ä¸º 1</li>
<li>è‡³å°‘æœ‰ä¸€ä¸ªå„¿å­ä¸ºç©ºï¼šæŠŠå¦å¤–ä¸€ä¸ªå„¿å­ç¿»ä¸Šæ¥ï¼Œç„¶åç›´æ¥ä¸¢æ‰è‡ªå·±</li>
<li>ä¸¤ä¸ªå„¿å­éƒ½ä¸ä¸ºç©ºï¼šæŠŠéšæœºæƒå€¼è¾ƒä½çš„å„¿å­ç¿»ä¸Šæ¥ï¼Œç„¶ååŒ–ä¸º 1 æƒ…å†µç»§ç»­é€’å½’</li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a aria-hidden="true" href="#cb5-1"></a><span class="dt">void</span> delnode(<span class="dt">int</span> &amp;u,<span class="dt">int</span> val)</span>
<span id="cb5-2"><a aria-hidden="true" href="#cb5-2"></a>{</span>
<span id="cb5-3"><a aria-hidden="true" href="#cb5-3"></a>    <span class="cf">if</span>(!u)<span class="cf">return</span>;<span class="co">//è®¿é—®åˆ°ç©ºäº†</span></span>
<span id="cb5-4"><a aria-hidden="true" href="#cb5-4"></a>    <span class="cf">if</span>(t[u].val==val)<span class="co">//æ‰¾åˆ°å¾…åˆ é™¤èŠ‚ç‚¹</span></span>
<span id="cb5-5"><a aria-hidden="true" href="#cb5-5"></a>    {</span>
<span id="cb5-6"><a aria-hidden="true" href="#cb5-6"></a>        <span class="cf">if</span>(t[u].cnt&gt;<span class="dv">1</span>)<span class="co">//å¤šäºä¸€ä¸ªå°±åªåˆ é™¤ä¸€ä¸ª</span></span>
<span id="cb5-7"><a aria-hidden="true" href="#cb5-7"></a>        {</span>
<span id="cb5-8"><a aria-hidden="true" href="#cb5-8"></a>            t[u].cnt--;</span>
<span id="cb5-9"><a aria-hidden="true" href="#cb5-9"></a>            t[u].size--;</span>
<span id="cb5-10"><a aria-hidden="true" href="#cb5-10"></a>            <span class="cf">return</span>;</span>
<span id="cb5-11"><a aria-hidden="true" href="#cb5-11"></a>        }</span>
<span id="cb5-12"><a aria-hidden="true" href="#cb5-12"></a>        <span class="dt">int</span> d=t[L].p&gt;t[R].p;</span>
<span id="cb5-13"><a aria-hidden="true" href="#cb5-13"></a>        <span class="cf">if</span>((!L)||(!R))<span class="co">//å¦‚æœå·¦æˆ–å³æœ‰è‡³å°‘ä¸€è¾¹ä¸ºç©º</span></span>
<span id="cb5-14"><a aria-hidden="true" href="#cb5-14"></a>            u=L+R;<span class="co">//ç›´æ¥æŠŠéç©ºçš„èµ‹ç»™ u</span></span>
<span id="cb5-15"><a aria-hidden="true" href="#cb5-15"></a>        <span class="cf">else</span> rotate(u,d),delnode(u,val);<span class="co">//å¦åˆ™å°±æŠŠéšæœºæƒå€¼æ›´å°çš„å„¿å­ç¿»ä¸Šæ¥ï¼Œç„¶åé€’å½’å¤„ç†</span></span>
<span id="cb5-16"><a aria-hidden="true" href="#cb5-16"></a>    }</span>
<span id="cb5-17"><a aria-hidden="true" href="#cb5-17"></a>    <span class="cf">else</span> t[u].size--,delnode(t[u].ch[t[u].val&lt;val],val);<span class="co">//size--ï¼Œç„¶åé€’å½’åˆ°å„¿å­é‡Œé¢åˆ é™¤</span></span>
<span id="cb5-18"><a aria-hidden="true" href="#cb5-18"></a>}</span></code></pre></div>
<h3 id="æŸ¥è¯¢æ’åç¬¬-k-å¤§å°">æŸ¥è¯¢æ’å/ç¬¬ <span class="math inline">\(k\)</span> å¤§/å°</h3>
<p>æŸ¥è¯¢æ’åæ“ä½œã€‚è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼ŒåŒæ—¶ä¹Ÿæ˜¯æˆ‘ä»¬ä¸ºä»€ä¹ˆè¦ç»´æŠ¤æ¯ä¸ªèŠ‚ç‚¹çš„ sizeã€‚çœ‹ä»£ç å³èƒ½ç†è§£ï¼š</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a aria-hidden="true" href="#cb6-1"></a><span class="dt">int</span> rank(<span class="dt">int</span> u,<span class="dt">int</span> val)</span>
<span id="cb6-2"><a aria-hidden="true" href="#cb6-2"></a>{</span>
<span id="cb6-3"><a aria-hidden="true" href="#cb6-3"></a>    <span class="cf">if</span>(!u)<span class="cf">return</span> <span class="dv">1</span>;<span class="co">//å¦‚æœåˆ°äº†ç©ºèŠ‚ç‚¹ï¼Œè¿”å› 1ï¼Œå› ä¸ºæ’åå¯ä»¥æ’åˆ° 1</span></span>
<span id="cb6-4"><a aria-hidden="true" href="#cb6-4"></a>    <span class="cf">if</span>(t[u].val==val)<span class="co">//å¦‚æœæ‰¾åˆ°äº†å¯¹åº”çš„æ•°</span></span>
<span id="cb6-5"><a aria-hidden="true" href="#cb6-5"></a>        <span class="cf">return</span> t[L].size+<span class="dv">1</span>;<span class="co">//è¿”å›å·¦å„¿å­çš„å¤§å°åŠ  1</span></span>
<span id="cb6-6"><a aria-hidden="true" href="#cb6-6"></a>    <span class="cf">if</span>(t[u].val&gt;val)<span class="co">//å¦‚æœå½“å‰èŠ‚ç‚¹å¤§äºå¾…æŸ¥æ‰¾</span></span>
<span id="cb6-7"><a aria-hidden="true" href="#cb6-7"></a>        <span class="cf">return</span> rank(L,val);<span class="co">//é€’å½’æŸ¥æ‰¾å·¦å„¿å­</span></span>
<span id="cb6-8"><a aria-hidden="true" href="#cb6-8"></a>    <span class="cf">else</span> <span class="cf">return</span> rank(R,val)+t[L].size+t[u].cnt;<span class="co">//è¿™é‡Œæ¯”è¾ƒå®¹æ˜“é”™ï¼Œå› ä¸ºéœ€è¦åŠ ä¸Šå·¦å„¿å­å’ŒèŠ‚ç‚¹æœ¬èº«äº§ç”Ÿçš„è´¡çŒ®</span></span>
<span id="cb6-9"><a aria-hidden="true" href="#cb6-9"></a>}</span></code></pre></div>
<p>æŸ¥è¯¢ç¬¬ <span class="math inline">\(k\)</span> å°/å¤§ã€‚è¿™é‡Œå®ç°æŸ¥è¯¢ç¬¬ <span class="math inline">\(k\)</span> å°ï¼Œç†è§£äº†æ’åæ“ä½œåŸºæœ¬å°±èƒ½å†™å‡ºæ¥äº†ã€‚å€¼å¾—æ³¨æ„çš„æ˜¯è¿™é‡Œæ—¢å¯ä»¥é€’å½’æ“ä½œï¼Œä¹Ÿå¯ä»¥ç›´æ¥è¿­ä»£å†™å‡ºæ¥ã€‚</p>
<p>é€’å½’ï¼š</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a aria-hidden="true" href="#cb7-1"></a><span class="dt">int</span> kth(<span class="dt">int</span> u, <span class="dt">int</span> k)</span>
<span id="cb7-2"><a aria-hidden="true" href="#cb7-2"></a>{</span>
<span id="cb7-3"><a aria-hidden="true" href="#cb7-3"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb7-4"><a aria-hidden="true" href="#cb7-4"></a>        <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb7-5"><a aria-hidden="true" href="#cb7-5"></a>    <span class="dt">int</span> lsize = L ? t[L].size : <span class="dv">0</span>;</span>
<span id="cb7-6"><a aria-hidden="true" href="#cb7-6"></a>    <span class="cf">if</span> (k &lt;= lsize)</span>
<span id="cb7-7"><a aria-hidden="true" href="#cb7-7"></a>        <span class="cf">return</span> kth(L, k);</span>
<span id="cb7-8"><a aria-hidden="true" href="#cb7-8"></a>    <span class="cf">else</span> <span class="cf">if</span>(k &lt;= lsize + t[u].cnt)</span>
<span id="cb7-9"><a aria-hidden="true" href="#cb7-9"></a>        <span class="cf">return</span> t[u].val;</span>
<span id="cb7-10"><a aria-hidden="true" href="#cb7-10"></a>    <span class="cf">else</span> <span class="cf">return</span> kth(R, k - t[u].cnt - lsize);<span class="co">//kè¦å‡å»è´¡çŒ®</span></span>
<span id="cb7-11"><a aria-hidden="true" href="#cb7-11"></a>}</span></code></pre></div>
<p>éé€’å½’ï¼š</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a aria-hidden="true" href="#cb8-1"></a><span class="dt">int</span> kth(<span class="dt">int</span> k)</span>
<span id="cb8-2"><a aria-hidden="true" href="#cb8-2"></a>{</span>
<span id="cb8-3"><a aria-hidden="true" href="#cb8-3"></a>    <span class="dt">int</span> u=root;<span class="co">//ä»æ ¹èŠ‚ç‚¹å¼€å§‹å‘ä¸‹æŸ¥æ‰¾</span></span>
<span id="cb8-4"><a aria-hidden="true" href="#cb8-4"></a>    <span class="cf">while</span> (<span class="kw">true</span>)</span>
<span id="cb8-5"><a aria-hidden="true" href="#cb8-5"></a>    {</span>
<span id="cb8-6"><a aria-hidden="true" href="#cb8-6"></a>        <span class="cf">if</span>(k&lt;=t[L].size)<span class="co">//å¦‚æœå¾…æŸ¥è¯¢çš„ k å°äºå·¦å­æ ‘å¤§å°</span></span>
<span id="cb8-7"><a aria-hidden="true" href="#cb8-7"></a>            u=L;<span class="co">//å¾€å·¦èµ°</span></span>
<span id="cb8-8"><a aria-hidden="true" href="#cb8-8"></a>        <span class="cf">else</span> <span class="cf">if</span>(k&gt;t[L].size+t[u].cnt)<span class="co">//å¦‚æœå¤§äºäº†å·¦è¾¹å’Œæœ¬èº«äº§ç”Ÿçš„è´¡çŒ®</span></span>
<span id="cb8-9"><a aria-hidden="true" href="#cb8-9"></a>            k-=t[L].size+t[u].cnt,u=R;<span class="co">//é¦–å…ˆ k è¦å‡å»è´¡çŒ®ï¼Œç„¶åå†å¾€å³èµ°</span></span>
<span id="cb8-10"><a aria-hidden="true" href="#cb8-10"></a>        <span class="cf">else</span> <span class="cf">return</span> t[u].val;<span class="co">//å¦åˆ™å°±æ˜¯æ‰¾åˆ°äº†ï¼Œç›´æ¥è¿”å›å³å¯</span></span>
<span id="cb8-11"><a aria-hidden="true" href="#cb8-11"></a>    }</span>
<span id="cb8-12"><a aria-hidden="true" href="#cb8-12"></a>}</span></code></pre></div>
<h3 id="å‰é©±åç»§å®Œæ•´ä»£ç ">å‰é©±åç»§/å®Œæ•´ä»£ç </h3>
<p>å‰é©±å’Œåç»§ã€‚å‰é©±çš„å®šä¹‰ä¸ºâ€œå°äº <span class="math inline">\(x\)</span> çš„æœ€å¤§çš„æ•°â€ã€‚ä¸ºäº†æ»¡è¶³â€œå°äº <span class="math inline">\(x\)</span>â€ï¼Œå¦‚æœå½“å‰èŠ‚ç‚¹å¤§äºç­‰äº <span class="math inline">\(x\)</span>ï¼Œåˆ™åœ¨å·¦å„¿å­é‡Œé¢æŸ¥æ‰¾ã€‚ä½†å¦‚æœå‘ç°äº†å°äº <span class="math inline">\(x\)</span> çš„æ•°ï¼Œä¸ºäº†æ»¡è¶³â€œæœ€å¤§çš„æ•°â€ï¼Œè¦åœ¨å…¶å³å­æ ‘é‡Œé¢ç»§ç»­æŸ¥æ‰¾ï¼Œç»“åˆä»£ç ä¼šæ›´å¥½ç†è§£ã€‚</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a aria-hidden="true" href="#cb9-1"></a><span class="dt">int</span> pre(<span class="dt">int</span> u,<span class="dt">int</span> val)</span>
<span id="cb9-2"><a aria-hidden="true" href="#cb9-2"></a>{</span>
<span id="cb9-3"><a aria-hidden="true" href="#cb9-3"></a>    <span class="cf">if</span>(!u)<span class="co">//æŸ¥åˆ°äº†ç©ºèŠ‚ç‚¹</span></span>
<span id="cb9-4"><a aria-hidden="true" href="#cb9-4"></a>        <span class="cf">return</span> -inf;<span class="co">//å°±è¿”å›ä¸€ä¸ªä¸ä¼šå¯¹ç­”æ¡ˆäº§ç”Ÿè´¡çŒ®çš„ -inf</span></span>
<span id="cb9-5"><a aria-hidden="true" href="#cb9-5"></a>    <span class="cf">if</span>(t[u].val&gt;=val)<span class="co">//å¦‚æœä¸æ»¡è¶³â€œå°äº valâ€œ çš„æ€§è´¨</span></span>
<span id="cb9-6"><a aria-hidden="true" href="#cb9-6"></a>        <span class="cf">return</span> pre(L,val);<span class="co">//å°±åœ¨å·¦å„¿å­é‡Œé¢æ‰¾</span></span>
<span id="cb9-7"><a aria-hidden="true" href="#cb9-7"></a>    <span class="cf">return</span> max(pre(R,val),t[u].val);<span class="co">//å–maxæ˜¯ä¸ºäº†å¤„ç†ä¸‡ä¸€å³å„¿å­ä¸å­˜åœ¨</span></span>
<span id="cb9-8"><a aria-hidden="true" href="#cb9-8"></a>}</span>
<span id="cb9-9"><a aria-hidden="true" href="#cb9-9"></a></span>
<span id="cb9-10"><a aria-hidden="true" href="#cb9-10"></a><span class="dt">int</span> nxt(<span class="dt">int</span> u,<span class="dt">int</span> val)<span class="co">//ä¸å‰é©±åŒç†</span></span>
<span id="cb9-11"><a aria-hidden="true" href="#cb9-11"></a>{</span>
<span id="cb9-12"><a aria-hidden="true" href="#cb9-12"></a>    <span class="cf">if</span>(!u)</span>
<span id="cb9-13"><a aria-hidden="true" href="#cb9-13"></a>        <span class="cf">return</span> inf;</span>
<span id="cb9-14"><a aria-hidden="true" href="#cb9-14"></a>    <span class="cf">if</span>(t[u].val&lt;=val)</span>
<span id="cb9-15"><a aria-hidden="true" href="#cb9-15"></a>        <span class="cf">return</span> nxt(R,val);</span>
<span id="cb9-16"><a aria-hidden="true" href="#cb9-16"></a>    <span class="cf">return</span> min(nxt(L,val),t[u].val);</span>
<span id="cb9-17"><a aria-hidden="true" href="#cb9-17"></a>}</span></code></pre></div>
<p>æ‰€ä»¥ <a href="https://www.luogu.com.cn/problem/P6136" title="æ´›è°· P6136">æ´›è°· P6136</a> çš„ä»£ç å¦‚ä¸‹ï¼ˆçœç•¥äº†ä¸€äº›ä¸å…³é”®çš„å®šä¹‰ï¼‰ï¼š<strong>ï¼ˆå»ºè®®ä¸è¦æäº¤ P3369ï¼Œæœ‰å¾ˆå¤šé—®é¢˜æ²¡æœ‰è€ƒè™‘åˆ°çš„ Treap æ˜¯å¯ä»¥é€šè¿‡é‚£é“é¢˜çš„ï¼Œå»ºè®®äº¤åŠ å¼ºç‰ˆï¼‰</strong></p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a aria-hidden="true" href="#cb10-1"></a><span class="pp">#include </span><span class="im">&lt;cstdio&gt;</span></span>
<span id="cb10-2"><a aria-hidden="true" href="#cb10-2"></a><span class="pp">#include </span><span class="im">&lt;cctype&gt;</span></span>
<span id="cb10-3"><a aria-hidden="true" href="#cb10-3"></a><span class="pp">#include </span><span class="im">&lt;climits&gt;</span></span>
<span id="cb10-4"><a aria-hidden="true" href="#cb10-4"></a><span class="pp">#include </span><span class="im">&lt;cstdlib&gt;</span></span>
<span id="cb10-5"><a aria-hidden="true" href="#cb10-5"></a><span class="pp">#define L </span>t[u].ch[<span class="dv">0</span>]</span>
<span id="cb10-6"><a aria-hidden="true" href="#cb10-6"></a><span class="pp">#define R </span>t[u].ch[<span class="dv">1</span>]</span>
<span id="cb10-7"><a aria-hidden="true" href="#cb10-7"></a></span>
<span id="cb10-8"><a aria-hidden="true" href="#cb10-8"></a><span class="kw">inline</span> <span class="dt">int</span> read()</span>
<span id="cb10-9"><a aria-hidden="true" href="#cb10-9"></a>{</span>
<span id="cb10-10"><a aria-hidden="true" href="#cb10-10"></a>    <span class="dt">char</span> c = getchar();</span>
<span id="cb10-11"><a aria-hidden="true" href="#cb10-11"></a>    <span class="dt">int</span> s = <span class="dv">0</span>;</span>
<span id="cb10-12"><a aria-hidden="true" href="#cb10-12"></a>    <span class="dt">bool</span> x = <span class="dv">0</span>;</span>
<span id="cb10-13"><a aria-hidden="true" href="#cb10-13"></a>    <span class="cf">while</span> (!isdigit(c))</span>
<span id="cb10-14"><a aria-hidden="true" href="#cb10-14"></a>        x = x | (c == <span class="ch">'-'</span>), c = getchar();</span>
<span id="cb10-15"><a aria-hidden="true" href="#cb10-15"></a>    <span class="cf">while</span> (isdigit(c))</span>
<span id="cb10-16"><a aria-hidden="true" href="#cb10-16"></a>        s = <span class="dv">10</span> * s + c - <span class="ch">'0'</span>, c = getchar();</span>
<span id="cb10-17"><a aria-hidden="true" href="#cb10-17"></a>    <span class="cf">return</span> x?-s:s;</span>
<span id="cb10-18"><a aria-hidden="true" href="#cb10-18"></a>}</span>
<span id="cb10-19"><a aria-hidden="true" href="#cb10-19"></a></span>
<span id="cb10-20"><a aria-hidden="true" href="#cb10-20"></a><span class="kw">inline</span> <span class="dt">int</span> max(<span class="dt">int</span> a,<span class="dt">int</span> b){<span class="cf">return</span> a &gt; b? a : b;}</span>
<span id="cb10-21"><a aria-hidden="true" href="#cb10-21"></a><span class="kw">inline</span> <span class="dt">int</span> min(<span class="dt">int</span> a,<span class="dt">int</span> b){<span class="cf">return</span> a &lt; b? a : b;}</span>
<span id="cb10-22"><a aria-hidden="true" href="#cb10-22"></a></span>
<span id="cb10-23"><a aria-hidden="true" href="#cb10-23"></a><span class="at">const</span> <span class="dt">int</span> maxn = <span class="fl">2e6</span>+<span class="dv">5</span>, inf = INT_MAX-<span class="dv">20</span>;</span>
<span id="cb10-24"><a aria-hidden="true" href="#cb10-24"></a><span class="dt">int</span> cnt, root, lastans = <span class="dv">0</span>, ans = <span class="dv">0</span>;</span>
<span id="cb10-25"><a aria-hidden="true" href="#cb10-25"></a></span>
<span id="cb10-26"><a aria-hidden="true" href="#cb10-26"></a><span class="kw">struct</span> treap</span>
<span id="cb10-27"><a aria-hidden="true" href="#cb10-27"></a>{</span>
<span id="cb10-28"><a aria-hidden="true" href="#cb10-28"></a>    <span class="dt">int</span> ch[<span class="dv">2</span>];</span>
<span id="cb10-29"><a aria-hidden="true" href="#cb10-29"></a>    <span class="dt">int</span> val, p;</span>
<span id="cb10-30"><a aria-hidden="true" href="#cb10-30"></a>    <span class="dt">int</span> size, cnt;</span>
<span id="cb10-31"><a aria-hidden="true" href="#cb10-31"></a>} t[maxn];</span>
<span id="cb10-32"><a aria-hidden="true" href="#cb10-32"></a></span>
<span id="cb10-33"><a aria-hidden="true" href="#cb10-33"></a><span class="kw">inline</span> <span class="dt">void</span> maintain(<span class="dt">int</span> u)</span>
<span id="cb10-34"><a aria-hidden="true" href="#cb10-34"></a>{</span>
<span id="cb10-35"><a aria-hidden="true" href="#cb10-35"></a>    t[u].size = t[u].cnt + t[L].size + t[R].size;</span>
<span id="cb10-36"><a aria-hidden="true" href="#cb10-36"></a>    <span class="cf">return</span>;</span>
<span id="cb10-37"><a aria-hidden="true" href="#cb10-37"></a>}</span>
<span id="cb10-38"><a aria-hidden="true" href="#cb10-38"></a></span>
<span id="cb10-39"><a aria-hidden="true" href="#cb10-39"></a><span class="kw">inline</span> <span class="dt">void</span> rotate(<span class="dt">int</span> &amp;u, <span class="dt">int</span> d)</span>
<span id="cb10-40"><a aria-hidden="true" href="#cb10-40"></a>{</span>
<span id="cb10-41"><a aria-hidden="true" href="#cb10-41"></a>    <span class="dt">int</span> k = t[u].ch[d];</span>
<span id="cb10-42"><a aria-hidden="true" href="#cb10-42"></a>    t[u].ch[d] = t[k].ch[d ^ <span class="dv">1</span>];</span>
<span id="cb10-43"><a aria-hidden="true" href="#cb10-43"></a>    t[k].ch[d^<span class="dv">1</span>] = u;</span>
<span id="cb10-44"><a aria-hidden="true" href="#cb10-44"></a>    maintain(u);</span>
<span id="cb10-45"><a aria-hidden="true" href="#cb10-45"></a>    maintain(u = k);</span>
<span id="cb10-46"><a aria-hidden="true" href="#cb10-46"></a>    <span class="cf">return</span>;</span>
<span id="cb10-47"><a aria-hidden="true" href="#cb10-47"></a>}</span>
<span id="cb10-48"><a aria-hidden="true" href="#cb10-48"></a></span>
<span id="cb10-49"><a aria-hidden="true" href="#cb10-49"></a><span class="dt">void</span> insert(<span class="dt">int</span> &amp;u, <span class="dt">int</span> val)</span>
<span id="cb10-50"><a aria-hidden="true" href="#cb10-50"></a>{</span>
<span id="cb10-51"><a aria-hidden="true" href="#cb10-51"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb10-52"><a aria-hidden="true" href="#cb10-52"></a>    {</span>
<span id="cb10-53"><a aria-hidden="true" href="#cb10-53"></a>        u = ++cnt;</span>
<span id="cb10-54"><a aria-hidden="true" href="#cb10-54"></a>        t[u].size = t[u].cnt = <span class="dv">1</span>;</span>
<span id="cb10-55"><a aria-hidden="true" href="#cb10-55"></a>        t[u].val = val;</span>
<span id="cb10-56"><a aria-hidden="true" href="#cb10-56"></a>        t[u].p = rand();</span>
<span id="cb10-57"><a aria-hidden="true" href="#cb10-57"></a>        <span class="cf">return</span>;</span>
<span id="cb10-58"><a aria-hidden="true" href="#cb10-58"></a>    }</span>
<span id="cb10-59"><a aria-hidden="true" href="#cb10-59"></a>    t[u].size++;</span>
<span id="cb10-60"><a aria-hidden="true" href="#cb10-60"></a>    <span class="cf">if</span> (t[u].val == val)</span>
<span id="cb10-61"><a aria-hidden="true" href="#cb10-61"></a>    {</span>
<span id="cb10-62"><a aria-hidden="true" href="#cb10-62"></a>        t[u].cnt++;</span>
<span id="cb10-63"><a aria-hidden="true" href="#cb10-63"></a>        <span class="cf">return</span>;</span>
<span id="cb10-64"><a aria-hidden="true" href="#cb10-64"></a>    }</span>
<span id="cb10-65"><a aria-hidden="true" href="#cb10-65"></a>    <span class="dt">int</span> d = val &gt; t[u].val;</span>
<span id="cb10-66"><a aria-hidden="true" href="#cb10-66"></a>    insert(t[u].ch[d], val);</span>
<span id="cb10-67"><a aria-hidden="true" href="#cb10-67"></a>    <span class="cf">if</span> (t[t[u].ch[d]].p &lt; t[u].p)</span>
<span id="cb10-68"><a aria-hidden="true" href="#cb10-68"></a>        rotate(u, d);</span>
<span id="cb10-69"><a aria-hidden="true" href="#cb10-69"></a>    <span class="cf">return</span>;</span>
<span id="cb10-70"><a aria-hidden="true" href="#cb10-70"></a>}</span>
<span id="cb10-71"><a aria-hidden="true" href="#cb10-71"></a></span>
<span id="cb10-72"><a aria-hidden="true" href="#cb10-72"></a><span class="dt">void</span> delnode(<span class="dt">int</span> &amp;u,<span class="dt">int</span> val)</span>
<span id="cb10-73"><a aria-hidden="true" href="#cb10-73"></a>{</span>
<span id="cb10-74"><a aria-hidden="true" href="#cb10-74"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb10-75"><a aria-hidden="true" href="#cb10-75"></a>        <span class="cf">return</span>;</span>
<span id="cb10-76"><a aria-hidden="true" href="#cb10-76"></a>    <span class="cf">if</span> (t[u].val == val)</span>
<span id="cb10-77"><a aria-hidden="true" href="#cb10-77"></a>    {</span>
<span id="cb10-78"><a aria-hidden="true" href="#cb10-78"></a>        <span class="cf">if</span> (t[u].cnt &gt; <span class="dv">1</span>)</span>
<span id="cb10-79"><a aria-hidden="true" href="#cb10-79"></a>        {</span>
<span id="cb10-80"><a aria-hidden="true" href="#cb10-80"></a>            t[u].cnt--;</span>
<span id="cb10-81"><a aria-hidden="true" href="#cb10-81"></a>            t[u].size--;</span>
<span id="cb10-82"><a aria-hidden="true" href="#cb10-82"></a>            <span class="cf">return</span>;</span>
<span id="cb10-83"><a aria-hidden="true" href="#cb10-83"></a>        }</span>
<span id="cb10-84"><a aria-hidden="true" href="#cb10-84"></a>        <span class="cf">if</span> ((!L) || (!R))</span>
<span id="cb10-85"><a aria-hidden="true" href="#cb10-85"></a>            u = L + R;</span>
<span id="cb10-86"><a aria-hidden="true" href="#cb10-86"></a>        <span class="cf">else</span></span>
<span id="cb10-87"><a aria-hidden="true" href="#cb10-87"></a>        {</span>
<span id="cb10-88"><a aria-hidden="true" href="#cb10-88"></a>            <span class="dt">int</span> d = t[L].p &gt; t[R].p;</span>
<span id="cb10-89"><a aria-hidden="true" href="#cb10-89"></a>            rotate(u, d);</span>
<span id="cb10-90"><a aria-hidden="true" href="#cb10-90"></a>            delnode(u, val);</span>
<span id="cb10-91"><a aria-hidden="true" href="#cb10-91"></a>        }</span>
<span id="cb10-92"><a aria-hidden="true" href="#cb10-92"></a>    }</span>
<span id="cb10-93"><a aria-hidden="true" href="#cb10-93"></a>    <span class="cf">else</span></span>
<span id="cb10-94"><a aria-hidden="true" href="#cb10-94"></a>        t[u].size--, delnode(t[u].ch[val &gt; t[u].val], val);</span>
<span id="cb10-95"><a aria-hidden="true" href="#cb10-95"></a>    <span class="cf">return</span>;</span>
<span id="cb10-96"><a aria-hidden="true" href="#cb10-96"></a>}</span>
<span id="cb10-97"><a aria-hidden="true" href="#cb10-97"></a></span>
<span id="cb10-98"><a aria-hidden="true" href="#cb10-98"></a><span class="dt">int</span> rank(<span class="dt">int</span> u,<span class="dt">int</span> val)</span>
<span id="cb10-99"><a aria-hidden="true" href="#cb10-99"></a>{</span>
<span id="cb10-100"><a aria-hidden="true" href="#cb10-100"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb10-101"><a aria-hidden="true" href="#cb10-101"></a>        <span class="cf">return</span> <span class="dv">1</span>;</span>
<span id="cb10-102"><a aria-hidden="true" href="#cb10-102"></a>    <span class="cf">if</span> (val == t[u].val)</span>
<span id="cb10-103"><a aria-hidden="true" href="#cb10-103"></a>        <span class="cf">return</span> t[L].size + <span class="dv">1</span>;</span>
<span id="cb10-104"><a aria-hidden="true" href="#cb10-104"></a>    <span class="cf">if</span> (val &lt; t[u].val)</span>
<span id="cb10-105"><a aria-hidden="true" href="#cb10-105"></a>        <span class="cf">return</span> rank(L, val);</span>
<span id="cb10-106"><a aria-hidden="true" href="#cb10-106"></a>    <span class="cf">else</span> <span class="cf">return</span> rank(R, val) + t[L].size + t[u].cnt;</span>
<span id="cb10-107"><a aria-hidden="true" href="#cb10-107"></a>}</span>
<span id="cb10-108"><a aria-hidden="true" href="#cb10-108"></a></span>
<span id="cb10-109"><a aria-hidden="true" href="#cb10-109"></a><span class="dt">int</span> kth(<span class="dt">int</span> u, <span class="dt">int</span> k)</span>
<span id="cb10-110"><a aria-hidden="true" href="#cb10-110"></a>{</span>
<span id="cb10-111"><a aria-hidden="true" href="#cb10-111"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb10-112"><a aria-hidden="true" href="#cb10-112"></a>        <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb10-113"><a aria-hidden="true" href="#cb10-113"></a>    <span class="dt">int</span> lsize = L ? t[L].size : <span class="dv">0</span>;</span>
<span id="cb10-114"><a aria-hidden="true" href="#cb10-114"></a>    <span class="cf">if</span> (k &lt;= lsize)</span>
<span id="cb10-115"><a aria-hidden="true" href="#cb10-115"></a>        <span class="cf">return</span> kth(L, k);</span>
<span id="cb10-116"><a aria-hidden="true" href="#cb10-116"></a>    <span class="cf">else</span> <span class="cf">if</span>(k &lt;= lsize + t[u].cnt)</span>
<span id="cb10-117"><a aria-hidden="true" href="#cb10-117"></a>        <span class="cf">return</span> t[u].val;</span>
<span id="cb10-118"><a aria-hidden="true" href="#cb10-118"></a>    <span class="cf">else</span> <span class="cf">return</span> kth(R, k - t[u].cnt - lsize);</span>
<span id="cb10-119"><a aria-hidden="true" href="#cb10-119"></a>}</span>
<span id="cb10-120"><a aria-hidden="true" href="#cb10-120"></a></span>
<span id="cb10-121"><a aria-hidden="true" href="#cb10-121"></a><span class="dt">int</span> pre(<span class="dt">int</span> u, <span class="dt">int</span> val)</span>
<span id="cb10-122"><a aria-hidden="true" href="#cb10-122"></a>{</span>
<span id="cb10-123"><a aria-hidden="true" href="#cb10-123"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb10-124"><a aria-hidden="true" href="#cb10-124"></a>        <span class="cf">return</span> -inf;</span>
<span id="cb10-125"><a aria-hidden="true" href="#cb10-125"></a>    <span class="cf">if</span> (t[u].val &gt;= val)</span>
<span id="cb10-126"><a aria-hidden="true" href="#cb10-126"></a>        <span class="cf">return</span> pre(L, val);</span>
<span id="cb10-127"><a aria-hidden="true" href="#cb10-127"></a>    <span class="cf">else</span> <span class="cf">return</span> max(t[u].val, pre(R, val));</span>
<span id="cb10-128"><a aria-hidden="true" href="#cb10-128"></a>}</span>
<span id="cb10-129"><a aria-hidden="true" href="#cb10-129"></a></span>
<span id="cb10-130"><a aria-hidden="true" href="#cb10-130"></a><span class="dt">int</span> suc(<span class="dt">int</span> u, <span class="dt">int</span> val)</span>
<span id="cb10-131"><a aria-hidden="true" href="#cb10-131"></a>{</span>
<span id="cb10-132"><a aria-hidden="true" href="#cb10-132"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb10-133"><a aria-hidden="true" href="#cb10-133"></a>        <span class="cf">return</span> inf;</span>
<span id="cb10-134"><a aria-hidden="true" href="#cb10-134"></a>    <span class="cf">if</span> (t[u].val &lt;= val)</span>
<span id="cb10-135"><a aria-hidden="true" href="#cb10-135"></a>        <span class="cf">return</span> suc(R, val);</span>
<span id="cb10-136"><a aria-hidden="true" href="#cb10-136"></a>    <span class="cf">else</span> <span class="cf">return</span> min(t[u].val, suc(L, val));</span>
<span id="cb10-137"><a aria-hidden="true" href="#cb10-137"></a>}</span>
<span id="cb10-138"><a aria-hidden="true" href="#cb10-138"></a></span>
<span id="cb10-139"><a aria-hidden="true" href="#cb10-139"></a><span class="dt">int</span> main()</span>
<span id="cb10-140"><a aria-hidden="true" href="#cb10-140"></a>{</span>
<span id="cb10-141"><a aria-hidden="true" href="#cb10-141"></a>    <span class="dt">int</span> n = read(), m = read();</span>
<span id="cb10-142"><a aria-hidden="true" href="#cb10-142"></a>    srand(<span class="dv">20041031</span>);</span>
<span id="cb10-143"><a aria-hidden="true" href="#cb10-143"></a>    <span class="cf">while</span> (n--)</span>
<span id="cb10-144"><a aria-hidden="true" href="#cb10-144"></a>        insert(root, read());</span>
<span id="cb10-145"><a aria-hidden="true" href="#cb10-145"></a>    <span class="cf">while</span> (m--)</span>
<span id="cb10-146"><a aria-hidden="true" href="#cb10-146"></a>    {</span>
<span id="cb10-147"><a aria-hidden="true" href="#cb10-147"></a>        <span class="dt">int</span> opt = read(), x = read() ^ lastans;</span>
<span id="cb10-148"><a aria-hidden="true" href="#cb10-148"></a>        <span class="cf">switch</span> (opt)</span>
<span id="cb10-149"><a aria-hidden="true" href="#cb10-149"></a>        {</span>
<span id="cb10-150"><a aria-hidden="true" href="#cb10-150"></a>        <span class="cf">case</span> <span class="dv">1</span>:</span>
<span id="cb10-151"><a aria-hidden="true" href="#cb10-151"></a>            insert(root, x);</span>
<span id="cb10-152"><a aria-hidden="true" href="#cb10-152"></a>            <span class="cf">break</span>;</span>
<span id="cb10-153"><a aria-hidden="true" href="#cb10-153"></a>        <span class="cf">case</span> <span class="dv">2</span>:</span>
<span id="cb10-154"><a aria-hidden="true" href="#cb10-154"></a>            delnode(root, x);</span>
<span id="cb10-155"><a aria-hidden="true" href="#cb10-155"></a>            <span class="cf">break</span>;</span>
<span id="cb10-156"><a aria-hidden="true" href="#cb10-156"></a>        <span class="cf">case</span> <span class="dv">3</span>:</span>
<span id="cb10-157"><a aria-hidden="true" href="#cb10-157"></a>            ans ^= (lastans = rank(root, x));</span>
<span id="cb10-158"><a aria-hidden="true" href="#cb10-158"></a>            <span class="cf">break</span>;</span>
<span id="cb10-159"><a aria-hidden="true" href="#cb10-159"></a>        <span class="cf">case</span> <span class="dv">4</span>:</span>
<span id="cb10-160"><a aria-hidden="true" href="#cb10-160"></a>            ans ^= (lastans = kth(root, x));</span>
<span id="cb10-161"><a aria-hidden="true" href="#cb10-161"></a>            <span class="cf">break</span>;</span>
<span id="cb10-162"><a aria-hidden="true" href="#cb10-162"></a>        <span class="cf">case</span> <span class="dv">5</span>:</span>
<span id="cb10-163"><a aria-hidden="true" href="#cb10-163"></a>            ans ^= (lastans = pre(root, x));</span>
<span id="cb10-164"><a aria-hidden="true" href="#cb10-164"></a>            <span class="cf">break</span>;</span>
<span id="cb10-165"><a aria-hidden="true" href="#cb10-165"></a>        <span class="cf">case</span> <span class="dv">6</span>:</span>
<span id="cb10-166"><a aria-hidden="true" href="#cb10-166"></a>            ans ^= (lastans = suc(root, x));</span>
<span id="cb10-167"><a aria-hidden="true" href="#cb10-167"></a>            <span class="cf">break</span>;</span>
<span id="cb10-168"><a aria-hidden="true" href="#cb10-168"></a>        }</span>
<span id="cb10-169"><a aria-hidden="true" href="#cb10-169"></a>    }</span>
<span id="cb10-170"><a aria-hidden="true" href="#cb10-170"></a>    printf(<span class="st">"</span><span class="sc">%d\n</span><span class="st">"</span>, ans);</span>
<span id="cb10-171"><a aria-hidden="true" href="#cb10-171"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb10-172"><a aria-hidden="true" href="#cb10-172"></a>}</span></code></pre></div>
<h2 id="fhq-treapæ— æ—‹-treap">FHQ-Treapï¼ˆæ— æ—‹ Treapï¼‰</h2>
<p>ç”±èŒƒæµ©å¼ºå¤§ä½¬å‘æ˜çš„ç¥çº§æ•°æ®ç»“æ„ï¼Œç›¸æ¯”äº Treap ä¸ç”¨æ—‹è½¬ï¼Œä¸”å¢æ·»äº†ä¸¤ä¸ªæ ¸å¿ƒæ“ä½œï¼šåˆ†è£‚ï¼ˆsplitï¼‰ä¸åˆå¹¶ï¼ˆmergeï¼‰ï¼Œè¿™ä¸¤ä¸ªæ“ä½œæ˜¯æ— æ—‹ Treap çš„æ ¸å¿ƒæ“ä½œï¼Œå…¶ä½™çš„æ‰€æœ‰æ“ä½œéƒ½æ˜¯åŸºäº split å’Œ merge çš„ã€‚</p>
<p><strong>ä¸¤ä¸ªå€¼ç›¸åŒçš„å…ƒç´ æ˜¯åˆ†åˆ«å‚¨å­˜åœ¨ä¸¤ä¸ªä¸åŒçš„èŠ‚ç‚¹é‡Œé¢çš„ï¼Œä¸åƒ Treap çš„ <code>cnt</code> åŸŸ</strong>ã€‚</p>
<h3 id="åˆ†è£‚">åˆ†è£‚</h3>
<p>è¯¥æ“ä½œæŠŠä¸€æ£µ Treap åˆ†è£‚æˆä¸¤æ£µï¼Œæœ‰ä¸¤ç§åˆ†è£‚æ–¹æ³•ï¼šæŒ‰å€¼åˆ†è£‚ä»¥åŠæŒ‰å¤§å°åˆ†è£‚ã€‚è¿™é‡Œå…ˆè€ƒè™‘æŒ‰å€¼åˆ†è£‚ã€‚</p>
<p>è¯¥ç§åˆ†è£‚æ–¹å¼æŒ‰ç…§ä¸€ä¸ªé˜ˆå€¼ <span class="math inline">\(k\)</span> æŠŠä¸€æ£µ Treap åˆ†è£‚æˆä¸¤æ£µï¼Œæ»¡è¶³å·¦æ ‘çš„æ‰€æœ‰å…ƒç´ å€¼å‡<strong>å°äºç­‰äº</strong> <span class="math inline">\(k\)</span>ï¼Œå³æ ‘çš„æ‰€æœ‰å…ƒç´ å€¼å‡<strong>å¤§äº</strong> <span class="math inline">\(k\)</span>ã€‚ç”±äº Treap æ»¡è¶³å †çš„æ€§è´¨ï¼Œæ‰€ä»¥ç›´æ¥åˆ†è£‚å³å¯ï¼Œä¸éœ€è¦ç‰¹æ®Šç»´æŠ¤ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ <code>split()</code> å‡½æ•°ä½¿ç”¨é€’å½’å®ç°ï¼š<code>void split(int u, int k, int &amp;x, int &amp;y)</code>ï¼Œå…¶ä¸­ <span class="math inline">\(u\)</span> è¡¨ç¤ºå½“å‰èŠ‚ç‚¹ï¼Œ<span class="math inline">\(k\)</span> ä¸å†èµ˜è¿°ï¼Œä¸¤ä¸ªå¼•ç”¨ <span class="math inline">\(x\)</span> å’Œ <span class="math inline">\(y\)</span> æ˜¯æ”¾è¿”å›å€¼ï¼ˆå³åˆ†è£‚å‡ºæ¥çš„å·¦æ ‘çš„æ ¹å’Œå³æ ‘çš„æ ¹ï¼‰çš„ã€‚</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a aria-hidden="true" href="#cb11-1"></a><span class="dt">void</span> split(<span class="dt">int</span> u, <span class="dt">int</span> k, <span class="dt">int</span>&amp; x, <span class="dt">int</span>&amp; y) {</span>
<span id="cb11-2"><a aria-hidden="true" href="#cb11-2"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb11-3"><a aria-hidden="true" href="#cb11-3"></a>        x = y = <span class="dv">0</span>;</span>
<span id="cb11-4"><a aria-hidden="true" href="#cb11-4"></a>    <span class="cf">else</span> {</span>
<span id="cb11-5"><a aria-hidden="true" href="#cb11-5"></a>        <span class="cf">if</span> (t[u].val &lt;= k) {</span>
<span id="cb11-6"><a aria-hidden="true" href="#cb11-6"></a>            x = u;</span>
<span id="cb11-7"><a aria-hidden="true" href="#cb11-7"></a>            split(R, k, R, y);</span>
<span id="cb11-8"><a aria-hidden="true" href="#cb11-8"></a>        }</span>
<span id="cb11-9"><a aria-hidden="true" href="#cb11-9"></a>        <span class="cf">else</span> {</span>
<span id="cb11-10"><a aria-hidden="true" href="#cb11-10"></a>            y = u;</span>
<span id="cb11-11"><a aria-hidden="true" href="#cb11-11"></a>            split(L, k, x, L);</span>
<span id="cb11-12"><a aria-hidden="true" href="#cb11-12"></a>        }</span>
<span id="cb11-13"><a aria-hidden="true" href="#cb11-13"></a>        maintain(u);</span>
<span id="cb11-14"><a aria-hidden="true" href="#cb11-14"></a>    }</span>
<span id="cb11-15"><a aria-hidden="true" href="#cb11-15"></a>    <span class="cf">return</span>;</span>
<span id="cb11-16"><a aria-hidden="true" href="#cb11-16"></a>}</span></code></pre></div>
<p>æ¥ä¸‹æ¥è§£é‡Šä¸€ä¸‹ä¸Šé¢çš„ä»£ç ï¼š</p>
<p>é¦–å…ˆå¦‚æœè¿™ä¸ªèŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œå°±ä¸èƒ½å†ç»§ç»­äº†ï¼Œç›´æ¥ <code>x = y = 0;</code> å³å¯ã€‚</p>
<p>ç„¶åå¦‚æœè¿™ä¸ªèŠ‚ç‚¹çš„å€¼å°äºç­‰äº <span class="math inline">\(k\)</span>ï¼Œåˆ™è¿™ä¸ªèŠ‚ç‚¹è‚¯å®šæ˜¯åˆ’åˆ°å·¦æ ‘é‡Œé¢å»äº†ï¼Œæ‰€ä»¥æœ‰ <code>x = u;</code>ï¼Œç„¶åå¯¹äºè¿™ä¸ªèŠ‚ç‚¹çš„å·¦å­æ ‘ï¼Œè‚¯å®šæ˜¯è¢«åˆ’åˆ°å·¦å­æ ‘é‡Œé¢å»çš„ï¼Œæ‰€ä»¥ç»§ç»­åˆ†è£‚å³å­æ ‘ï¼Œå³ <code>split(R, k, R, y);</code>ã€‚å¦‚æœæ— æ³•ç†è§£ï¼Œä¸‹é¢æ¥çœ‹çœ‹å…·ä½“æ­¥éª¤ï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/fhq_split1.png"/><figcaption>åˆå§‹çš„æ ‘</figcaption>
</figure>
<p>è¿™æ˜¯ä¸€æ£µåˆ†è£‚å‰çš„ FHQ-Treapï¼ˆçœç•¥äº†èŠ‚ç‚¹ç¼–å·å’Œéšæœºæƒå€¼ï¼Œåªä¿ç•™äº†å€¼ï¼‰ï¼Œè®©æˆ‘ä»¬ä»¥é˜ˆå€¼ <span class="math inline">\(7\)</span> å°†å…¶åˆ†è£‚ã€‚ä¸€å¼€å§‹ <code>split(root, 7, x, y)</code></p>
<p>é¦–å…ˆæˆ‘ä»¬æ‰¾åˆ°æ ‘æ ¹ <span class="math inline">\(6\)</span>ï¼Œ<span class="math inline">\(6 \le 7\)</span>ï¼Œæ‰€ä»¥åˆ’åˆ°å·¦æ ‘é‡Œé¢ï¼ŒåŒæ—¶å®ƒçš„å·¦å­æ ‘ä¹Ÿéƒ½å±äºå·¦æ ‘ã€‚ï¼ˆå±äºå·¦æ ‘çš„èŠ‚ç‚¹æ ‡çº¢ï¼‰</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/fhq_split2.png"/><figcaption>step 1</figcaption>
</figure>
<p>æ¥ä¸‹æ¥ <code>split(R, k, R, y)</code> å³ <code>split(10çš„ç¼–å·, 7, t[6].ch[1], y)</code> ç°åœ¨æ¥åˆ°èŠ‚ç‚¹ <span class="math inline">\(10\)</span>ï¼Œæ³¨æ„åˆ° <span class="math inline">\(10 &gt; 6\)</span>ï¼Œæ‰€ä»¥ <span class="math inline">\(10\)</span> åˆ’ç»™å³æ ‘ï¼Œ<span class="math inline">\(10\)</span> çš„æ‰€æœ‰å³èŠ‚ç‚¹ä¹Ÿéƒ½åˆ’ç»™å³æ ‘ï¼šæ­¤æ—¶ <span class="math inline">\(y\)</span> å°±è¢«èµ‹ä¸º <span class="math inline">\(10\)</span> çš„ç¼–å·ã€‚</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/fhq_split3.png"/><figcaption>step 2</figcaption>
</figure>
<p>ç„¶å <code>split(L, kï¼Œx, L)</code> å³ <code>split(8çš„ç¼–å·, 7, t[6].ch[1], t[10].ch[0])</code>ï¼Œ<span class="math inline">\(8 &gt; 7\)</span></p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/fhq_split4.png"/><figcaption>step 3</figcaption>
</figure>
<p>æ¥ä¸‹æ¥ <code>split(L, k, x, L)</code> å³ <code>split(7çš„ç¼–å·, 7, t[6].ch[1], t[8].ch[0])</code>ï¼Œå‘ç° <span class="math inline">\(7 \le 7\)</span>ï¼Œæ‰€ä»¥åˆ’åˆ°å·¦å­æ ‘ï¼Œå¹¶ä¸” <span class="math inline">\(x=u\)</span>ï¼Œå³æŠŠ <code>t[6].ch[1]</code> èµ‹ä¸º 7ï¼Œ</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/fhq_split5.png"/><figcaption>step 4</figcaption>
</figure>
<p>ç„¶å <code>split(R, k, R, y)</code> å³ <code>split(0, 7, t[7].ch[1], t[8].ch[0])</code>ï¼Œå‘ç°èŠ‚ç‚¹ä¸å­˜åœ¨ï¼Œå°† <span class="math inline">\(x\)</span> å’Œ <span class="math inline">\(y\)</span> éƒ½èµ‹ä¸º <span class="math inline">\(0\)</span>ï¼Œè¿”å›å³å¯ã€‚è¿™æ ·å°±å®Œæˆäº†åˆ†è£‚ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹ï¼š</p>
<ul>
<li>é‡åˆ°æ¯”å°äºç­‰äºé˜ˆå€¼çš„èŠ‚ç‚¹ï¼Œç”±äºå…¶å·¦å­æ ‘ä¸€å®šåˆ’ä¸ºå·¦æ ‘ï¼Œæ‰€ä»¥è¦ç»§ç»­åˆ†è£‚å³å­æ ‘ï¼Œä¼ ä¸‹å»å·¦æ ‘çš„æ ¹æ˜¯å½“å‰èŠ‚ç‚¹çš„å³å„¿å­ï¼Œåœ¨æ›´æ·±çš„é€’å½’å±‚ä¼šæ›´æ–°ã€‚</li>
<li>é‡åˆ°å¤§äºé˜ˆå€¼çš„èŠ‚ç‚¹ï¼ŒåŒç†ï¼Œåˆ†è£‚å·¦å­æ ‘ï¼Œä¼ ä¸‹å»å³æ ‘çš„æ ¹æ˜¯å½“å‰èŠ‚ç‚¹çš„å·¦å„¿å­ï¼Œåœ¨æ›´æ·±çš„é€’å½’å±‚ä¼šæ›´æ–°</li>
</ul>
<p>è¿™ä¸ªé€’å½’å¯èƒ½ä¸€å¼€å§‹ä¸å¤ªå¥½ç†è§£ï¼Œä½†æ˜¯ç†è§£äº†ä¼šå‘ç°å…¶å®æŒºç®€å•çš„ã€‚</p>
<h3 id="åˆå¹¶">åˆå¹¶</h3>
<p>åˆå¹¶çš„æ—¶å€™æ˜¯æŠŠä¸¤æ£µ FHQ-Treap <span class="math inline">\(x\)</span> å’Œ <span class="math inline">\(y\)</span> åˆå¹¶æˆä¸€æ£µï¼Œå¿…é¡»æ»¡è¶³ï¼š<span class="math inline">\(x\)</span> ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„å€¼å°äºç­‰äº <span class="math inline">\(y\)</span> ä¸­æ‰€æœ‰èŠ‚ç‚¹çš„å€¼ï¼Œç„¶ååˆå¹¶çš„ç»“æœä¹Ÿè¦æ»¡è¶³ Treap çš„æ€§è´¨ï¼ˆå³å †çš„æ€§è´¨ï¼‰ã€‚</p>
<p>åˆå¹¶å‡½æ•° <code>int merge(int x, int y)</code> è¿”å›åˆå¹¶åçš„æ ‘æ ¹ï¼Œ<span class="math inline">\(x,y\)</span> åˆ†åˆ«ä¸ºä¸¤æ£µå¾…åˆå¹¶æ ‘çš„æ ¹ã€‚ç”±äºè¦ç»´æŠ¤å †çš„æ€§è´¨ï¼Œå®ç°å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a aria-hidden="true" href="#cb12-1"></a><span class="dt">int</span> merge(<span class="dt">int</span> x, <span class="dt">int</span> y) {</span>
<span id="cb12-2"><a aria-hidden="true" href="#cb12-2"></a>    <span class="cf">if</span> (!x || !y)</span>
<span id="cb12-3"><a aria-hidden="true" href="#cb12-3"></a>        <span class="cf">return</span> x + y;</span>
<span id="cb12-4"><a aria-hidden="true" href="#cb12-4"></a>    <span class="cf">if</span> (t[x].key &lt; t[y].key) {</span>
<span id="cb12-5"><a aria-hidden="true" href="#cb12-5"></a>        t[x].ch[<span class="dv">1</span>] = merge(t[x].ch[<span class="dv">1</span>], y);</span>
<span id="cb12-6"><a aria-hidden="true" href="#cb12-6"></a>        maintain(x);</span>
<span id="cb12-7"><a aria-hidden="true" href="#cb12-7"></a>        <span class="cf">return</span> x;</span>
<span id="cb12-8"><a aria-hidden="true" href="#cb12-8"></a>    }</span>
<span id="cb12-9"><a aria-hidden="true" href="#cb12-9"></a>    <span class="cf">else</span> {</span>
<span id="cb12-10"><a aria-hidden="true" href="#cb12-10"></a>        t[y].ch[<span class="dv">0</span>] = merge(x, t[y].ch[<span class="dv">0</span>]);</span>
<span id="cb12-11"><a aria-hidden="true" href="#cb12-11"></a>        maintain(y);</span>
<span id="cb12-12"><a aria-hidden="true" href="#cb12-12"></a>        <span class="cf">return</span> y;</span>
<span id="cb12-13"><a aria-hidden="true" href="#cb12-13"></a>    }</span>
<span id="cb12-14"><a aria-hidden="true" href="#cb12-14"></a>}</span></code></pre></div>
<p>é¦–å…ˆå¦‚æœä¸¤æ£µæ ‘çš„å…¶ä¸­ä¸€æ£µä¸ºç©ºï¼Œåˆ™ç›´æ¥è¿”å›å¦ä¸€æ£µçš„æ ¹å³å¯ã€‚</p>
<p>ç„¶åç»´æŠ¤ä¸€ä¸ªå°æ ¹å †ï¼ˆå°æ ¹å¤§æ ¹å…¶å®æ— æ‰€è°“ï¼‰ï¼Œå¦‚æœå‘ç°å·¦è¾¹å­æ ‘æ ¹ï¼ˆ<span class="math inline">\(x\)</span>ï¼‰çš„æƒå°ä¸€äº›ï¼Œè¯´æ˜æ˜¯ <span class="math inline">\(x\)</span> åšçˆ¶äº²ï¼Œå°†å…¶å³å­æ ‘ä¸ <span class="math inline">\(y\)</span> åˆå¹¶çš„ç»“æœä½œä¸ºå…¶å³å­æ ‘å³å¯ï¼Œåˆå¹¶å®Œè®°å¾— pushup ä¸€ä¸‹å°±è¡Œäº†ã€‚</p>
<p>åä¹‹äº¦ç„¶ï¼Œå°† <span class="math inline">\(y\)</span> çš„å·¦å­æ ‘ä¸ <span class="math inline">\(x\)</span> åˆå¹¶çš„ç»“æœä½œä¸º <span class="math inline">\(y\)</span> çš„å·¦å­æ ‘å³å¯ï¼Œ<strong>æ³¨æ„ä¼ å‚çš„é¡ºåºï¼šå…ˆä¼ å·¦æ ‘åä¼ å³æ ‘</strong></p>
<p>è¿˜æ˜¯æ¯”è¾ƒå¥½ç†è§£çš„ã€‚å­¦ä¹ å®Œäº†ä¸¤ä¸ªåŸºæœ¬æ“ä½œï¼Œå°±å¯ä»¥å¾ˆè½»æ¾çš„å®ç°æ’å…¥åˆ é™¤æ’å <span class="math inline">\(k\text{th}\)</span> å‰é©±åç»§ç­‰æ“ä½œäº†ã€‚</p>
<h3 id="æ’å…¥">æ’å…¥</h3>
<p>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼ŒFHQ-Treap åœ¨å¤„ç†ç›¸åŒå€¼çš„æ—¶å€™æ˜¯å•ç‹¬å¼€æ–°èŠ‚ç‚¹çš„ï¼Œä¸åƒä¸€èˆ¬çš„ Treap ç»´æŠ¤ <code>cnt</code> åŸŸã€‚</p>
<p>æ ¸å¿ƒæ€æƒ³å°±æ˜¯ä»¥å¾…æ’å…¥å€¼ä¸ºé˜ˆå€¼åˆ†è£‚æˆæ ‘ <span class="math inline">\(x\)</span>ï¼Œ<span class="math inline">\(y\)</span>ï¼Œç„¶åå°† <span class="math inline">\(x\)</span>ï¼Œæ–°èŠ‚ç‚¹å’Œ <span class="math inline">\(y\)</span> åˆå¹¶å³å¯ã€‚</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb13-1"><a aria-hidden="true" href="#cb13-1"></a><span class="dt">void</span> insert(<span class="dt">int</span> val) {</span>
<span id="cb13-2"><a aria-hidden="true" href="#cb13-2"></a>    t[++cnt].val = val;<span class="co">//å¼€æ–°èŠ‚ç‚¹</span></span>
<span id="cb13-3"><a aria-hidden="true" href="#cb13-3"></a>    t[cnt].key = rnd();<span class="co">//éšæœºåˆ†é…æƒ</span></span>
<span id="cb13-4"><a aria-hidden="true" href="#cb13-4"></a>    t[cnt].size = <span class="dv">1</span>;</span>
<span id="cb13-5"><a aria-hidden="true" href="#cb13-5"></a>    <span class="dt">int</span> x, y;<span class="co">//ä¸´æ—¶å˜é‡</span></span>
<span id="cb13-6"><a aria-hidden="true" href="#cb13-6"></a>    split(root, val, x, y);<span class="co">//æŒ‰ç…§ val åˆ†è£‚</span></span>
<span id="cb13-7"><a aria-hidden="true" href="#cb13-7"></a>    root = merge(merge(x, cnt), y);<span class="co">//å…ˆåˆå¹¶ x å’Œæ–°èŠ‚ç‚¹ï¼Œå†å°†ç»“æœä¸ y åˆå¹¶</span></span>
<span id="cb13-8"><a aria-hidden="true" href="#cb13-8"></a>    <span class="cf">return</span>;</span>
<span id="cb13-9"><a aria-hidden="true" href="#cb13-9"></a>}</span></code></pre></div>
<h3 id="åˆ é™¤">åˆ é™¤</h3>
<p>è¿™ä¸ªæ“ä½œæ¯”è¾ƒç²¾å¦™ï¼šè€ƒè™‘åˆ é™¤ <span class="math inline">\(val\)</span>ï¼Œå…ˆå°†æ•´æ£µæ ‘åˆ†è£‚æˆ <span class="math inline">\(x\)</span>ï¼Œ<span class="math inline">\(y\)</span>ï¼Œ<span class="math inline">\(z\)</span> ä¸‰æ£µæ ‘ï¼Œæ»¡è¶³ï¼š<span class="math inline">\(x\)</span> ä¸­æ‰€æœ‰èŠ‚ç‚¹å€¼å‡å°äº <span class="math inline">\(val\)</span>ï¼Œ<span class="math inline">\(y\)</span> ä¸­å‡ç­‰äº <span class="math inline">\(val\)</span>ï¼Œ<span class="math inline">\(z\)</span> ä¸­å‡å¤§äº <span class="math inline">\(val\)</span>ã€‚è¿™æ—¶å€™æˆ‘ä»¬å‘ç°è¦åˆ é™¤ä¸€ä¸ª <span class="math inline">\(val\)</span> å°±åªéœ€è¦æ‹¿æ‰ <span class="math inline">\(y\)</span> çš„æ ¹èŠ‚ç‚¹å°±å¯ä»¥äº†ï¼Œå…¶ç­‰ä»·äºç›´æ¥åˆå¹¶ <span class="math inline">\(y\)</span> çš„å·¦å³å­æ ‘ã€‚</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb14-1"><a aria-hidden="true" href="#cb14-1"></a><span class="dt">void</span> delnode(<span class="dt">int</span> val) {</span>
<span id="cb14-2"><a aria-hidden="true" href="#cb14-2"></a>    <span class="dt">int</span> x, y, z;</span>
<span id="cb14-3"><a aria-hidden="true" href="#cb14-3"></a>    split(root, val - <span class="dv">1</span>, x, y);<span class="co">//æŒ‰ç…§ val-1 åˆ†è£‚å‡º x æ ‘</span></span>
<span id="cb14-4"><a aria-hidden="true" href="#cb14-4"></a>    split(y, val, y, z);<span class="co">//å†æŒ‰ç…§ val åˆ†è£‚å‡º y å’Œ z</span></span>
<span id="cb14-5"><a aria-hidden="true" href="#cb14-5"></a>    y = merge(t[y].ch[<span class="dv">0</span>], t[y].ch[<span class="dv">1</span>]);<span class="co">//ç›´æ¥æ‹¿æ‰ y çš„æ ¹</span></span>
<span id="cb14-6"><a aria-hidden="true" href="#cb14-6"></a>    root = merge(merge(x, y), z);<span class="co">//å†å¤åŸå°±å¯ä»¥äº†</span></span>
<span id="cb14-7"><a aria-hidden="true" href="#cb14-7"></a>    <span class="cf">return</span>;</span>
<span id="cb14-8"><a aria-hidden="true" href="#cb14-8"></a>}</span></code></pre></div>
<h3 id="æ’åç¬¬-k-å¤§å°">æ’å/ç¬¬ <span class="math inline">\(k\)</span> å¤§/å°</h3>
<p>æŸ¥è¯¢æ’åå¾ˆç±»ä¼¼äºåˆ é™¤æ“ä½œï¼Œä½†åªéœ€è¦åˆ†è£‚å‡ºå°äº <span class="math inline">\(val\)</span> çš„æ ‘ç„¶åè¿”å›å…¶å¤§å°åŠ ä¸€çš„å€¼å³å¯ã€‚</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb15-1"><a aria-hidden="true" href="#cb15-1"></a><span class="dt">int</span> rank(<span class="dt">int</span> val) {</span>
<span id="cb15-2"><a aria-hidden="true" href="#cb15-2"></a>    <span class="dt">int</span> x, y;</span>
<span id="cb15-3"><a aria-hidden="true" href="#cb15-3"></a>    split(root, val - <span class="dv">1</span>, x, y);</span>
<span id="cb15-4"><a aria-hidden="true" href="#cb15-4"></a>    <span class="dt">int</span> ans = t[x].size + <span class="dv">1</span>;</span>
<span id="cb15-5"><a aria-hidden="true" href="#cb15-5"></a>    root = merge(x, y);</span>
<span id="cb15-6"><a aria-hidden="true" href="#cb15-6"></a>    <span class="cf">return</span> ans;</span>
<span id="cb15-7"><a aria-hidden="true" href="#cb15-7"></a>}</span></code></pre></div>
<p>ç„¶è€ŒæŸ¥è¯¢ <span class="math inline">\(k\text{th}\)</span> æ—¶å°±ä¸èƒ½åˆ†è£‚/åˆå¹¶äº†ï¼Œè€è€å®å®æŒ‰ç…§å¤§å¤šæ•°å¹³è¡¡æ ‘çš„å†™æ³•å°±å¯ä»¥äº†ï¼Œå»ºè®®éé€’å½’ï¼Œå¸¸æ•°å°ä¸€äº›ã€‚</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb16-1"><a aria-hidden="true" href="#cb16-1"></a><span class="dt">int</span> kth(<span class="dt">int</span> k) {</span>
<span id="cb16-2"><a aria-hidden="true" href="#cb16-2"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb16-3"><a aria-hidden="true" href="#cb16-3"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb16-4"><a aria-hidden="true" href="#cb16-4"></a>        <span class="dt">int</span> lsize = <span class="dv">0</span>;</span>
<span id="cb16-5"><a aria-hidden="true" href="#cb16-5"></a>        <span class="cf">if</span> (L)</span>
<span id="cb16-6"><a aria-hidden="true" href="#cb16-6"></a>            lsize = t[L].size;</span>
<span id="cb16-7"><a aria-hidden="true" href="#cb16-7"></a>        <span class="cf">if</span> (k &lt;= lsize)</span>
<span id="cb16-8"><a aria-hidden="true" href="#cb16-8"></a>            u = L;</span>
<span id="cb16-9"><a aria-hidden="true" href="#cb16-9"></a>        <span class="cf">else</span> <span class="cf">if</span> (k &gt; lsize + <span class="dv">1</span>)</span>
<span id="cb16-10"><a aria-hidden="true" href="#cb16-10"></a>            k -= lsize + <span class="dv">1</span>, u = R;</span>
<span id="cb16-11"><a aria-hidden="true" href="#cb16-11"></a>        <span class="cf">else</span> <span class="cf">return</span> t[u].val;</span>
<span id="cb16-12"><a aria-hidden="true" href="#cb16-12"></a>    }</span>
<span id="cb16-13"><a aria-hidden="true" href="#cb16-13"></a>}</span></code></pre></div>
<h3 id="å‰é©±åç»§">å‰é©±/åç»§</h3>
<p>å‰é©±ï¼šå°äº <span class="math inline">\(x\)</span> ä¸”æœ€å¤§çš„æ•°ï¼Œæ‰€ä»¥åˆ©ç”¨æ’åå’Œ <span class="math inline">\(k\text{th}\)</span> å³å¯ã€‚æŸ¥æ‰¾ <span class="math inline">\(x\)</span> çš„æ’åç„¶åè¾“å‡ºå¯¹åº”è¯¥æ’åå‡ä¸€çš„æ•°å³å¯ã€‚</p>
<p>åç»§ï¼šæŸ¥æ‰¾ <span class="math inline">\(x+1\)</span> çš„æ’åç„¶åè¾“å‡ºè¯¥æ’åå¯¹åº”çš„æ•°å³å¯</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb17-1"><a aria-hidden="true" href="#cb17-1"></a><span class="dt">int</span> pre(<span class="dt">int</span> val) {</span>
<span id="cb17-2"><a aria-hidden="true" href="#cb17-2"></a>    <span class="cf">return</span> kth(rank(val) - <span class="dv">1</span>);</span>
<span id="cb17-3"><a aria-hidden="true" href="#cb17-3"></a>}</span>
<span id="cb17-4"><a aria-hidden="true" href="#cb17-4"></a></span>
<span id="cb17-5"><a aria-hidden="true" href="#cb17-5"></a><span class="dt">int</span> suc(<span class="dt">int</span> val) {</span>
<span id="cb17-6"><a aria-hidden="true" href="#cb17-6"></a>    <span class="cf">return</span> kth(rank(val + <span class="dv">1</span>));</span>
<span id="cb17-7"><a aria-hidden="true" href="#cb17-7"></a>}</span></code></pre></div>
<h3 id="æ™®é€šå¹³è¡¡æ ‘çš„å®ç°">æ™®é€šå¹³è¡¡æ ‘çš„å®ç°</h3>
<p>å¯ä»¥å‘ç°ä»£ç æ˜æ˜¾çŸ­äºä¸€èˆ¬ Treap å’Œ Splayï¼Œä½†å¸¸æ•°å¤§äº Treap å°äº Splayã€‚<strong>å…³é”®æ˜¯ç‰¹åˆ«å¥½å†™å¥½èƒŒ</strong></p>
<p><a href="https://www.luogu.com.cn/problem/P6136" title="æ´›è°· P6136">æ´›è°· P6136</a> çš„ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb18-1"><a aria-hidden="true" href="#cb18-1"></a><span class="pp">#include </span><span class="im">&lt;cstdio&gt;</span></span>
<span id="cb18-2"><a aria-hidden="true" href="#cb18-2"></a><span class="pp">#include </span><span class="im">&lt;cctype&gt;</span></span>
<span id="cb18-3"><a aria-hidden="true" href="#cb18-3"></a><span class="pp">#include </span><span class="im">&lt;cstdlib&gt;</span></span>
<span id="cb18-4"><a aria-hidden="true" href="#cb18-4"></a></span>
<span id="cb18-5"><a aria-hidden="true" href="#cb18-5"></a><span class="at">const</span> <span class="dt">int</span> maxn = <span class="fl">1e6</span> + <span class="fl">2e5</span>;</span>
<span id="cb18-6"><a aria-hidden="true" href="#cb18-6"></a></span>
<span id="cb18-7"><a aria-hidden="true" href="#cb18-7"></a><span class="kw">inline</span> <span class="dt">int</span> read() {</span>
<span id="cb18-8"><a aria-hidden="true" href="#cb18-8"></a>    <span class="dt">char</span> c = getchar();</span>
<span id="cb18-9"><a aria-hidden="true" href="#cb18-9"></a>    <span class="dt">int</span> s = <span class="dv">0</span>;</span>
<span id="cb18-10"><a aria-hidden="true" href="#cb18-10"></a>    <span class="dt">bool</span> x = <span class="dv">0</span>;</span>
<span id="cb18-11"><a aria-hidden="true" href="#cb18-11"></a>    <span class="cf">while</span> (!isdigit(c))</span>
<span id="cb18-12"><a aria-hidden="true" href="#cb18-12"></a>        x = x | (c == <span class="ch">'-'</span>), c = getchar();</span>
<span id="cb18-13"><a aria-hidden="true" href="#cb18-13"></a>    <span class="cf">while</span> (isdigit(c))</span>
<span id="cb18-14"><a aria-hidden="true" href="#cb18-14"></a>        s = <span class="dv">10</span> * s + c - <span class="ch">'0'</span>, c = getchar();</span>
<span id="cb18-15"><a aria-hidden="true" href="#cb18-15"></a>    <span class="cf">return</span> x ? -s : s;</span>
<span id="cb18-16"><a aria-hidden="true" href="#cb18-16"></a>}</span>
<span id="cb18-17"><a aria-hidden="true" href="#cb18-17"></a></span>
<span id="cb18-18"><a aria-hidden="true" href="#cb18-18"></a><span class="kw">struct</span> node {</span>
<span id="cb18-19"><a aria-hidden="true" href="#cb18-19"></a>    <span class="dt">int</span> size;</span>
<span id="cb18-20"><a aria-hidden="true" href="#cb18-20"></a>    <span class="dt">int</span> ch[<span class="dv">2</span>];</span>
<span id="cb18-21"><a aria-hidden="true" href="#cb18-21"></a>    <span class="dt">int</span> val, key;</span>
<span id="cb18-22"><a aria-hidden="true" href="#cb18-22"></a><span class="pp">#define L </span>(t[u].ch[<span class="dv">0</span>])</span>
<span id="cb18-23"><a aria-hidden="true" href="#cb18-23"></a><span class="pp">#define R </span>(t[u].ch[<span class="dv">1</span>])</span>
<span id="cb18-24"><a aria-hidden="true" href="#cb18-24"></a>} t[maxn];</span>
<span id="cb18-25"><a aria-hidden="true" href="#cb18-25"></a></span>
<span id="cb18-26"><a aria-hidden="true" href="#cb18-26"></a><span class="dt">int</span> cnt, root;</span>
<span id="cb18-27"><a aria-hidden="true" href="#cb18-27"></a></span>
<span id="cb18-28"><a aria-hidden="true" href="#cb18-28"></a><span class="kw">inline</span> <span class="dt">void</span> pushup(<span class="dt">int</span> u) {</span>
<span id="cb18-29"><a aria-hidden="true" href="#cb18-29"></a>    t[u].size = t[L].size + t[R].size + <span class="dv">1</span>;</span>
<span id="cb18-30"><a aria-hidden="true" href="#cb18-30"></a>    <span class="cf">return</span>;</span>
<span id="cb18-31"><a aria-hidden="true" href="#cb18-31"></a>}</span>
<span id="cb18-32"><a aria-hidden="true" href="#cb18-32"></a></span>
<span id="cb18-33"><a aria-hidden="true" href="#cb18-33"></a><span class="dt">void</span> split(<span class="dt">int</span> u, <span class="dt">int</span> k, <span class="dt">int</span>&amp; x, <span class="dt">int</span>&amp; y) {</span>
<span id="cb18-34"><a aria-hidden="true" href="#cb18-34"></a>    <span class="cf">if</span> (!u) {</span>
<span id="cb18-35"><a aria-hidden="true" href="#cb18-35"></a>        x = y = <span class="dv">0</span>;</span>
<span id="cb18-36"><a aria-hidden="true" href="#cb18-36"></a>        <span class="cf">return</span>;</span>
<span id="cb18-37"><a aria-hidden="true" href="#cb18-37"></a>    }</span>
<span id="cb18-38"><a aria-hidden="true" href="#cb18-38"></a>    <span class="cf">if</span> (t[u].val &lt;= k) {</span>
<span id="cb18-39"><a aria-hidden="true" href="#cb18-39"></a>        x = u;</span>
<span id="cb18-40"><a aria-hidden="true" href="#cb18-40"></a>        split(R, k, R, y);</span>
<span id="cb18-41"><a aria-hidden="true" href="#cb18-41"></a>    }</span>
<span id="cb18-42"><a aria-hidden="true" href="#cb18-42"></a>    <span class="cf">else</span> {</span>
<span id="cb18-43"><a aria-hidden="true" href="#cb18-43"></a>        y = u;</span>
<span id="cb18-44"><a aria-hidden="true" href="#cb18-44"></a>        split(L, k, x, L);</span>
<span id="cb18-45"><a aria-hidden="true" href="#cb18-45"></a>    }</span>
<span id="cb18-46"><a aria-hidden="true" href="#cb18-46"></a>    pushup(u);</span>
<span id="cb18-47"><a aria-hidden="true" href="#cb18-47"></a>    <span class="cf">return</span>;</span>
<span id="cb18-48"><a aria-hidden="true" href="#cb18-48"></a>}</span>
<span id="cb18-49"><a aria-hidden="true" href="#cb18-49"></a></span>
<span id="cb18-50"><a aria-hidden="true" href="#cb18-50"></a><span class="dt">int</span> merge(<span class="dt">int</span> x, <span class="dt">int</span> y) {</span>
<span id="cb18-51"><a aria-hidden="true" href="#cb18-51"></a>    <span class="cf">if</span> (!x || !y)</span>
<span id="cb18-52"><a aria-hidden="true" href="#cb18-52"></a>        <span class="cf">return</span> x + y;</span>
<span id="cb18-53"><a aria-hidden="true" href="#cb18-53"></a>    <span class="cf">if</span> (t[x].key &lt; t[y].key) {</span>
<span id="cb18-54"><a aria-hidden="true" href="#cb18-54"></a>        t[x].ch[<span class="dv">1</span>] = merge(t[x].ch[<span class="dv">1</span>], y);</span>
<span id="cb18-55"><a aria-hidden="true" href="#cb18-55"></a>        pushup(x);</span>
<span id="cb18-56"><a aria-hidden="true" href="#cb18-56"></a>        <span class="cf">return</span> x;</span>
<span id="cb18-57"><a aria-hidden="true" href="#cb18-57"></a>    }</span>
<span id="cb18-58"><a aria-hidden="true" href="#cb18-58"></a>    <span class="cf">else</span> {</span>
<span id="cb18-59"><a aria-hidden="true" href="#cb18-59"></a>        t[y].ch[<span class="dv">0</span>] = merge(x, t[y].ch[<span class="dv">0</span>]);</span>
<span id="cb18-60"><a aria-hidden="true" href="#cb18-60"></a>        pushup(y);</span>
<span id="cb18-61"><a aria-hidden="true" href="#cb18-61"></a>        <span class="cf">return</span> y;</span>
<span id="cb18-62"><a aria-hidden="true" href="#cb18-62"></a>    }</span>
<span id="cb18-63"><a aria-hidden="true" href="#cb18-63"></a>}</span>
<span id="cb18-64"><a aria-hidden="true" href="#cb18-64"></a></span>
<span id="cb18-65"><a aria-hidden="true" href="#cb18-65"></a><span class="dt">void</span> insert(<span class="dt">int</span> val) {</span>
<span id="cb18-66"><a aria-hidden="true" href="#cb18-66"></a>    t[++cnt].val = val;</span>
<span id="cb18-67"><a aria-hidden="true" href="#cb18-67"></a>    t[cnt].key = rand();</span>
<span id="cb18-68"><a aria-hidden="true" href="#cb18-68"></a>    t[cnt].size = <span class="dv">1</span>;</span>
<span id="cb18-69"><a aria-hidden="true" href="#cb18-69"></a>    <span class="dt">int</span> x, y;</span>
<span id="cb18-70"><a aria-hidden="true" href="#cb18-70"></a>    split(root, val, x, y);</span>
<span id="cb18-71"><a aria-hidden="true" href="#cb18-71"></a>    root = merge(merge(x, cnt), y);</span>
<span id="cb18-72"><a aria-hidden="true" href="#cb18-72"></a>    <span class="cf">return</span>;</span>
<span id="cb18-73"><a aria-hidden="true" href="#cb18-73"></a>}</span>
<span id="cb18-74"><a aria-hidden="true" href="#cb18-74"></a></span>
<span id="cb18-75"><a aria-hidden="true" href="#cb18-75"></a><span class="dt">void</span> delnode(<span class="dt">int</span> val) {</span>
<span id="cb18-76"><a aria-hidden="true" href="#cb18-76"></a>    <span class="dt">int</span> x, y, z;</span>
<span id="cb18-77"><a aria-hidden="true" href="#cb18-77"></a>    split(root, val - <span class="dv">1</span>, x, y);</span>
<span id="cb18-78"><a aria-hidden="true" href="#cb18-78"></a>    split(y, val, y, z);</span>
<span id="cb18-79"><a aria-hidden="true" href="#cb18-79"></a>    y = merge(t[y].ch[<span class="dv">0</span>], t[y].ch[<span class="dv">1</span>]);</span>
<span id="cb18-80"><a aria-hidden="true" href="#cb18-80"></a>    root = merge(merge(x, y), z);</span>
<span id="cb18-81"><a aria-hidden="true" href="#cb18-81"></a>    <span class="cf">return</span>;</span>
<span id="cb18-82"><a aria-hidden="true" href="#cb18-82"></a>}</span>
<span id="cb18-83"><a aria-hidden="true" href="#cb18-83"></a></span>
<span id="cb18-84"><a aria-hidden="true" href="#cb18-84"></a><span class="dt">int</span> rank(<span class="dt">int</span> val) {</span>
<span id="cb18-85"><a aria-hidden="true" href="#cb18-85"></a>    <span class="dt">int</span> x, y;</span>
<span id="cb18-86"><a aria-hidden="true" href="#cb18-86"></a>    split(root, val - <span class="dv">1</span>, x, y);</span>
<span id="cb18-87"><a aria-hidden="true" href="#cb18-87"></a>    <span class="dt">int</span> ans = t[x].size + <span class="dv">1</span>;</span>
<span id="cb18-88"><a aria-hidden="true" href="#cb18-88"></a>    root = merge(x, y);</span>
<span id="cb18-89"><a aria-hidden="true" href="#cb18-89"></a>    <span class="cf">return</span> ans;</span>
<span id="cb18-90"><a aria-hidden="true" href="#cb18-90"></a>}</span>
<span id="cb18-91"><a aria-hidden="true" href="#cb18-91"></a></span>
<span id="cb18-92"><a aria-hidden="true" href="#cb18-92"></a><span class="dt">int</span> kth(<span class="dt">int</span> k) {</span>
<span id="cb18-93"><a aria-hidden="true" href="#cb18-93"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb18-94"><a aria-hidden="true" href="#cb18-94"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb18-95"><a aria-hidden="true" href="#cb18-95"></a>        <span class="dt">int</span> lsize = <span class="dv">0</span>;</span>
<span id="cb18-96"><a aria-hidden="true" href="#cb18-96"></a>        <span class="cf">if</span> (L) lsize = t[L].size;</span>
<span id="cb18-97"><a aria-hidden="true" href="#cb18-97"></a>        <span class="cf">if</span> (k &lt;= lsize)</span>
<span id="cb18-98"><a aria-hidden="true" href="#cb18-98"></a>            u = L;</span>
<span id="cb18-99"><a aria-hidden="true" href="#cb18-99"></a>        <span class="cf">else</span> <span class="cf">if</span> (k &gt; lsize + <span class="dv">1</span>)</span>
<span id="cb18-100"><a aria-hidden="true" href="#cb18-100"></a>            k -= lsize + <span class="dv">1</span>, u = R;</span>
<span id="cb18-101"><a aria-hidden="true" href="#cb18-101"></a>        <span class="cf">else</span> <span class="cf">return</span> t[u].val;</span>
<span id="cb18-102"><a aria-hidden="true" href="#cb18-102"></a>    }</span>
<span id="cb18-103"><a aria-hidden="true" href="#cb18-103"></a>}</span>
<span id="cb18-104"><a aria-hidden="true" href="#cb18-104"></a></span>
<span id="cb18-105"><a aria-hidden="true" href="#cb18-105"></a><span class="dt">int</span> pre(<span class="dt">int</span> val) {</span>
<span id="cb18-106"><a aria-hidden="true" href="#cb18-106"></a>    <span class="cf">return</span> kth(rank(val) - <span class="dv">1</span>);</span>
<span id="cb18-107"><a aria-hidden="true" href="#cb18-107"></a>}</span>
<span id="cb18-108"><a aria-hidden="true" href="#cb18-108"></a></span>
<span id="cb18-109"><a aria-hidden="true" href="#cb18-109"></a><span class="dt">int</span> suc(<span class="dt">int</span> val) {</span>
<span id="cb18-110"><a aria-hidden="true" href="#cb18-110"></a>    <span class="cf">return</span> kth(rank(val + <span class="dv">1</span>));</span>
<span id="cb18-111"><a aria-hidden="true" href="#cb18-111"></a>}</span>
<span id="cb18-112"><a aria-hidden="true" href="#cb18-112"></a></span>
<span id="cb18-113"><a aria-hidden="true" href="#cb18-113"></a><span class="dt">int</span> main() {</span>
<span id="cb18-114"><a aria-hidden="true" href="#cb18-114"></a>    <span class="dt">int</span> n = read(), m = read(), ans = <span class="dv">0</span>, lastans = <span class="dv">0</span>;</span>
<span id="cb18-115"><a aria-hidden="true" href="#cb18-115"></a>    srand(<span class="dv">20041031</span>);</span>
<span id="cb18-116"><a aria-hidden="true" href="#cb18-116"></a>    <span class="cf">while</span> (n--)</span>
<span id="cb18-117"><a aria-hidden="true" href="#cb18-117"></a>        insert(read());</span>
<span id="cb18-118"><a aria-hidden="true" href="#cb18-118"></a>    <span class="cf">while</span> (m--) {</span>
<span id="cb18-119"><a aria-hidden="true" href="#cb18-119"></a>        <span class="dt">int</span> opt = read(), x = read() ^ lastans;</span>
<span id="cb18-120"><a aria-hidden="true" href="#cb18-120"></a>        <span class="cf">switch</span> (opt) {</span>
<span id="cb18-121"><a aria-hidden="true" href="#cb18-121"></a>        <span class="cf">case</span> <span class="dv">1</span>:</span>
<span id="cb18-122"><a aria-hidden="true" href="#cb18-122"></a>            insert(x);</span>
<span id="cb18-123"><a aria-hidden="true" href="#cb18-123"></a>            <span class="cf">break</span>;</span>
<span id="cb18-124"><a aria-hidden="true" href="#cb18-124"></a>        <span class="cf">case</span> <span class="dv">2</span>:</span>
<span id="cb18-125"><a aria-hidden="true" href="#cb18-125"></a>            delnode(x);</span>
<span id="cb18-126"><a aria-hidden="true" href="#cb18-126"></a>            <span class="cf">break</span>;</span>
<span id="cb18-127"><a aria-hidden="true" href="#cb18-127"></a>        <span class="cf">case</span> <span class="dv">3</span>:</span>
<span id="cb18-128"><a aria-hidden="true" href="#cb18-128"></a>            ans ^= (lastans = rank(x));</span>
<span id="cb18-129"><a aria-hidden="true" href="#cb18-129"></a>            <span class="cf">break</span>;</span>
<span id="cb18-130"><a aria-hidden="true" href="#cb18-130"></a>        <span class="cf">case</span> <span class="dv">4</span>:</span>
<span id="cb18-131"><a aria-hidden="true" href="#cb18-131"></a>            ans ^= (lastans = kth(x));</span>
<span id="cb18-132"><a aria-hidden="true" href="#cb18-132"></a>            <span class="cf">break</span>;</span>
<span id="cb18-133"><a aria-hidden="true" href="#cb18-133"></a>        <span class="cf">case</span> <span class="dv">5</span>:</span>
<span id="cb18-134"><a aria-hidden="true" href="#cb18-134"></a>            ans ^= (lastans = pre(x));</span>
<span id="cb18-135"><a aria-hidden="true" href="#cb18-135"></a>            <span class="cf">break</span>;</span>
<span id="cb18-136"><a aria-hidden="true" href="#cb18-136"></a>        <span class="cf">case</span> <span class="dv">6</span>:</span>
<span id="cb18-137"><a aria-hidden="true" href="#cb18-137"></a>            ans ^= (lastans = suc(x));</span>
<span id="cb18-138"><a aria-hidden="true" href="#cb18-138"></a>            <span class="cf">break</span>;</span>
<span id="cb18-139"><a aria-hidden="true" href="#cb18-139"></a>        }</span>
<span id="cb18-140"><a aria-hidden="true" href="#cb18-140"></a>    }</span>
<span id="cb18-141"><a aria-hidden="true" href="#cb18-141"></a>    printf(<span class="st">"</span><span class="sc">%d\n</span><span class="st">"</span>, ans);</span>
<span id="cb18-142"><a aria-hidden="true" href="#cb18-142"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb18-143"><a aria-hidden="true" href="#cb18-143"></a>}</span></code></pre></div>
<h3 id="æŒ‰å¤§å°åˆ†è£‚æ–‡è‰ºå¹³è¡¡æ ‘çš„å®ç°">æŒ‰å¤§å°åˆ†è£‚/æ–‡è‰ºå¹³è¡¡æ ‘çš„å®ç°</h3>
<p>FHQ-Treap è¿˜æœ‰å¦å¤–ä¸€ç§åˆ†è£‚æ–¹å¼ï¼šæŒ‰å¤§å°åˆ†è£‚ï¼Œå°†ä¸€æ£µ FHQ-Treap åˆ†è£‚æˆ <span class="math inline">\(x\)</span>ï¼Œ<span class="math inline">\(y\)</span>ï¼Œæ»¡è¶³ <span class="math inline">\(x\)</span> çš„å¤§å°ä¸ºç»™å®šå€¼ã€‚è¿™æ ·å­åˆ†è£‚èƒ½å¤Ÿè®©æˆ‘ä»¬æ›´å¥½æ›´æ–¹ä¾¿åœ°å¤„ç†åŒºé—´é—®é¢˜ï¼Œä¸‹é¢ä»¥æ–‡è‰ºå¹³è¡¡æ ‘ä¸ºä¾‹ï¼š</p>
<p>é¦–å…ˆæ˜¯åˆ†è£‚å‡½æ•°ï¼š</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb19-1"><a aria-hidden="true" href="#cb19-1"></a><span class="dt">void</span> split(<span class="dt">int</span> u, <span class="dt">int</span> size, <span class="dt">int</span> &amp;x, <span class="dt">int</span> &amp;y) {</span>
<span id="cb19-2"><a aria-hidden="true" href="#cb19-2"></a>    <span class="cf">if</span> (!u) {</span>
<span id="cb19-3"><a aria-hidden="true" href="#cb19-3"></a>        x = y = <span class="dv">0</span>;</span>
<span id="cb19-4"><a aria-hidden="true" href="#cb19-4"></a>        <span class="cf">return</span>;</span>
<span id="cb19-5"><a aria-hidden="true" href="#cb19-5"></a>    }</span>
<span id="cb19-6"><a aria-hidden="true" href="#cb19-6"></a>    pushdown(u);</span>
<span id="cb19-7"><a aria-hidden="true" href="#cb19-7"></a>    <span class="cf">if</span> (t[L].size &lt; size)</span>
<span id="cb19-8"><a aria-hidden="true" href="#cb19-8"></a>        x = u, split(R, size - t[L].size - <span class="dv">1</span>, R, y);</span>
<span id="cb19-9"><a aria-hidden="true" href="#cb19-9"></a>    <span class="cf">else</span></span>
<span id="cb19-10"><a aria-hidden="true" href="#cb19-10"></a>        y = u, split(L, size, x, L);</span>
<span id="cb19-11"><a aria-hidden="true" href="#cb19-11"></a>    pushup(u);</span>
<span id="cb19-12"><a aria-hidden="true" href="#cb19-12"></a>    <span class="cf">return</span>;</span>
<span id="cb19-13"><a aria-hidden="true" href="#cb19-13"></a>}</span></code></pre></div>
<p>åŸºæœ¬å’Œä¸€èˆ¬çš„æŒ‰å€¼åˆ†è£‚æ˜¯å·®ä¸å¤šçš„ï¼Œåªä¸è¿‡è¦æ³¨æ„çš„å°±æ˜¯å¦‚æœè¦ç»§ç»­åˆ†è£‚å³å­æ ‘ï¼Œä¼ ä¸‹å»çš„ <code>size</code> å€¼æ˜¯éœ€è¦æ”¹å˜çš„ã€‚</p>
<p>å‰©ä¸‹çš„ä¹Ÿæ²¡ä»€ä¹ˆäº†ï¼Œå¯¹äºè¦ç¿»è½¬åŒºé—´ <span class="math inline">\([l,r]\)</span>ï¼Œç›´æ¥åˆ†è£‚æˆä¸‰æ£µæ ‘ã€‚å…·ä½“åœ°ï¼ŒæŒ‰ç…§ <span class="math inline">\(l-1\)</span> åˆ†è£‚æˆ <span class="math inline">\(x\)</span> å’Œ <span class="math inline">\(y\)</span>ï¼Œå†å°† <span class="math inline">\(y\)</span> æŒ‰ç…§ <span class="math inline">\(r-l+1\)</span> åˆ†è£‚æˆ <span class="math inline">\(y\)</span> å’Œ <span class="math inline">\(z\)</span>ï¼Œæ­¤æ—¶ <span class="math inline">\(y\)</span> æ ‘å°±æ˜¯æå–å‡ºæ¥çš„åŒºé—´ <span class="math inline">\([l,r]\)</span>ï¼Œæ‰“ä¸Šæ ‡è®°å³å¯ã€‚</p>
<p><strong>å®ç°æ–‡è‰ºå¹³è¡¡æ ‘çš„æ—¶å€™éœ€è¦ç‰¹åˆ«æ³¨æ„æ ‡è®°çš„ä¸‹ä¼ </strong>ï¼Œå®ç°å¦‚ä¸‹ï¼Œæ¯” Splay ç®€æ´ä¸”ä¸å®¹æ˜“å†™é”™ã€‚</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb20-1"><a aria-hidden="true" href="#cb20-1"></a><span class="pp">#include </span><span class="im">&lt;cstdio&gt;</span></span>
<span id="cb20-2"><a aria-hidden="true" href="#cb20-2"></a><span class="pp">#include </span><span class="im">&lt;cctype&gt;</span></span>
<span id="cb20-3"><a aria-hidden="true" href="#cb20-3"></a><span class="pp">#include </span><span class="im">&lt;cstdlib&gt;</span></span>
<span id="cb20-4"><a aria-hidden="true" href="#cb20-4"></a></span>
<span id="cb20-5"><a aria-hidden="true" href="#cb20-5"></a><span class="at">const</span> <span class="dt">int</span> maxn = <span class="dv">100000</span> + <span class="dv">5</span>;</span>
<span id="cb20-6"><a aria-hidden="true" href="#cb20-6"></a></span>
<span id="cb20-7"><a aria-hidden="true" href="#cb20-7"></a><span class="kw">inline</span> <span class="dt">int</span> read() {</span>
<span id="cb20-8"><a aria-hidden="true" href="#cb20-8"></a>    <span class="dt">char</span> c = getchar();</span>
<span id="cb20-9"><a aria-hidden="true" href="#cb20-9"></a>    <span class="dt">int</span> s = <span class="dv">0</span>;</span>
<span id="cb20-10"><a aria-hidden="true" href="#cb20-10"></a>    <span class="dt">bool</span> x = <span class="dv">0</span>;</span>
<span id="cb20-11"><a aria-hidden="true" href="#cb20-11"></a>    <span class="cf">while</span> (!isdigit(c))</span>
<span id="cb20-12"><a aria-hidden="true" href="#cb20-12"></a>        x = x | (c == <span class="ch">'-'</span>), c = getchar();</span>
<span id="cb20-13"><a aria-hidden="true" href="#cb20-13"></a>    <span class="cf">while</span> (isdigit(c))</span>
<span id="cb20-14"><a aria-hidden="true" href="#cb20-14"></a>        s = <span class="dv">10</span> * s + c - <span class="ch">'0'</span>, c = getchar();</span>
<span id="cb20-15"><a aria-hidden="true" href="#cb20-15"></a>    <span class="cf">return</span> x ? -s : s;</span>
<span id="cb20-16"><a aria-hidden="true" href="#cb20-16"></a>}</span>
<span id="cb20-17"><a aria-hidden="true" href="#cb20-17"></a></span>
<span id="cb20-18"><a aria-hidden="true" href="#cb20-18"></a><span class="kw">struct</span> node {</span>
<span id="cb20-19"><a aria-hidden="true" href="#cb20-19"></a>    <span class="dt">int</span> ch[<span class="dv">2</span>];</span>
<span id="cb20-20"><a aria-hidden="true" href="#cb20-20"></a>    <span class="dt">int</span> size;</span>
<span id="cb20-21"><a aria-hidden="true" href="#cb20-21"></a>    <span class="dt">int</span> val, key;</span>
<span id="cb20-22"><a aria-hidden="true" href="#cb20-22"></a>    <span class="dt">bool</span> tag;</span>
<span id="cb20-23"><a aria-hidden="true" href="#cb20-23"></a><span class="pp">#define L </span>(t[u].ch[<span class="dv">0</span>])</span>
<span id="cb20-24"><a aria-hidden="true" href="#cb20-24"></a><span class="pp">#define R </span>(t[u].ch[<span class="dv">1</span>])</span>
<span id="cb20-25"><a aria-hidden="true" href="#cb20-25"></a>} t[maxn];</span>
<span id="cb20-26"><a aria-hidden="true" href="#cb20-26"></a></span>
<span id="cb20-27"><a aria-hidden="true" href="#cb20-27"></a><span class="dt">int</span> cnt, root;</span>
<span id="cb20-28"><a aria-hidden="true" href="#cb20-28"></a></span>
<span id="cb20-29"><a aria-hidden="true" href="#cb20-29"></a><span class="kw">inline</span> <span class="dt">void</span> pushup(<span class="dt">int</span> u) {</span>
<span id="cb20-30"><a aria-hidden="true" href="#cb20-30"></a>    t[u].size = t[L].size + t[R].size + <span class="dv">1</span>;</span>
<span id="cb20-31"><a aria-hidden="true" href="#cb20-31"></a>    <span class="cf">return</span>;</span>
<span id="cb20-32"><a aria-hidden="true" href="#cb20-32"></a>}</span>
<span id="cb20-33"><a aria-hidden="true" href="#cb20-33"></a></span>
<span id="cb20-34"><a aria-hidden="true" href="#cb20-34"></a><span class="kw">inline</span> <span class="dt">void</span> pushdown(<span class="dt">int</span> u) {</span>
<span id="cb20-35"><a aria-hidden="true" href="#cb20-35"></a>    <span class="cf">if</span> (t[u].tag) {</span>
<span id="cb20-36"><a aria-hidden="true" href="#cb20-36"></a>        <span class="dt">int</span> tmp = L; L = R; R = tmp;</span>
<span id="cb20-37"><a aria-hidden="true" href="#cb20-37"></a>        t[L].tag ^= <span class="dv">1</span>, t[R].tag ^= <span class="dv">1</span>;</span>
<span id="cb20-38"><a aria-hidden="true" href="#cb20-38"></a>        t[u].tag = <span class="dv">0</span>;</span>
<span id="cb20-39"><a aria-hidden="true" href="#cb20-39"></a>    }</span>
<span id="cb20-40"><a aria-hidden="true" href="#cb20-40"></a>    <span class="cf">return</span>;</span>
<span id="cb20-41"><a aria-hidden="true" href="#cb20-41"></a>}</span>
<span id="cb20-42"><a aria-hidden="true" href="#cb20-42"></a></span>
<span id="cb20-43"><a aria-hidden="true" href="#cb20-43"></a><span class="dt">void</span> split(<span class="dt">int</span> u, <span class="dt">int</span> size, <span class="dt">int</span>&amp; x, <span class="dt">int</span>&amp; y) {</span>
<span id="cb20-44"><a aria-hidden="true" href="#cb20-44"></a>    <span class="cf">if</span> (!u) {</span>
<span id="cb20-45"><a aria-hidden="true" href="#cb20-45"></a>        x = y = <span class="dv">0</span>;</span>
<span id="cb20-46"><a aria-hidden="true" href="#cb20-46"></a>        <span class="cf">return</span>;</span>
<span id="cb20-47"><a aria-hidden="true" href="#cb20-47"></a>    }</span>
<span id="cb20-48"><a aria-hidden="true" href="#cb20-48"></a>    pushdown(u);</span>
<span id="cb20-49"><a aria-hidden="true" href="#cb20-49"></a>    <span class="cf">if</span> (t[L].size &lt; size)</span>
<span id="cb20-50"><a aria-hidden="true" href="#cb20-50"></a>        x = u, split(R, size - t[L].size - <span class="dv">1</span>, R, y);</span>
<span id="cb20-51"><a aria-hidden="true" href="#cb20-51"></a>    <span class="cf">else</span></span>
<span id="cb20-52"><a aria-hidden="true" href="#cb20-52"></a>        y = u, split(L, size, x, L);</span>
<span id="cb20-53"><a aria-hidden="true" href="#cb20-53"></a>    pushup(u);</span>
<span id="cb20-54"><a aria-hidden="true" href="#cb20-54"></a>    <span class="cf">return</span>;</span>
<span id="cb20-55"><a aria-hidden="true" href="#cb20-55"></a>}</span>
<span id="cb20-56"><a aria-hidden="true" href="#cb20-56"></a></span>
<span id="cb20-57"><a aria-hidden="true" href="#cb20-57"></a><span class="dt">int</span> merge(<span class="dt">int</span> x, <span class="dt">int</span> y) {</span>
<span id="cb20-58"><a aria-hidden="true" href="#cb20-58"></a>    <span class="cf">if</span> (!x || !y)</span>
<span id="cb20-59"><a aria-hidden="true" href="#cb20-59"></a>        <span class="cf">return</span> x + y;</span>
<span id="cb20-60"><a aria-hidden="true" href="#cb20-60"></a>    <span class="cf">if</span> (t[x].key &lt; t[y].key)</span>
<span id="cb20-61"><a aria-hidden="true" href="#cb20-61"></a>        <span class="cf">return</span> pushdown(x), t[x].ch[<span class="dv">1</span>] = merge(t[x].ch[<span class="dv">1</span>], y), pushup(x), x;</span>
<span id="cb20-62"><a aria-hidden="true" href="#cb20-62"></a>    <span class="cf">else</span></span>
<span id="cb20-63"><a aria-hidden="true" href="#cb20-63"></a>        <span class="cf">return</span> pushdown(y), t[y].ch[<span class="dv">0</span>] = merge(x, t[y].ch[<span class="dv">0</span>]), pushup(y), y;</span>
<span id="cb20-64"><a aria-hidden="true" href="#cb20-64"></a>}</span>
<span id="cb20-65"><a aria-hidden="true" href="#cb20-65"></a></span>
<span id="cb20-66"><a aria-hidden="true" href="#cb20-66"></a><span class="dt">int</span> newnode(<span class="dt">int</span> val) {</span>
<span id="cb20-67"><a aria-hidden="true" href="#cb20-67"></a>    t[++cnt].val = val;</span>
<span id="cb20-68"><a aria-hidden="true" href="#cb20-68"></a>    t[cnt].key = rand();</span>
<span id="cb20-69"><a aria-hidden="true" href="#cb20-69"></a>    t[cnt].size = <span class="dv">1</span>;</span>
<span id="cb20-70"><a aria-hidden="true" href="#cb20-70"></a>    <span class="cf">return</span> cnt;</span>
<span id="cb20-71"><a aria-hidden="true" href="#cb20-71"></a>}</span>
<span id="cb20-72"><a aria-hidden="true" href="#cb20-72"></a></span>
<span id="cb20-73"><a aria-hidden="true" href="#cb20-73"></a><span class="dt">void</span> reverse(<span class="dt">int</span> l, <span class="dt">int</span> r) {</span>
<span id="cb20-74"><a aria-hidden="true" href="#cb20-74"></a>    <span class="dt">int</span> x, y, z;</span>
<span id="cb20-75"><a aria-hidden="true" href="#cb20-75"></a>    split(root, l - <span class="dv">1</span>, x, y);</span>
<span id="cb20-76"><a aria-hidden="true" href="#cb20-76"></a>    split(y, r - l + <span class="dv">1</span>, y, z);</span>
<span id="cb20-77"><a aria-hidden="true" href="#cb20-77"></a>    t[y].tag ^= <span class="dv">1</span>;</span>
<span id="cb20-78"><a aria-hidden="true" href="#cb20-78"></a>    root = merge(merge(x, y), z);</span>
<span id="cb20-79"><a aria-hidden="true" href="#cb20-79"></a>    <span class="cf">return</span>;</span>
<span id="cb20-80"><a aria-hidden="true" href="#cb20-80"></a>}</span>
<span id="cb20-81"><a aria-hidden="true" href="#cb20-81"></a></span>
<span id="cb20-82"><a aria-hidden="true" href="#cb20-82"></a><span class="dt">void</span> dfs(<span class="dt">int</span> u) {</span>
<span id="cb20-83"><a aria-hidden="true" href="#cb20-83"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb20-84"><a aria-hidden="true" href="#cb20-84"></a>        <span class="cf">return</span>;</span>
<span id="cb20-85"><a aria-hidden="true" href="#cb20-85"></a>    pushdown(u);</span>
<span id="cb20-86"><a aria-hidden="true" href="#cb20-86"></a>    dfs(L);</span>
<span id="cb20-87"><a aria-hidden="true" href="#cb20-87"></a>    printf(<span class="st">"</span><span class="sc">%d</span><span class="st"> "</span>, t[u].val);</span>
<span id="cb20-88"><a aria-hidden="true" href="#cb20-88"></a>    dfs(R);</span>
<span id="cb20-89"><a aria-hidden="true" href="#cb20-89"></a>    <span class="cf">return</span>;</span>
<span id="cb20-90"><a aria-hidden="true" href="#cb20-90"></a>}</span>
<span id="cb20-91"><a aria-hidden="true" href="#cb20-91"></a></span>
<span id="cb20-92"><a aria-hidden="true" href="#cb20-92"></a><span class="dt">int</span> main() {</span>
<span id="cb20-93"><a aria-hidden="true" href="#cb20-93"></a>    <span class="dt">int</span> n = read(), m = read();</span>
<span id="cb20-94"><a aria-hidden="true" href="#cb20-94"></a>    <span class="cf">for</span> (<span class="dt">int</span> i = <span class="dv">1</span>; i &lt;= n; ++i)</span>
<span id="cb20-95"><a aria-hidden="true" href="#cb20-95"></a>        root = merge(root, newnode(i));</span>
<span id="cb20-96"><a aria-hidden="true" href="#cb20-96"></a>    <span class="cf">while</span> (m--) {</span>
<span id="cb20-97"><a aria-hidden="true" href="#cb20-97"></a>        <span class="dt">int</span> l = read(), r = read();</span>
<span id="cb20-98"><a aria-hidden="true" href="#cb20-98"></a>        reverse(l, r);</span>
<span id="cb20-99"><a aria-hidden="true" href="#cb20-99"></a>    }</span>
<span id="cb20-100"><a aria-hidden="true" href="#cb20-100"></a>    dfs(root);</span>
<span id="cb20-101"><a aria-hidden="true" href="#cb20-101"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb20-102"><a aria-hidden="true" href="#cb20-102"></a>}</span></code></pre></div>
<p>å¯è§ <span class="math inline">\(100\)</span> è¡Œå‡ºå¤´å°±å†™å®Œäº†ï¼Œæ¯” Splay å¥½å†™å¤ªå¤šäº†ã€‚</p>
<h3 id="ç»´æŠ¤åŒºé—´æ—¶çš„ä¸€ä¸ª-trick">ç»´æŠ¤åŒºé—´æ—¶çš„ä¸€ä¸ª trick</h3>
<p>å½“æˆ‘ä»¬åœ¨ä½¿ç”¨ FHQ-Treap ç»´æŠ¤ä¸€æ®µåºåˆ—æ—¶ï¼Œæœ‰æ—¶éœ€è¦å¿«é€Ÿæ‰¾å‡ºæŸå…ƒç´ åœ¨åºåˆ—ä¸­çš„ä½ç½®ï¼Œæ€ä¹ˆåŠå‘¢ï¼Ÿ</p>
<p>æ­¤æ—¶å¯ä»¥åœ¨å»ºæ ‘æ—¶è®°å½•ä¸‹è¿™ä¸ªå…ƒç´ åœ¨æ ‘ä¸­çš„èŠ‚ç‚¹ç¼–å·ï¼Œç„¶ååœ¨æ‰¾å¯»å…¶æ’åæ—¶è‡ªåº•è€Œä¸Šè®°å½•åœ¨å®ƒå·¦è¾¹çš„èŠ‚ç‚¹ä¸ªæ•°ã€‚å…·ä½“å¯ä»¥è¿™æ ·ï¼š</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb21-1"><a aria-hidden="true" href="#cb21-1"></a><span class="dt">int</span> getrank(<span class="dt">int</span> u)</span>
<span id="cb21-2"><a aria-hidden="true" href="#cb21-2"></a>{</span>
<span id="cb21-3"><a aria-hidden="true" href="#cb21-3"></a>    <span class="dt">int</span> ret = t[L].size + <span class="dv">1</span>;</span>
<span id="cb21-4"><a aria-hidden="true" href="#cb21-4"></a>    <span class="cf">while</span> (t[u].fa)</span>
<span id="cb21-5"><a aria-hidden="true" href="#cb21-5"></a>    {</span>
<span id="cb21-6"><a aria-hidden="true" href="#cb21-6"></a>        <span class="cf">if</span> (t[t[u].fa].ch[<span class="dv">1</span>] == u)</span>
<span id="cb21-7"><a aria-hidden="true" href="#cb21-7"></a>            ret += t[t[t[u].fa].ch[<span class="dv">0</span>]].size + <span class="dv">1</span>;</span>
<span id="cb21-8"><a aria-hidden="true" href="#cb21-8"></a>        u = t[u].fa;</span>
<span id="cb21-9"><a aria-hidden="true" href="#cb21-9"></a>    }</span>
<span id="cb21-10"><a aria-hidden="true" href="#cb21-10"></a>    <span class="cf">return</span> ret;</span>
<span id="cb21-11"><a aria-hidden="true" href="#cb21-11"></a>}</span></code></pre></div>
<p>å¯¹äºä¸€ä¸ªèŠ‚ç‚¹ <span class="math inline">\(u\)</span>ï¼Œé¦–å…ˆå®ƒçš„æ’åå°±æ˜¯å…¶å·¦å­æ ‘å¤§å°åŠ ä¸€ï¼Œç„¶åå¾€ä¸Šè·³ï¼Œåœ¨è·³çš„è¿‡ç¨‹ä¸­åˆ¤æ–­ä¸€ä¸‹å®ƒæ˜¯çˆ¶äº²èŠ‚ç‚¹çš„å·¦å„¿å­è¿˜æ˜¯å³å„¿å­ï¼Œå¦‚æœæ˜¯å³å„¿å­çš„è¯ï¼Œ<strong>çˆ¶äº²æœ¬èº«å’Œå…¶å…„å¼ŸèŠ‚ç‚¹éƒ½ä¼šäº§ç”Ÿè´¡çŒ®</strong>ï¼Œä¸€è·¯æœåˆ°æ ¹å³å¯ã€‚</p>
<p><strong>åŒæ—¶ pushup çš„æ—¶å€™è¦æ›´æ–°çˆ¶äº²</strong>ï¼Œpushup ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™é¡ºå¸¦æ›´æ–°å…¶ä¸¤ä¸ªå„¿å­çš„çˆ¶äº²ï¼ˆéœ€è¦åˆ¤æ–­æ˜¯å¦å­˜åœ¨ï¼‰</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb22-1"><a aria-hidden="true" href="#cb22-1"></a><span class="kw">inline</span> <span class="dt">void</span> pushup(<span class="dt">int</span> u)</span>
<span id="cb22-2"><a aria-hidden="true" href="#cb22-2"></a>{</span>
<span id="cb22-3"><a aria-hidden="true" href="#cb22-3"></a>    t[u].size = <span class="dv">1</span>;</span>
<span id="cb22-4"><a aria-hidden="true" href="#cb22-4"></a>    <span class="cf">if</span> (L)</span>
<span id="cb22-5"><a aria-hidden="true" href="#cb22-5"></a>        t[u].size += t[L].size, t[L].fa = u;</span>
<span id="cb22-6"><a aria-hidden="true" href="#cb22-6"></a>    <span class="cf">if</span> (R)</span>
<span id="cb22-7"><a aria-hidden="true" href="#cb22-7"></a>        t[u].size += t[R].size, t[R].fa = u;</span>
<span id="cb22-8"><a aria-hidden="true" href="#cb22-8"></a>    <span class="cf">return</span>;</span>
<span id="cb22-9"><a aria-hidden="true" href="#cb22-9"></a>}</span></code></pre></div>
<p>ç›¸å…³é¢˜ç›® <a href="https://www.luogu.com.cn/problem/P2596">[ZJOI2006]ä¹¦æ¶</a>ã€<a href="https://www.luogu.com.cn/problem/P3165">[CQOI2014]æ’åºæœºæ¢°è‡‚</a>ï¼Œå½“ç„¶è¿™äº›é¢˜éƒ½å¯ä»¥ç”¨ Splay è§£å†³ã€‚</p>
<h3 id="å¯å‘å¼åˆå¹¶">å¯å‘å¼åˆå¹¶</h3>
<p>æ­¤å¤„çš„åˆå¹¶ä¸ä¹‹å‰çš„ merge æ“ä½œä¸åŒï¼Œæ­¤å¤„åˆå¹¶çš„ä¸¤æ£µæ ‘å°±æ˜¯ä¸¤æ£µä¸€èˆ¬çš„æ ‘ï¼Œä¸èƒ½ç®€å•åœ°ç›´æ¥ <span class="math inline">\(O(\log n)\)</span> åˆå¹¶ã€‚æ­¤æ—¶æˆ‘ä»¬èƒ½åšçš„å°±æ˜¯å°†å°æ ‘æš´åŠ›é€’å½’åŠ å…¥åˆ°å¤§æ ‘ä¸­ï¼Œå¤æ‚åº¦ <span class="math inline">\(O(\log^2 n)\)</span>ã€‚å…·ä½“å®ç°å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb23-1"><a aria-hidden="true" href="#cb23-1"></a><span class="dt">void</span> insert(<span class="dt">int</span>&amp; root, <span class="dt">int</span> u) { <span class="co">//è¡¨ç¤ºå°† u èŠ‚ç‚¹åŠ å…¥ root ä¸ºæ ¹çš„æ–°æ ‘ä¸­</span></span>
<span id="cb23-2"><a aria-hidden="true" href="#cb23-2"></a>    <span class="dt">int</span> x, y;</span>
<span id="cb23-3"><a aria-hidden="true" href="#cb23-3"></a>    <span class="dt">int</span> val = t[u].val;</span>
<span id="cb23-4"><a aria-hidden="true" href="#cb23-4"></a>    split(root, val, x, y);</span>
<span id="cb23-5"><a aria-hidden="true" href="#cb23-5"></a>    root = merge(merge(x, u), y);</span>
<span id="cb23-6"><a aria-hidden="true" href="#cb23-6"></a>    <span class="cf">return</span>;</span>
<span id="cb23-7"><a aria-hidden="true" href="#cb23-7"></a>}</span>
<span id="cb23-8"><a aria-hidden="true" href="#cb23-8"></a></span>
<span id="cb23-9"><a aria-hidden="true" href="#cb23-9"></a><span class="dt">void</span> dfs(<span class="dt">int</span> u, <span class="dt">int</span>&amp; root) { <span class="co">//è¿™ä¸ª root çš„å¼•ç”¨æ˜¯æ–°æ ‘çš„æ ‘æ ¹</span></span>
<span id="cb23-10"><a aria-hidden="true" href="#cb23-10"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb23-11"><a aria-hidden="true" href="#cb23-11"></a>        <span class="cf">return</span>;</span>
<span id="cb23-12"><a aria-hidden="true" href="#cb23-12"></a>    dfs(L, root);<span class="co">//å…ˆæŠŠå·¦å­æ ‘åŠ å…¥</span></span>
<span id="cb23-13"><a aria-hidden="true" href="#cb23-13"></a>    dfs(R, root);<span class="co">//åŠ å…¥å³å­æ ‘</span></span>
<span id="cb23-14"><a aria-hidden="true" href="#cb23-14"></a>    L = R = <span class="dv">0</span>;<span class="co">//æ¸…ç©ºå„¿å­ï¼Œè¿™ä¸€æ­¥ä¸å†™ä¼šå‡ºé—®é¢˜</span></span>
<span id="cb23-15"><a aria-hidden="true" href="#cb23-15"></a>    insert(root, u);<span class="co">//å†åŠ å…¥è‡ªå·±</span></span>
<span id="cb23-16"><a aria-hidden="true" href="#cb23-16"></a>    <span class="cf">return</span>;</span>
<span id="cb23-17"><a aria-hidden="true" href="#cb23-17"></a>}</span>
<span id="cb23-18"><a aria-hidden="true" href="#cb23-18"></a></span>
<span id="cb23-19"><a aria-hidden="true" href="#cb23-19"></a><span class="dt">int</span> join(<span class="dt">int</span> x, <span class="dt">int</span> y) {</span>
<span id="cb23-20"><a aria-hidden="true" href="#cb23-20"></a>    <span class="cf">if</span> (t[x].size &gt; t[y].size)</span>
<span id="cb23-21"><a aria-hidden="true" href="#cb23-21"></a>        swap(x, y);</span>
<span id="cb23-22"><a aria-hidden="true" href="#cb23-22"></a>    dfs(x, y);<span class="co">//ä½¿ x æˆä¸ºå°æ ‘ç„¶åé€’å½’åŠ å…¥ y ä¸­</span></span>
<span id="cb23-23"><a aria-hidden="true" href="#cb23-23"></a>    <span class="cf">return</span> y;<span class="co">//è¿”å›æ–°çš„æ ¹ y</span></span>
<span id="cb23-24"><a aria-hidden="true" href="#cb23-24"></a>}</span></code></pre></div>
<p>ç›¸å…³è¯•é¢˜ <a href="https://www.luogu.com.cn/problem/P3224">[HNOI2012]æ°¸æ— ä¹¡</a></p>
<h3 id="æ˜“é”™ç‚¹">æ˜“é”™ç‚¹</h3>
<ul>
<li><strong>åˆ†è£‚ä»£ç ä¸èƒŒé”™å°±è¡Œ</strong></li>
<li>æ¶‰åŠåˆ°åˆ†è£‚å®Œåˆå¹¶çš„æ—¶å€™<strong>ä¸€å®šè®°å¾—æ›´æ–°æ ¹ï¼ï¼</strong>å³ <code>root = merge(...)</code></li>
<li>ç±»ä¼¼ç¬¬äºŒç‚¹ï¼Œåˆ é™¤èŠ‚ç‚¹è¿‡ç¨‹ä¸­åˆå¹¶ <span class="math inline">\(y\)</span> çš„å·¦å³å­æ ‘çš„æ—¶å€™<strong>åƒä¸‡è®°å¾—æ›´æ–° <span class="math inline">\(y\)</span> çš„å€¼</strong></li>
<li>æ¶‰åŠåˆ°å­æ ‘çš„æ“ä½œåƒä¸‡<strong>æå‰ pushdown</strong></li>
</ul>
<h2 id="splay">Splay</h2>
<h3 id="ç®€ä»‹initialization">ç®€ä»‹/Initialization</h3>
<p>ç›¸è¾ƒäºä¸¤ç§ Treapï¼ŒSplayï¼ˆä¼¸å±•æ ‘ï¼‰åˆ™ç¨å¾®éš¾å†™ä¸€ç‚¹ï¼ŒSplay çš„æ ¸å¿ƒæ“ä½œå°±æ˜¯ splayï¼šå³æŠŠä¸€ä¸ªèŠ‚ç‚¹æ—‹è½¬åˆ°æ ¹çš„ä½ç½®ï¼Œä»¥æ­¤ç»´æŠ¤æ ‘çš„å¹³è¡¡ã€‚å®ƒç›¸è¾ƒäº Treap çš„ä¼˜ç‚¹å°±æ˜¯å¯ä»¥å¤„ç†åŒºé—´ä¿¡æ¯ä»¥åŠå¿«é€Ÿåˆå¹¶/åˆ†è£‚ï¼ˆè™½ç„¶ fhqTreap ä¹Ÿèƒ½åšåˆ°ï¼‰ã€‚</p>
<p>Splay å…·æœ‰ä¸€åˆ‡ BST å…·æœ‰çš„æ€§è´¨ï¼Œå…¶ç›¸è¾ƒäº Treap çš„åŒºåˆ«å°±æ˜¯å®ƒæ˜¯åŒæ—‹çš„ï¼Œè¿™æ ·å¯ä»¥ä¿è¯å‡æ‘Šå¤æ‚åº¦ <span class="math inline">\(O(\log n)\)</span>ï¼ˆè¯æ˜è¦ç”¨åŠ¿èƒ½åˆ†æï¼Œæˆ‘å¤ªèœæš‚æ—¶ä¸ä¼šï¼‰ã€‚é¦–å…ˆçœ‹ä¸‹ç»“æ„ä½“å¦‚ä½•å®šä¹‰ï¼š</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb24-1"><a aria-hidden="true" href="#cb24-1"></a><span class="kw">struct</span> Splay</span>
<span id="cb24-2"><a aria-hidden="true" href="#cb24-2"></a>{</span>
<span id="cb24-3"><a aria-hidden="true" href="#cb24-3"></a>    <span class="dt">int</span> ch[<span class="dv">2</span>], fa;<span class="co">//ä¸ treap ä¸åŒä¹‹å¤„åœ¨äº splay éœ€è¦è®°å½•çˆ¶äº²èŠ‚ç‚¹çš„ç¼–å·</span></span>
<span id="cb24-4"><a aria-hidden="true" href="#cb24-4"></a>    <span class="dt">int</span> cnt, size;</span>
<span id="cb24-5"><a aria-hidden="true" href="#cb24-5"></a>    <span class="dt">int</span> val;</span>
<span id="cb24-6"><a aria-hidden="true" href="#cb24-6"></a>} t[maxn];</span></code></pre></div>
<p>å¤„ç†æ—‹è½¬çš„æ—¶å€™æ˜¯éœ€è¦çŸ¥é“è¿™ä¸ªèŠ‚ç‚¹æ˜¯çˆ¶äº²çš„å·¦å„¿å­è¿˜æ˜¯å³å„¿å­çš„ï¼Œå¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb25-1"><a aria-hidden="true" href="#cb25-1"></a><span class="kw">inline</span> <span class="dt">bool</span> get(<span class="dt">int</span> u)</span>
<span id="cb25-2"><a aria-hidden="true" href="#cb25-2"></a>{</span>
<span id="cb25-3"><a aria-hidden="true" href="#cb25-3"></a>    <span class="cf">return</span> t[t[u].fa].ch[<span class="dv">1</span>] == u;</span>
<span id="cb25-4"><a aria-hidden="true" href="#cb25-4"></a>}</span></code></pre></div>
<p>æ—‹è½¬åä¸ Treap ä¸€æ ·éœ€è¦ç»´æŠ¤ size</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb26-1"><a aria-hidden="true" href="#cb26-1"></a><span class="kw">inline</span> <span class="dt">void</span> maintain(<span class="dt">int</span> u)</span>
<span id="cb26-2"><a aria-hidden="true" href="#cb26-2"></a>{</span>
<span id="cb26-3"><a aria-hidden="true" href="#cb26-3"></a>    t[u].size = t[u].cnt + t[L].size + t[R].size;</span>
<span id="cb26-4"><a aria-hidden="true" href="#cb26-4"></a>    <span class="cf">return</span>;</span>
<span id="cb26-5"><a aria-hidden="true" href="#cb26-5"></a>}</span></code></pre></div>
<h3 id="æ—‹è½¬ä¼¸å±•splay">æ—‹è½¬/ä¼¸å±•ï¼ˆSplayï¼‰</h3>
<p>æ¥ä¸‹æ¥å°±æ˜¯è¯¥æ­»çš„æ—‹è½¬æ“ä½œäº†ï¼šè€ƒè™‘å°† <span class="math inline">\(x\)</span> èŠ‚ç‚¹æ—‹è½¬åˆ° <span class="math inline">\(fa\)</span> çš„ä½ç½®ï¼Œï¼ˆä»¤ <span class="math inline">\(fa\)</span> çš„çˆ¶èŠ‚ç‚¹ä¸º <span class="math inline">\(gfa\)</span>ï¼‰å›¾ç¤ºå¦‚ä¸‹ï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_r1.png" title="step 1"/><figcaption>step 1</figcaption>
</figure>
<p>è¿™æ˜¯ä¸€å¼€å§‹çš„æƒ…å†µï¼Œé¦–å…ˆåˆ¤æ–­ <span class="math inline">\(x\)</span> æ˜¯å…¶çˆ¶äº²çš„å“ªä¸ªå„¿å­ï¼Œå®šä¹‰ <span class="math inline">\(d_1\)</span> ä¸º <span class="math inline">\(0\)</span> è¡¨ç¤ºæ˜¯å·¦å„¿å­ï¼Œ<span class="math inline">\(1\)</span> ä¸ºå³å„¿å­ï¼Œç„¶åæŠŠå…¶çˆ¶äº²çš„ <span class="math inline">\(d_1\)</span> å„¿å­å˜æˆ <code>t[x].ch[d1^1]</code>ï¼Œå¦‚ä¸‹ï¼Œæ­¤æ—¶ç”±äº <span class="math inline">\(d_1=0\)</span>ï¼Œæ‰€ä»¥ <code>d1^1</code> ä¸ºå³å„¿å­ï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_r2.png" title="step 2"/><figcaption>step 2</figcaption>
</figure>
<p>æ¥ä¸‹æ¥ç”¨ <span class="math inline">\(x\)</span> è¿æ¥ <span class="math inline">\(gfa\)</span>ï¼Œä»£æ›¿ <span class="math inline">\(fa\)</span> çš„ä½ç½®</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_r3.png" title="step 3"/><figcaption>step 3</figcaption>
</figure>
<p>æœ€åæŠŠ <span class="math inline">\(x\)</span> ä¸ <span class="math inline">\(fa\)</span> æ¥èµ·æ¥å°±å¯ä»¥äº†ï¼ˆå³ <code>t[x].ch[d1^1]=fa</code>ï¼‰</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_r4.png" title="step 4"/><figcaption>step 4</figcaption>
</figure>
<p>è¿™æ ·ï¼Œä¸€æ¬¡æ—‹è½¬æ“ä½œå°±å®Œæˆäº†ï¼Œå®ƒå®Œæˆçš„å°±æ˜¯å°†ä¸€ä¸ªèŠ‚ç‚¹å¾€ä¸Šæ—‹è½¬åˆ°å…¶çˆ¶äº²çš„ä½ç½®ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb27-1"><a aria-hidden="true" href="#cb27-1"></a><span class="dt">void</span> rotate(<span class="dt">int</span> u)</span>
<span id="cb27-2"><a aria-hidden="true" href="#cb27-2"></a>{</span>
<span id="cb27-3"><a aria-hidden="true" href="#cb27-3"></a>    <span class="dt">int</span> fa = t[u].fa, gfa = t[fa].fa;</span>
<span id="cb27-4"><a aria-hidden="true" href="#cb27-4"></a>    <span class="dt">int</span> d1 = get(u), d2 = get(fa);</span>
<span id="cb27-5"><a aria-hidden="true" href="#cb27-5"></a>    t[fa].ch[d1] = t[u].ch[d1 ^ <span class="dv">1</span>], t[t[u].ch[d1 ^ <span class="dv">1</span>]].fa = fa;</span>
<span id="cb27-6"><a aria-hidden="true" href="#cb27-6"></a>    <span class="cf">if</span> (gfa)</span>
<span id="cb27-7"><a aria-hidden="true" href="#cb27-7"></a>        t[gfa].ch[d2] = u;</span>
<span id="cb27-8"><a aria-hidden="true" href="#cb27-8"></a>    t[u].fa = gfa;</span>
<span id="cb27-9"><a aria-hidden="true" href="#cb27-9"></a>    t[fa].fa = u, t[u].ch[d1 ^ <span class="dv">1</span>] = fa;</span>
<span id="cb27-10"><a aria-hidden="true" href="#cb27-10"></a>    maintain(fa);<span class="co">//æœ€åä¸å¿˜ç»´æŠ¤ï¼Œæ³¨æ„å…ˆç»´æŠ¤ faï¼Œç†ç”±åŒ treap</span></span>
<span id="cb27-11"><a aria-hidden="true" href="#cb27-11"></a>    maintain(u);</span>
<span id="cb27-12"><a aria-hidden="true" href="#cb27-12"></a>}</span></code></pre></div>
<p>æ¥ä¸‹æ¥å°±æ˜¯ splay è¿‡ç¨‹äº†ï¼Œ<strong>splay æ“ä½œçš„ç›®çš„å°±æ˜¯å°†æŒ‡å®šèŠ‚ç‚¹æ—‹è½¬åˆ°æ ¹èŠ‚ç‚¹</strong>ï¼Œä¸€æ¬¡æ“ä½œåˆ†ä¸ºå…­ç§æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœ <span class="math inline">\(x\)</span> çš„çˆ¶äº²ä¸ºæ ¹ï¼Œåˆ™æ—‹è½¬ä¸€æ¬¡</li>
<li>å¦‚æœ <span class="math inline">\(x\)</span> çš„çˆ¶äº²ä¸ä¸ºæ ¹ï¼Œä¸” <span class="math inline">\(x\)</span> å’Œ <span class="math inline">\(fa\)</span> çš„å„¿å­ç±»å‹ç›¸åŒï¼ˆå³â€œä¸‰ç‚¹å…±çº¿â€ï¼Œä»£ç ä¸­å°±æ˜¯ <code>get()</code> å‡½æ•°è¿”å›å€¼ç›¸åŒï¼‰ï¼Œé‚£ä¹ˆé¦–å…ˆå·¦/å³æ—‹ <span class="math inline">\(fa\)</span>ï¼Œå†å·¦/å³æ—‹ <span class="math inline">\(x\)</span>ï¼ˆä¸¤æ¬¡å•æ—‹çš„æ–¹å‘ç›¸åŒï¼‰</li>
<li>å¦‚æœåœ¨ç¬¬äºŒç§æƒ…å†µç§ï¼Œ<span class="math inline">\(x\)</span> å’Œ <span class="math inline">\(fa\)</span> çš„å„¿å­ç±»å‹ä¸åŒï¼Œåˆ™å°† <span class="math inline">\(x\)</span> æ—‹è½¬ä¸¤æ¬¡ï¼Œå…ˆå·¦/å³å†å³/å·¦æ—‹ï¼ˆä¸¤æ¬¡å•æ—‹çš„æ–¹å‘ä¸åŒï¼‰</li>
</ul>
<p>â€ä¸‰ç‚¹å…±çº¿â€œçš„æƒ…å†µè§ä¸‹å›¾ï¼š<span class="math inline">\(6\)</span> ä¸º <span class="math inline">\(x\)</span>ï¼Œ<span class="math inline">\(3\)</span> ä¸º <span class="math inline">\(fa\)</span>ï¼Œ<span class="math inline">\(2\)</span> ä¸º <span class="math inline">\(gfa\)</span>ã€‚</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_s1.png"/><figcaption>step 1</figcaption>
</figure>
<p>å¯è§æˆ‘ä»¬å…ˆå³æ—‹ <span class="math inline">\(fa\)</span>ï¼Œå¾—åˆ°å¦‚ä¸‹ç»“æœï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_s2.png"/><figcaption>step 2</figcaption>
</figure>
<p>æ¥ä¸‹æ¥å†å³æ—‹ <span class="math inline">\(x\)</span>ï¼Œå¾—åˆ°ï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_s3.png"/><figcaption>step 3</figcaption>
</figure>
<p>ä¸‰ç‚¹ä¸å…±çº¿çš„æƒ…å†µå¦‚ä¸‹å›¾ï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_s4.png"/><figcaption>step 1</figcaption>
</figure>
<p>æ­¤æ—¶ <span class="math inline">\(x=6\)</span>ï¼Œ<span class="math inline">\(fa=4\)</span>ï¼Œ<span class="math inline">\(gfa=2\)</span>ï¼Œç°åœ¨å¯¹ <span class="math inline">\(x\)</span> å…ˆè¿›è¡Œä¸€æ¬¡å³æ—‹ï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_s5.png"/><figcaption>step 2</figcaption>
</figure>
<p>å†å¯¹ <span class="math inline">\(x\)</span> è¿›è¡Œä¸€æ¬¡å·¦æ—‹ï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_s6.png"/><figcaption>step 3</figcaption>
</figure>
<p>åå¤æ‰§è¡Œå¦‚ä¸Šæ“ä½œï¼Œç›´åˆ° <span class="math inline">\(x\)</span> æˆä¸ºæ ¹åï¼Œæ•´ä¸ª splay è¿‡ç¨‹å°±ç»“æŸäº†ã€‚</p>
<p>ä¸‹é¢çš„ <code>splay(u,goal)</code> æ„ä¸ºæŠŠ <span class="math inline">\(u\)</span> èŠ‚ç‚¹ä¼¸å±•åˆ° <span class="math inline">\(goal\)</span> èŠ‚ç‚¹çš„å„¿å­å¤„ï¼ˆ<span class="math inline">\(goal=0\)</span> å°±æ˜¯ä½¿ <span class="math inline">\(u\)</span> å˜æˆæ ¹èŠ‚ç‚¹ï¼‰</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb28-1"><a aria-hidden="true" href="#cb28-1"></a><span class="dt">void</span> splay(<span class="dt">int</span> u, <span class="dt">int</span> goal) {</span>
<span id="cb28-2"><a aria-hidden="true" href="#cb28-2"></a>    <span class="cf">while</span> (t[u].fa != goal) {<span class="co">//ä¸€ç›´ä¼¸å±•</span></span>
<span id="cb28-3"><a aria-hidden="true" href="#cb28-3"></a>        <span class="dt">int</span> fa = t[u].fa, gfa = t[fa].fa;<span class="co">//æ‰¾åˆ°çˆ¶äº²å’Œçˆ·çˆ·</span></span>
<span id="cb28-4"><a aria-hidden="true" href="#cb28-4"></a>        <span class="dt">int</span> d1 = get(u), d2 = get(fa);<span class="co">//æ‰¾åˆ° u æ˜¯ä»€ä¹ˆå„¿å­ï¼Œfa æ˜¯ä»€ä¹ˆå„¿å­ã€‚å·¦0å³1</span></span>
<span id="cb28-5"><a aria-hidden="true" href="#cb28-5"></a>        <span class="cf">if</span> (gfa != goal) {<span class="co">//å¦‚æœçˆ·çˆ·ä¸æ˜¯æ ¹ï¼Œåˆ™éœ€è¦æ—‹è½¬ä¸¤æ¬¡ï¼Œä¸‹é¢æ˜¯æ—‹è½¬ç¬¬ä¸€æ¬¡</span></span>
<span id="cb28-6"><a aria-hidden="true" href="#cb28-6"></a>            <span class="cf">if</span> (d1 == d2)<span class="co">//å¦‚æœä¸‰ç‚¹å…±çº¿</span></span>
<span id="cb28-7"><a aria-hidden="true" href="#cb28-7"></a>                rotate(fa);<span class="co">//å…ˆæ—‹è½¬ fa</span></span>
<span id="cb28-8"><a aria-hidden="true" href="#cb28-8"></a>            <span class="cf">else</span></span>
<span id="cb28-9"><a aria-hidden="true" href="#cb28-9"></a>                rotate(u);<span class="co">//å¦åˆ™å…ˆæ—‹è½¬ u</span></span>
<span id="cb28-10"><a aria-hidden="true" href="#cb28-10"></a>        }</span>
<span id="cb28-11"><a aria-hidden="true" href="#cb28-11"></a>        rotate(u);<span class="co">//ç¬¬äºŒæ¬¡æ—‹è½¬</span></span>
<span id="cb28-12"><a aria-hidden="true" href="#cb28-12"></a>    }</span>
<span id="cb28-13"><a aria-hidden="true" href="#cb28-13"></a>    <span class="cf">if</span> (goal == <span class="dv">0</span>)<span class="co">//å¦‚æœ u æˆä¸ºæ ¹äº†</span></span>
<span id="cb28-14"><a aria-hidden="true" href="#cb28-14"></a>        root = u;<span class="co">//æ›´æ–°æ ¹çš„å€¼</span></span>
<span id="cb28-15"><a aria-hidden="true" href="#cb28-15"></a>}</span></code></pre></div>
<h3 id="æ’å…¥-1">æ’å…¥</h3>
<p>æ’å…¥æ“ä½œå°±æ¯”è¾ƒç®€å•äº†ï¼Œç”±äº Splay çš„å½¢æ€æ˜¯å¯ä»¥æ”¹å˜çš„ï¼Œæ‰€ä»¥ä¸éœ€è¦é€’å½’ã€‚<strong>æ¯æ’å…¥ä¸€ä¸ªå…ƒç´ éƒ½è¿›è¡Œä¸€æ¬¡ Splay æ“ä½œè®©å…¶å˜ä¸ºæ ¹</strong></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb29-1"><a aria-hidden="true" href="#cb29-1"></a><span class="dt">void</span> insert(<span class="dt">int</span> val) {</span>
<span id="cb29-2"><a aria-hidden="true" href="#cb29-2"></a>    <span class="dt">int</span> u = root, fa = <span class="dv">0</span>;</span>
<span id="cb29-3"><a aria-hidden="true" href="#cb29-3"></a>    <span class="cf">while</span> (u &amp;&amp; t[u].val != val)</span>
<span id="cb29-4"><a aria-hidden="true" href="#cb29-4"></a>        fa = u, u = t[u].ch[t[u].val &lt; val];<span class="co">//å¾€ä¸‹èµ°</span></span>
<span id="cb29-5"><a aria-hidden="true" href="#cb29-5"></a>    <span class="cf">if</span> (u)<span class="co">//å¦‚æœèŠ‚ç‚¹å·²ç»å­˜åœ¨</span></span>
<span id="cb29-6"><a aria-hidden="true" href="#cb29-6"></a>        t[u].cnt++;</span>
<span id="cb29-7"><a aria-hidden="true" href="#cb29-7"></a>    <span class="cf">else</span> {</span>
<span id="cb29-8"><a aria-hidden="true" href="#cb29-8"></a>        u = ++cnt;<span class="co">//å¦åˆ™æ–°å¼€èŠ‚ç‚¹</span></span>
<span id="cb29-9"><a aria-hidden="true" href="#cb29-9"></a>        <span class="cf">if</span> (fa)<span class="co">//å¦‚æœè‡ªå·±ä¸æ˜¯æ ¹</span></span>
<span id="cb29-10"><a aria-hidden="true" href="#cb29-10"></a>            t[fa].ch[t[fa].val &lt; val] = u;</span>
<span id="cb29-11"><a aria-hidden="true" href="#cb29-11"></a>        t[u].fa = fa;</span>
<span id="cb29-12"><a aria-hidden="true" href="#cb29-12"></a>        t[u].size = t[u].cnt = <span class="dv">1</span>;</span>
<span id="cb29-13"><a aria-hidden="true" href="#cb29-13"></a>        t[u].val = val;</span>
<span id="cb29-14"><a aria-hidden="true" href="#cb29-14"></a>    }</span>
<span id="cb29-15"><a aria-hidden="true" href="#cb29-15"></a>    splay(u, <span class="dv">0</span>);<span class="co">//ä¸ºäº†é™ä½å‡æ‘Šå¤æ‚åº¦ï¼Œéœ€è¦å°†æ–°æ’å…¥çš„èŠ‚ç‚¹ splay åˆ°æ ¹</span></span>
<span id="cb29-16"><a aria-hidden="true" href="#cb29-16"></a>}</span></code></pre></div>
<h3 id="æ’åç¬¬-k-å°å¤§">æ’å/ç¬¬ <span class="math inline">\(k\)</span> å°/å¤§</h3>
<p>ç”±äº Splay çš„å½¢æ€å¯ä»¥æ”¹å˜ï¼Œå› æ­¤åœ¨æŸ¥è¯¢æ’åçš„æ—¶å€™å¯ä»¥ç›´æ¥å°†å…¶ splay åˆ°æ ‘æ ¹ï¼Œç„¶åç»Ÿè®¡å·¦å­æ ‘å¤§å°å† +1 å°±å¯ä»¥äº†ã€‚å½“ç„¶é¦–å…ˆéœ€è¦æ‰¾åˆ°å¯¹åº”çš„æ•°åœ¨å“ªé‡Œï¼Œä¸‹é¢å…ˆå®ç° <code>find(int val)</code> å‡½æ•°ï¼Œå®ƒè¿”å›åˆšå¥½ç­‰äº <span class="math inline">\(val\)</span> çš„èŠ‚ç‚¹çš„ç¼–å·ï¼ˆå¦‚æœå­˜åœ¨çš„è¯ï¼‰ï¼Œä¸å­˜åœ¨åˆ™è¿”å›ä¸€ä¸ªå¶å­èŠ‚ç‚¹ï¼ˆ<strong>æ‰‹ç©ä¸€ä¸‹ä¾¿çŸ¥å®ƒè¿”å›çš„è¦ä¹ˆæ˜¯å‰é©±è¦ä¹ˆæ˜¯åç»§ï¼Œä½†ä¸ä¸€å®šæ˜¯ä¸ <span class="math inline">\(val\)</span> çš„å€¼æœ€æ¥è¿‘çš„èŠ‚ç‚¹ï¼Œä½†æ˜¯ä¸€å®šå¯ä»¥ä¿è¯è¿”å›çš„æ’åæ˜¯æ­£ç¡®çš„</strong>ï¼‰ã€‚ç„¶å <code>rank()</code> å‡½æ•°çš„å®ç°å°±ç›¸å½“ç®€å•äº†ï¼š</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb30-1"><a aria-hidden="true" href="#cb30-1"></a><span class="dt">int</span> find(<span class="dt">int</span> val) {</span>
<span id="cb30-2"><a aria-hidden="true" href="#cb30-2"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb30-3"><a aria-hidden="true" href="#cb30-3"></a>    <span class="cf">while</span> (t[u].val != val &amp;&amp; t[u].ch[t[u].val &lt; val])</span>
<span id="cb30-4"><a aria-hidden="true" href="#cb30-4"></a>        u = t[u].ch[t[u].val &lt; val];</span>
<span id="cb30-5"><a aria-hidden="true" href="#cb30-5"></a>    <span class="cf">return</span> u;</span>
<span id="cb30-6"><a aria-hidden="true" href="#cb30-6"></a>}</span>
<span id="cb30-7"><a aria-hidden="true" href="#cb30-7"></a><span class="dt">int</span> rank(<span class="dt">int</span> val) {</span>
<span id="cb30-8"><a aria-hidden="true" href="#cb30-8"></a>    splay(find(val), <span class="dv">0</span>);<span class="co">//å…ˆæŠŠå¯¹åº”èŠ‚ç‚¹æ—‹è½¬åˆ°æ ¹</span></span>
<span id="cb30-9"><a aria-hidden="true" href="#cb30-9"></a>    <span class="cf">return</span> t[t[root].ch[<span class="dv">0</span>]].size + <span class="dv">1</span>;<span class="co">//ç›´æ¥æ ¹çš„å·¦å­æ ‘å¤§å°åŠ  1</span></span>
<span id="cb30-10"><a aria-hidden="true" href="#cb30-10"></a>}</span></code></pre></div>
<p><strong>éœ€è¦æ³¨æ„çš„æ˜¯å¦‚æœæŸ¥è¯¢æ’åçš„æ•°ä¸å­˜åœ¨çš„è¯ä¼šå‡ºä¸€äº›å¥‡å¥‡æ€ªæ€ªçš„é—®é¢˜ï¼Œæ‰€ä»¥åœ¨å†™åŠ å¼ºç‰ˆæ¨¡æ¿çš„æ—¶å€™æ¨èä½¿ç”¨ä¸‹é¢çš„å†™æ³•ï¼š</strong></p>
<div class="sourceCode" id="cb31"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb31-1"><a aria-hidden="true" href="#cb31-1"></a><span class="dt">int</span> rank(<span class="dt">int</span> val) {</span>
<span id="cb31-2"><a aria-hidden="true" href="#cb31-2"></a>    insert(val);</span>
<span id="cb31-3"><a aria-hidden="true" href="#cb31-3"></a>    <span class="dt">int</span> ans = t[t[root].ch[<span class="dv">0</span>]].size + <span class="dv">1</span>;</span>
<span id="cb31-4"><a aria-hidden="true" href="#cb31-4"></a>    delnode(val);</span>
<span id="cb31-5"><a aria-hidden="true" href="#cb31-5"></a>    <span class="cf">return</span> ans;</span>
<span id="cb31-6"><a aria-hidden="true" href="#cb31-6"></a>}</span></code></pre></div>
<p>ç¬¬ <span class="math inline">\(k\)</span> å°ã€‚ç±»ä¼¼é€’å½’çš„æŸ¥æ‰¾å³å¯ï¼Œæ³¨æ„æŸ¥è¯¢å³å­æ ‘çš„æ—¶å€™è¦å‡å»æœ¬èº«å’Œå·¦å­æ ‘çš„è´¡çŒ®ï¼š</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb32-1"><a aria-hidden="true" href="#cb32-1"></a><span class="dt">int</span> kth(<span class="dt">int</span> k) {</span>
<span id="cb32-2"><a aria-hidden="true" href="#cb32-2"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb32-3"><a aria-hidden="true" href="#cb32-3"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb32-4"><a aria-hidden="true" href="#cb32-4"></a>        <span class="cf">if</span> (k &lt;= t[L].size)<span class="co">//å¦‚æœç¬¬ k å°åœ¨å·¦å­æ ‘ä¸­</span></span>
<span id="cb32-5"><a aria-hidden="true" href="#cb32-5"></a>            u = L;</span>
<span id="cb32-6"><a aria-hidden="true" href="#cb32-6"></a>        <span class="cf">else</span> <span class="cf">if</span> (k &gt; t[L].size + t[u].cnt) { <span class="co">//å¦‚æœç¬¬ k å°åœ¨å³å­æ ‘ä¸­</span></span>
<span id="cb32-7"><a aria-hidden="true" href="#cb32-7"></a>            k -= t[L].size + t[u].cnt;<span class="co">//å‡å» L å’Œ u äº§ç”Ÿçš„è´¡çŒ®</span></span>
<span id="cb32-8"><a aria-hidden="true" href="#cb32-8"></a>            u = R;</span>
<span id="cb32-9"><a aria-hidden="true" href="#cb32-9"></a>        } <span class="cf">else</span> <span class="cf">return</span> t[u].val;<span class="co">//å¦åˆ™å°±æ˜¯è‡ªå·±äº†ï¼Œè¿”å›å³å¯</span></span>
<span id="cb32-10"><a aria-hidden="true" href="#cb32-10"></a>    }</span>
<span id="cb32-11"><a aria-hidden="true" href="#cb32-11"></a>}</span></code></pre></div>
<h3 id="å‰é©±åç»§åˆ é™¤">å‰é©±åç»§/åˆ é™¤</h3>
<p>åŒæ’åæ“ä½œï¼Œè€ƒè™‘ç›´æ¥æŠŠ <span class="math inline">\(val\)</span> èŠ‚ç‚¹ç¿»åˆ°æ ¹ã€‚æ­¤æ—¶<strong>å‰é©±è¦ä¹ˆå°±æ˜¯æ ¹èŠ‚ç‚¹ï¼Œè¦ä¹ˆå°±æ˜¯å·¦å­æ ‘ä¸­æœ€é å³çš„èŠ‚ç‚¹</strong>ã€‚ç”± <code>find()</code> å‡½æ•°çš„æ€§è´¨ï¼Œå¦‚æœ <span class="math inline">\(val\)</span> å­˜åœ¨ï¼Œåˆ™å‰é©±ä¸€å®šåœ¨å·¦å­æ ‘é‡Œé¢çš„æœ€å³è¾¹ï¼Œå¦‚æœ <span class="math inline">\(val\)</span> ä¸å­˜åœ¨ï¼Œåˆ™ç¿»ä¸Šæ¥çš„ç‚¹è¦ä¹ˆæ˜¯å‰é©±è¦ä¹ˆæ˜¯åç»§ï¼Œå¦‚æœå°äº <span class="math inline">\(val\)</span> å°±ç›´æ¥è¿”å›ï¼Œå¤§äº <span class="math inline">\(val\)</span> åˆ™å’Œç¬¬ä¸€ç§æƒ…å†µä¸€æ ·ï¼Œåœ¨å·¦å­æ ‘é‡Œé¢çš„æœ€å³è¾¹ã€‚</p>
<p>è€Œåç»§å‡ ä¹åŒç†ã€‚ä¸éš¾å†™å‡ºå¦‚ä¸‹ä»£ç ï¼š</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb33-1"><a aria-hidden="true" href="#cb33-1"></a><span class="dt">int</span> getnxt(<span class="dt">int</span> val, <span class="dt">int</span> opt) {<span class="co">//opt=0 æ˜¯å‰é©±ï¼Œ1 æ˜¯åç»§</span></span>
<span id="cb33-2"><a aria-hidden="true" href="#cb33-2"></a>    splay(find(val), <span class="dv">0</span>);<span class="co">//å…ˆæŠŠå¯¹åº”èŠ‚ç‚¹ç¿»åˆ°æ ¹</span></span>
<span id="cb33-3"><a aria-hidden="true" href="#cb33-3"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb33-4"><a aria-hidden="true" href="#cb33-4"></a>    <span class="cf">if</span> (t[u].val &lt; val &amp;&amp; (!opt))<span class="co">//å¦‚æœè¦æ‰¾å‰é©±å¹¶ä¸”æ ¹å°±æ˜¯å‰é©±ï¼Œç›´æ¥è¿”å›å³å¯</span></span>
<span id="cb33-5"><a aria-hidden="true" href="#cb33-5"></a>        <span class="cf">return</span> u;</span>
<span id="cb33-6"><a aria-hidden="true" href="#cb33-6"></a>    <span class="cf">if</span> (t[u].val &gt; val &amp;&amp; opt)<span class="co">//åŒç†ï¼Œè¦æŸ¥æ‰¾åç»§å¹¶ä¸”æ ¹å°±æ˜¯åç»§</span></span>
<span id="cb33-7"><a aria-hidden="true" href="#cb33-7"></a>        <span class="cf">return</span> u;</span>
<span id="cb33-8"><a aria-hidden="true" href="#cb33-8"></a>    u = t[u].ch[opt];<span class="co">//å¦åˆ™åˆ°å·¦/å³å­æ ‘æŸ¥æ‰¾</span></span>
<span id="cb33-9"><a aria-hidden="true" href="#cb33-9"></a>    <span class="cf">while</span> (t[u].ch[opt ^ <span class="dv">1</span>])<span class="co">//æŸ¥æ‰¾æœ€å³/å·¦è¾¹çš„èŠ‚ç‚¹</span></span>
<span id="cb33-10"><a aria-hidden="true" href="#cb33-10"></a>        u = t[u].ch[opt ^ <span class="dv">1</span>];</span>
<span id="cb33-11"><a aria-hidden="true" href="#cb33-11"></a>    <span class="cf">return</span> u;</span>
<span id="cb33-12"><a aria-hidden="true" href="#cb33-12"></a>}</span></code></pre></div>
<p>æ³¨æ„è¿™ä¸ªå‡½æ•°è¿”å›çš„æ˜¯å‰é©±/åç»§åœ¨æ ‘ä¸­çš„ç¼–å·ï¼Œä¸ºä»€ä¹ˆè¦è¿™æ ·å‘¢ï¼Œä¸ºäº†ä¸‹é¢çš„åˆ é™¤æ“ä½œã€‚</p>
<p>åˆ é™¤ä¸€ä¸ªæ•°æ—¶ï¼Œæ³¨æ„æˆ‘ä»¬å¦‚æœå°†å…¶ splay åˆ°æ ¹çš„è¯ï¼Œä¼šå‘ç°å·¦å³å­æ ‘ä¸å¥½å¤„ç†ã€‚æ€ä¹ˆåŠå‘¢ï¼Œ<strong>æŠŠå‰é©±æ—‹è½¬åˆ°æ ¹ï¼Œç„¶åæŠŠåç»§ç¿»åˆ°å‰é©±çš„ä¸‹é¢</strong>ï¼Œæ­¤æ—¶ <code>splay()</code> å‡½æ•°çš„ <span class="math inline">\(goal\)</span> å‚æ•°å°±ä½“ç°å‡ºå®ƒçš„ä½œç”¨äº†ã€‚</p>
<p>ä¸éš¾å‘ç°ï¼Œæ­¤æ—¶ <strong><span class="math inline">\(val\)</span> ä¸€å®šæ˜¯åç»§èŠ‚ç‚¹çš„å·¦å„¿å­</strong>ï¼Œå¦‚å›¾ï¼ˆå›æƒ³ä¸€ä¸‹å‰é©±å’Œåç»§çš„å®šä¹‰ï¼Œä½ ä¼šå‘ç°ç¡®å®æ˜¯è¿™æ ·çš„ï¼‰ï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_del.png"/><figcaption>è¯æ˜å¾ˆç®€å•ï¼Œå¯ä»¥è‡ªå·±æ€è€ƒæ€è€ƒ</figcaption>
</figure>
<p>é—®é¢˜ç°åœ¨å°±å¾ˆç®€å•äº†ï¼Œåªéœ€è¦åˆ é™¤æ‰ <span class="math inline">\(suc\)</span> çš„å·¦å„¿å­å°±å¯ä»¥äº†ï¼Œå¦‚æœæœ‰å¤šä¸ªé‚£å°± <code>cnt--</code> å¹¶æŠŠå¯¹åº”èŠ‚ç‚¹ splay åˆ°æ ¹ï¼Œåªæœ‰ä¸€ä¸ªå°±æŠŠ <span class="math inline">\(suc\)</span> çš„å·¦å„¿å­è®¾ä¸ºç©ºå³å¯ã€‚<strong>ç°åœ¨çŸ¥é“ä¸ºä»€ä¹ˆä¸Šé¢å‰é©±å’Œåç»§çš„å‡½æ•°è¿”å›çš„æ˜¯èŠ‚ç‚¹ç¼–å·äº†å§</strong></p>
<div class="sourceCode" id="cb34"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb34-1"><a aria-hidden="true" href="#cb34-1"></a><span class="dt">void</span> delnode(<span class="dt">int</span> val) {</span>
<span id="cb34-2"><a aria-hidden="true" href="#cb34-2"></a>    <span class="dt">int</span> pre = getnxt(val, <span class="dv">0</span>);</span>
<span id="cb34-3"><a aria-hidden="true" href="#cb34-3"></a>    <span class="dt">int</span> suc = getnxt(val, <span class="dv">1</span>);</span>
<span id="cb34-4"><a aria-hidden="true" href="#cb34-4"></a>    splay(pre, <span class="dv">0</span>);</span>
<span id="cb34-5"><a aria-hidden="true" href="#cb34-5"></a>    splay(suc, pre);<span class="co">//æŠŠåç»§æ—‹è½¬åˆ°å‰é©±çš„å„¿å­</span></span>
<span id="cb34-6"><a aria-hidden="true" href="#cb34-6"></a>    <span class="cf">if</span>(t[t[suc].ch[<span class="dv">0</span>]].cnt &gt; <span class="dv">1</span>) {</span>
<span id="cb34-7"><a aria-hidden="true" href="#cb34-7"></a>        t[t[suc].ch[<span class="dv">0</span>]].cnt--;</span>
<span id="cb34-8"><a aria-hidden="true" href="#cb34-8"></a>        splay(t[suc].ch[<span class="dv">0</span>], <span class="dv">0</span>);<span class="co">//ä¸å¿˜å†splayä¸€æ¬¡</span></span>
<span id="cb34-9"><a aria-hidden="true" href="#cb34-9"></a>    } <span class="cf">else</span> t[suc].ch[<span class="dv">0</span>] = <span class="dv">0</span>;</span>
<span id="cb34-10"><a aria-hidden="true" href="#cb34-10"></a>    <span class="cf">return</span>;</span>
<span id="cb34-11"><a aria-hidden="true" href="#cb34-11"></a>}</span></code></pre></div>
<h3 id="æ™®é€šå¹³è¡¡æ ‘çš„å®ç°-1">æ™®é€šå¹³è¡¡æ ‘çš„å®ç°</h3>
<p>å”¯ä¸€è¦æ³¨æ„çš„å°±æ˜¯ä¸€å¼€å§‹éœ€è¦å…ˆæ’å…¥æ­£è´Ÿæ— ç©·ï¼Œç„¶åç®—å‡ºæ¥çš„æ’åè¦å‡ä¸€ï¼ŒæŸ¥è¯¢çš„ <span class="math inline">\(k\)</span> è¦åŠ ä¸€</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb35-1"><a aria-hidden="true" href="#cb35-1"></a><span class="pp">#include </span><span class="im">&lt;cstdio&gt;</span></span>
<span id="cb35-2"><a aria-hidden="true" href="#cb35-2"></a><span class="pp">#include </span><span class="im">&lt;cctype&gt;</span></span>
<span id="cb35-3"><a aria-hidden="true" href="#cb35-3"></a><span class="pp">#define L </span>t[u].ch[<span class="dv">0</span>]</span>
<span id="cb35-4"><a aria-hidden="true" href="#cb35-4"></a><span class="pp">#define R </span>t[u].ch[<span class="dv">1</span>]</span>
<span id="cb35-5"><a aria-hidden="true" href="#cb35-5"></a></span>
<span id="cb35-6"><a aria-hidden="true" href="#cb35-6"></a><span class="kw">inline</span> <span class="dt">int</span> read() {</span>
<span id="cb35-7"><a aria-hidden="true" href="#cb35-7"></a>    <span class="dt">char</span> c = getchar();</span>
<span id="cb35-8"><a aria-hidden="true" href="#cb35-8"></a>    <span class="dt">int</span> s = <span class="dv">0</span>;</span>
<span id="cb35-9"><a aria-hidden="true" href="#cb35-9"></a>    <span class="dt">bool</span> x = <span class="dv">0</span>;</span>
<span id="cb35-10"><a aria-hidden="true" href="#cb35-10"></a>    <span class="cf">while</span> (!isdigit(c))</span>
<span id="cb35-11"><a aria-hidden="true" href="#cb35-11"></a>        x = x | (c == <span class="ch">'-'</span>), c = getchar();</span>
<span id="cb35-12"><a aria-hidden="true" href="#cb35-12"></a>    <span class="cf">while</span> (isdigit(c))</span>
<span id="cb35-13"><a aria-hidden="true" href="#cb35-13"></a>        s = <span class="dv">10</span> * s + c - <span class="ch">'0'</span>, c = getchar();</span>
<span id="cb35-14"><a aria-hidden="true" href="#cb35-14"></a>    <span class="cf">return</span> x ? -s : s;</span>
<span id="cb35-15"><a aria-hidden="true" href="#cb35-15"></a>}</span>
<span id="cb35-16"><a aria-hidden="true" href="#cb35-16"></a></span>
<span id="cb35-17"><a aria-hidden="true" href="#cb35-17"></a><span class="kw">inline</span> <span class="dt">int</span> max(<span class="dt">int</span> a, <span class="dt">int</span> b) { <span class="cf">return</span> a &gt; b ? a : b; }</span>
<span id="cb35-18"><a aria-hidden="true" href="#cb35-18"></a><span class="kw">inline</span> <span class="dt">int</span> min(<span class="dt">int</span> a, <span class="dt">int</span> b) { <span class="cf">return</span> a &lt; b ? a : b; }</span>
<span id="cb35-19"><a aria-hidden="true" href="#cb35-19"></a></span>
<span id="cb35-20"><a aria-hidden="true" href="#cb35-20"></a><span class="at">const</span> <span class="dt">int</span> maxn = <span class="fl">1e5</span> + <span class="dv">5</span>, inf = <span class="bn">0x3f3f3f3f</span>;</span>
<span id="cb35-21"><a aria-hidden="true" href="#cb35-21"></a><span class="dt">int</span> cnt, root;</span>
<span id="cb35-22"><a aria-hidden="true" href="#cb35-22"></a></span>
<span id="cb35-23"><a aria-hidden="true" href="#cb35-23"></a><span class="kw">struct</span> Splay {</span>
<span id="cb35-24"><a aria-hidden="true" href="#cb35-24"></a>    <span class="dt">int</span> ch[<span class="dv">2</span>], fa;</span>
<span id="cb35-25"><a aria-hidden="true" href="#cb35-25"></a>    <span class="dt">int</span> cnt, size;</span>
<span id="cb35-26"><a aria-hidden="true" href="#cb35-26"></a>    <span class="dt">int</span> val;</span>
<span id="cb35-27"><a aria-hidden="true" href="#cb35-27"></a>} t[maxn];</span>
<span id="cb35-28"><a aria-hidden="true" href="#cb35-28"></a></span>
<span id="cb35-29"><a aria-hidden="true" href="#cb35-29"></a><span class="kw">inline</span> <span class="dt">bool</span> get(<span class="dt">int</span> u) {</span>
<span id="cb35-30"><a aria-hidden="true" href="#cb35-30"></a>    <span class="cf">return</span> t[t[u].fa].ch[<span class="dv">1</span>] == u;</span>
<span id="cb35-31"><a aria-hidden="true" href="#cb35-31"></a>}</span>
<span id="cb35-32"><a aria-hidden="true" href="#cb35-32"></a></span>
<span id="cb35-33"><a aria-hidden="true" href="#cb35-33"></a><span class="kw">inline</span> <span class="dt">void</span> maintain(<span class="dt">int</span> u) {</span>
<span id="cb35-34"><a aria-hidden="true" href="#cb35-34"></a>    t[u].size = t[u].cnt + t[L].size + t[R].size;</span>
<span id="cb35-35"><a aria-hidden="true" href="#cb35-35"></a>    <span class="cf">return</span>;</span>
<span id="cb35-36"><a aria-hidden="true" href="#cb35-36"></a>}</span>
<span id="cb35-37"><a aria-hidden="true" href="#cb35-37"></a></span>
<span id="cb35-38"><a aria-hidden="true" href="#cb35-38"></a><span class="dt">void</span> rotate(<span class="dt">int</span> u) {</span>
<span id="cb35-39"><a aria-hidden="true" href="#cb35-39"></a>    <span class="dt">int</span> fa = t[u].fa, gfa = t[fa].fa;</span>
<span id="cb35-40"><a aria-hidden="true" href="#cb35-40"></a>    <span class="dt">int</span> d1 = get(u), d2 = get(fa);</span>
<span id="cb35-41"><a aria-hidden="true" href="#cb35-41"></a>    t[fa].ch[d1] = t[u].ch[d1 ^ <span class="dv">1</span>], t[t[u].ch[d1 ^ <span class="dv">1</span>]].fa = fa;</span>
<span id="cb35-42"><a aria-hidden="true" href="#cb35-42"></a>    t[gfa].ch[d2] = u, t[u].fa = gfa;</span>
<span id="cb35-43"><a aria-hidden="true" href="#cb35-43"></a>    t[fa].fa = u, t[u].ch[d1 ^ <span class="dv">1</span>] = fa;</span>
<span id="cb35-44"><a aria-hidden="true" href="#cb35-44"></a>    maintain(fa);</span>
<span id="cb35-45"><a aria-hidden="true" href="#cb35-45"></a>    maintain(u);</span>
<span id="cb35-46"><a aria-hidden="true" href="#cb35-46"></a>}</span>
<span id="cb35-47"><a aria-hidden="true" href="#cb35-47"></a></span>
<span id="cb35-48"><a aria-hidden="true" href="#cb35-48"></a><span class="dt">void</span> splay(<span class="dt">int</span> u, <span class="dt">int</span> goal) {</span>
<span id="cb35-49"><a aria-hidden="true" href="#cb35-49"></a>    <span class="cf">while</span> (t[u].fa != goal) {</span>
<span id="cb35-50"><a aria-hidden="true" href="#cb35-50"></a>        <span class="dt">int</span> fa = t[u].fa, gfa = t[fa].fa;</span>
<span id="cb35-51"><a aria-hidden="true" href="#cb35-51"></a>        <span class="dt">int</span> d1 = get(u), d2 = get(fa);</span>
<span id="cb35-52"><a aria-hidden="true" href="#cb35-52"></a>        <span class="cf">if</span> (gfa != goal) {</span>
<span id="cb35-53"><a aria-hidden="true" href="#cb35-53"></a>            <span class="cf">if</span> (d1 == d2)</span>
<span id="cb35-54"><a aria-hidden="true" href="#cb35-54"></a>                rotate(fa);</span>
<span id="cb35-55"><a aria-hidden="true" href="#cb35-55"></a>            <span class="cf">else</span></span>
<span id="cb35-56"><a aria-hidden="true" href="#cb35-56"></a>                rotate(u);</span>
<span id="cb35-57"><a aria-hidden="true" href="#cb35-57"></a>        }</span>
<span id="cb35-58"><a aria-hidden="true" href="#cb35-58"></a>        rotate(u);</span>
<span id="cb35-59"><a aria-hidden="true" href="#cb35-59"></a>    }</span>
<span id="cb35-60"><a aria-hidden="true" href="#cb35-60"></a>    <span class="cf">if</span> (goal == <span class="dv">0</span>)</span>
<span id="cb35-61"><a aria-hidden="true" href="#cb35-61"></a>        root = u;</span>
<span id="cb35-62"><a aria-hidden="true" href="#cb35-62"></a>}</span>
<span id="cb35-63"><a aria-hidden="true" href="#cb35-63"></a></span>
<span id="cb35-64"><a aria-hidden="true" href="#cb35-64"></a><span class="dt">void</span> insert(<span class="dt">int</span> val) {</span>
<span id="cb35-65"><a aria-hidden="true" href="#cb35-65"></a>    <span class="dt">int</span> u = root, fa = <span class="dv">0</span>;</span>
<span id="cb35-66"><a aria-hidden="true" href="#cb35-66"></a>    <span class="cf">while</span> (u &amp;&amp; t[u].val != val)</span>
<span id="cb35-67"><a aria-hidden="true" href="#cb35-67"></a>        fa = u, u = t[u].ch[t[u].val &lt; val];</span>
<span id="cb35-68"><a aria-hidden="true" href="#cb35-68"></a>    <span class="cf">if</span> (u)</span>
<span id="cb35-69"><a aria-hidden="true" href="#cb35-69"></a>        t[u].cnt++;</span>
<span id="cb35-70"><a aria-hidden="true" href="#cb35-70"></a>    <span class="cf">else</span> {</span>
<span id="cb35-71"><a aria-hidden="true" href="#cb35-71"></a>        u = ++cnt;</span>
<span id="cb35-72"><a aria-hidden="true" href="#cb35-72"></a>        <span class="cf">if</span> (fa)</span>
<span id="cb35-73"><a aria-hidden="true" href="#cb35-73"></a>            t[fa].ch[t[fa].val &lt; val] = u;</span>
<span id="cb35-74"><a aria-hidden="true" href="#cb35-74"></a>        t[u].fa = fa;</span>
<span id="cb35-75"><a aria-hidden="true" href="#cb35-75"></a>        t[u].size = t[u].cnt = <span class="dv">1</span>;</span>
<span id="cb35-76"><a aria-hidden="true" href="#cb35-76"></a>        t[u].val = val;</span>
<span id="cb35-77"><a aria-hidden="true" href="#cb35-77"></a>    }</span>
<span id="cb35-78"><a aria-hidden="true" href="#cb35-78"></a>    splay(u, <span class="dv">0</span>);</span>
<span id="cb35-79"><a aria-hidden="true" href="#cb35-79"></a>}</span>
<span id="cb35-80"><a aria-hidden="true" href="#cb35-80"></a></span>
<span id="cb35-81"><a aria-hidden="true" href="#cb35-81"></a><span class="dt">int</span> find(<span class="dt">int</span> val) {</span>
<span id="cb35-82"><a aria-hidden="true" href="#cb35-82"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb35-83"><a aria-hidden="true" href="#cb35-83"></a>    <span class="cf">while</span> (t[u].val != val &amp;&amp; t[u].ch[t[u].val &lt; val])</span>
<span id="cb35-84"><a aria-hidden="true" href="#cb35-84"></a>        u = t[u].ch[t[u].val &lt; val];</span>
<span id="cb35-85"><a aria-hidden="true" href="#cb35-85"></a>    <span class="cf">return</span> u;</span>
<span id="cb35-86"><a aria-hidden="true" href="#cb35-86"></a>}</span>
<span id="cb35-87"><a aria-hidden="true" href="#cb35-87"></a></span>
<span id="cb35-88"><a aria-hidden="true" href="#cb35-88"></a><span class="dt">int</span> rank(<span class="dt">int</span> val) {</span>
<span id="cb35-89"><a aria-hidden="true" href="#cb35-89"></a>    splay(find(val), <span class="dv">0</span>);</span>
<span id="cb35-90"><a aria-hidden="true" href="#cb35-90"></a>    <span class="cf">return</span> t[t[root].ch[<span class="dv">0</span>]].size + <span class="dv">1</span>;</span>
<span id="cb35-91"><a aria-hidden="true" href="#cb35-91"></a>}</span>
<span id="cb35-92"><a aria-hidden="true" href="#cb35-92"></a></span>
<span id="cb35-93"><a aria-hidden="true" href="#cb35-93"></a><span class="dt">int</span> kth(<span class="dt">int</span> k) {</span>
<span id="cb35-94"><a aria-hidden="true" href="#cb35-94"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb35-95"><a aria-hidden="true" href="#cb35-95"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb35-96"><a aria-hidden="true" href="#cb35-96"></a>        <span class="cf">if</span> (k &lt;= t[L].size)</span>
<span id="cb35-97"><a aria-hidden="true" href="#cb35-97"></a>            u = L;</span>
<span id="cb35-98"><a aria-hidden="true" href="#cb35-98"></a>        <span class="cf">else</span> <span class="cf">if</span> (k &gt; t[L].size + t[u].cnt) {</span>
<span id="cb35-99"><a aria-hidden="true" href="#cb35-99"></a>            k -= t[L].size + t[u].cnt;</span>
<span id="cb35-100"><a aria-hidden="true" href="#cb35-100"></a>            u = R;</span>
<span id="cb35-101"><a aria-hidden="true" href="#cb35-101"></a>        }</span>
<span id="cb35-102"><a aria-hidden="true" href="#cb35-102"></a>        <span class="cf">else</span></span>
<span id="cb35-103"><a aria-hidden="true" href="#cb35-103"></a>            <span class="cf">return</span> t[u].val;</span>
<span id="cb35-104"><a aria-hidden="true" href="#cb35-104"></a>    }</span>
<span id="cb35-105"><a aria-hidden="true" href="#cb35-105"></a>}</span>
<span id="cb35-106"><a aria-hidden="true" href="#cb35-106"></a></span>
<span id="cb35-107"><a aria-hidden="true" href="#cb35-107"></a><span class="dt">int</span> getnxt(<span class="dt">int</span> val, <span class="dt">int</span> opt) {</span>
<span id="cb35-108"><a aria-hidden="true" href="#cb35-108"></a>    splay(find(val), <span class="dv">0</span>);</span>
<span id="cb35-109"><a aria-hidden="true" href="#cb35-109"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb35-110"><a aria-hidden="true" href="#cb35-110"></a>    <span class="cf">if</span> (t[u].val &lt; val &amp;&amp; (!opt))</span>
<span id="cb35-111"><a aria-hidden="true" href="#cb35-111"></a>        <span class="cf">return</span> u;</span>
<span id="cb35-112"><a aria-hidden="true" href="#cb35-112"></a>    <span class="cf">if</span> (t[u].val &gt; val &amp;&amp; opt)</span>
<span id="cb35-113"><a aria-hidden="true" href="#cb35-113"></a>        <span class="cf">return</span> u;</span>
<span id="cb35-114"><a aria-hidden="true" href="#cb35-114"></a>    u = t[u].ch[opt];</span>
<span id="cb35-115"><a aria-hidden="true" href="#cb35-115"></a>    <span class="cf">while</span> (t[u].ch[opt ^ <span class="dv">1</span>])</span>
<span id="cb35-116"><a aria-hidden="true" href="#cb35-116"></a>        u = t[u].ch[opt ^ <span class="dv">1</span>];</span>
<span id="cb35-117"><a aria-hidden="true" href="#cb35-117"></a>    <span class="cf">return</span> u;</span>
<span id="cb35-118"><a aria-hidden="true" href="#cb35-118"></a>}</span>
<span id="cb35-119"><a aria-hidden="true" href="#cb35-119"></a></span>
<span id="cb35-120"><a aria-hidden="true" href="#cb35-120"></a><span class="dt">void</span> delnode(<span class="dt">int</span> val) {</span>
<span id="cb35-121"><a aria-hidden="true" href="#cb35-121"></a>    <span class="dt">int</span> pre = getnxt(val, <span class="dv">0</span>);</span>
<span id="cb35-122"><a aria-hidden="true" href="#cb35-122"></a>    <span class="dt">int</span> suc = getnxt(val, <span class="dv">1</span>);</span>
<span id="cb35-123"><a aria-hidden="true" href="#cb35-123"></a>    splay(pre, <span class="dv">0</span>);</span>
<span id="cb35-124"><a aria-hidden="true" href="#cb35-124"></a>    splay(suc, pre);</span>
<span id="cb35-125"><a aria-hidden="true" href="#cb35-125"></a>    <span class="cf">if</span> (t[t[suc].ch[<span class="dv">0</span>]].cnt &gt; <span class="dv">1</span>) {</span>
<span id="cb35-126"><a aria-hidden="true" href="#cb35-126"></a>        t[t[suc].ch[<span class="dv">0</span>]].cnt--;</span>
<span id="cb35-127"><a aria-hidden="true" href="#cb35-127"></a>        splay(t[suc].ch[<span class="dv">0</span>], <span class="dv">0</span>);</span>
<span id="cb35-128"><a aria-hidden="true" href="#cb35-128"></a>    }</span>
<span id="cb35-129"><a aria-hidden="true" href="#cb35-129"></a>    <span class="cf">else</span> t[suc].ch[<span class="dv">0</span>] = <span class="dv">0</span>;</span>
<span id="cb35-130"><a aria-hidden="true" href="#cb35-130"></a>    <span class="cf">return</span>;</span>
<span id="cb35-131"><a aria-hidden="true" href="#cb35-131"></a>}</span>
<span id="cb35-132"><a aria-hidden="true" href="#cb35-132"></a></span>
<span id="cb35-133"><a aria-hidden="true" href="#cb35-133"></a><span class="dt">int</span> main() {</span>
<span id="cb35-134"><a aria-hidden="true" href="#cb35-134"></a>    insert(inf), insert(-inf);</span>
<span id="cb35-135"><a aria-hidden="true" href="#cb35-135"></a>    <span class="dt">int</span> n = read();</span>
<span id="cb35-136"><a aria-hidden="true" href="#cb35-136"></a>    <span class="cf">while</span> (n--) {</span>
<span id="cb35-137"><a aria-hidden="true" href="#cb35-137"></a>        <span class="dt">int</span> opt = read(), x = read();</span>
<span id="cb35-138"><a aria-hidden="true" href="#cb35-138"></a>        <span class="cf">switch</span> (opt) {</span>
<span id="cb35-139"><a aria-hidden="true" href="#cb35-139"></a>        <span class="cf">case</span> <span class="dv">1</span>:</span>
<span id="cb35-140"><a aria-hidden="true" href="#cb35-140"></a>            insert(x);</span>
<span id="cb35-141"><a aria-hidden="true" href="#cb35-141"></a>            <span class="cf">break</span>;</span>
<span id="cb35-142"><a aria-hidden="true" href="#cb35-142"></a>        <span class="cf">case</span> <span class="dv">2</span>:</span>
<span id="cb35-143"><a aria-hidden="true" href="#cb35-143"></a>            delnode(x);</span>
<span id="cb35-144"><a aria-hidden="true" href="#cb35-144"></a>            <span class="cf">break</span>;</span>
<span id="cb35-145"><a aria-hidden="true" href="#cb35-145"></a>        <span class="cf">case</span> <span class="dv">3</span>:</span>
<span id="cb35-146"><a aria-hidden="true" href="#cb35-146"></a>            printf(<span class="st">"</span><span class="sc">%d\n</span><span class="st">"</span>, rank(x) - <span class="dv">1</span>);</span>
<span id="cb35-147"><a aria-hidden="true" href="#cb35-147"></a>            <span class="cf">break</span>;</span>
<span id="cb35-148"><a aria-hidden="true" href="#cb35-148"></a>        <span class="cf">case</span> <span class="dv">4</span>:</span>
<span id="cb35-149"><a aria-hidden="true" href="#cb35-149"></a>            printf(<span class="st">"</span><span class="sc">%d\n</span><span class="st">"</span>, kth(x+<span class="dv">1</span>));</span>
<span id="cb35-150"><a aria-hidden="true" href="#cb35-150"></a>            <span class="cf">break</span>;</span>
<span id="cb35-151"><a aria-hidden="true" href="#cb35-151"></a>        <span class="cf">case</span> <span class="dv">5</span>:</span>
<span id="cb35-152"><a aria-hidden="true" href="#cb35-152"></a>            printf(<span class="st">"</span><span class="sc">%d\n</span><span class="st">"</span>, t[getnxt(x, <span class="dv">0</span>)].val);</span>
<span id="cb35-153"><a aria-hidden="true" href="#cb35-153"></a>            <span class="cf">break</span>;</span>
<span id="cb35-154"><a aria-hidden="true" href="#cb35-154"></a>        <span class="cf">case</span> <span class="dv">6</span>:</span>
<span id="cb35-155"><a aria-hidden="true" href="#cb35-155"></a>            printf(<span class="st">"</span><span class="sc">%d\n</span><span class="st">"</span>, t[getnxt(x, <span class="dv">1</span>)].val);</span>
<span id="cb35-156"><a aria-hidden="true" href="#cb35-156"></a>            <span class="cf">break</span>;</span>
<span id="cb35-157"><a aria-hidden="true" href="#cb35-157"></a>        }</span>
<span id="cb35-158"><a aria-hidden="true" href="#cb35-158"></a>    }</span>
<span id="cb35-159"><a aria-hidden="true" href="#cb35-159"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb35-160"><a aria-hidden="true" href="#cb35-160"></a>}</span></code></pre></div>
<h3 id="å‰é©±åç»§åˆ é™¤æ“ä½œçš„å¦ä¸€ç§å®ç°">å‰é©±åç»§/åˆ é™¤æ“ä½œçš„å¦ä¸€ç§å®ç°</h3>
<p>å…¶å®å¯¹äºæŸ¥è¯¢å‰é©±/åç»§ï¼Œæˆ‘ä»¬ä¹Ÿå¯ä»¥å…ˆæ’å…¥ <span class="math inline">\(val\)</span>ï¼ˆæ’å…¥åå®ƒå°±ä¼šè¢« splay æˆæ ¹ï¼‰ï¼Œç„¶ååœ¨å…¶å·¦/å³å­æ ‘ä¸­æŸ¥è¯¢å‰é©±/åç»§ï¼Œæœ€åå®Œäº‹äº†åˆ é™¤ <span class="math inline">\(val\)</span> å°±è¡Œäº†ï¼ˆ<span class="math inline">\(val\)</span> å·¥å…·äººè¡¨ç¤ºå¾ˆæ·¦ï¼‰ã€‚</p>
<p>ä½†é—®é¢˜æ˜¯ï¼Œåˆ é™¤æ€ä¹ˆåŠï¼Œæ­¤æ—¶è¦å®Œæˆå‰é©±åç»§æ“ä½œå°±éœ€è¦å…ˆå­¦ä¼šåˆ é™¤ã€‚</p>
<p>æ­¤å¤„ä¸å¦¨æŠŠ <span class="math inline">\(val\)</span> splay åˆ°æ ¹ï¼Œç„¶ååˆ†ä¸¤ç§æƒ…å†µè®¨è®ºï¼š</p>
<ul>
<li>å¦‚æœå·¦/å³å­æ ‘è‡³å°‘æœ‰ä¸€ä¸ªæ˜¯ç©ºçš„è¯ï¼Œç›´æ¥è®©ä¸ç©ºçš„é‚£ä¸ªèŠ‚ç‚¹å½“æ ¹å°±å¯ä»¥äº†ï¼ˆå¦‚æœåˆ å¹²å‡€äº†å°±åˆ å¹²å‡€äº†å§ï¼‰</li>
<li>å¦‚æœå·¦å³å­æ ‘éƒ½ä¸ä¸ºç©ºï¼Œåˆ™ç›¸å½“äºè¦åˆå¹¶ä¸¤æ£µ Splayï¼Œæ€ä¹ˆåŠå‘¢ï¼Œè€ƒè™‘æ€ä¹ˆç»´æŠ¤ Splay çš„æ€§è´¨ï¼š</li>
</ul>
<p>æˆ‘ä»¬å¯ä»¥å°†å·¦å­æ ‘æœ€å¤§çš„èŠ‚ç‚¹ Splay åˆ°æœ€ä¸Šæ–¹ï¼Œç„¶åæ³¨æ„åˆ°<strong>æ­¤æ—¶æ ¹çš„å·¦å„¿å­è‚¯å®šæ²¡æœ‰å³å„¿å­äº†</strong>ã€‚æ‰€ä»¥ç›´æ¥æŠŠæ ¹çš„å³å­æ ‘æ¥åˆ°æ ¹çš„å·¦å„¿å­çš„å³å„¿å­ä¸Šï¼Œç„¶åè®©å·¦å„¿å­å½“æ ¹ï¼Œæ ¹å°±ç›´æ¥æ»šè›‹äº†ã€‚è§‰å¾—æŠ½è±¡çš„å¯ä»¥çœ‹ä¸€ä¸‹ä¸‹é¢çš„å›¾ï¼š</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_del1.png"/><figcaption>å°†å¾…åˆ é™¤èŠ‚ç‚¹ splay åˆ°æ ¹å</figcaption>
</figure>
<p>è¿™æ˜¯å°†å¾…åˆ é™¤èŠ‚ç‚¹ splay åˆ°æ ¹åï¼Œç„¶åæˆ‘ä»¬æŠŠå·¦å­æ ‘çš„æœ€å¤§å€¼ splay åˆ°å·¦å­æ ‘çš„æ ¹ï¼Œè¿™æ ·å·¦å­æ ‘å°±ä¸å­˜åœ¨å³å­æ ‘äº†ï¼Œå°†åŸæ¥æ ¹çš„å³å­æ ‘æ¥ä¸Šå»å³å¯ã€‚</p>
<figure>
<img alt="" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/splay_del2.png"/><figcaption>å®Œæˆä¹‹å</figcaption>
</figure>
<p>åŸæ¥çš„æ ¹èŠ‚ç‚¹å°±å¯ä»¥ä¸¢æ‰ä¸è¦äº†ï¼ŒåŒæ—¶ä¸è¦å¿˜è®°å†æ›´æ–°æ ¹çš„å€¼ã€‚</p>
<p>ä»£ç å¦‚ä¸‹ï¼šï¼ˆæ­¤æ—¶ <code>getnxt()</code> è¿”å›çš„æ˜¯ç­”æ¡ˆäº†ï¼‰</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb36-1"><a aria-hidden="true" href="#cb36-1"></a><span class="dt">void</span> delnode(<span class="dt">int</span> val) {</span>
<span id="cb36-2"><a aria-hidden="true" href="#cb36-2"></a>    splay(find(val), <span class="dv">0</span>);<span class="co">//æŠŠå¾…åˆ é™¤èŠ‚ç‚¹æ—‹è½¬åˆ°æ ¹</span></span>
<span id="cb36-3"><a aria-hidden="true" href="#cb36-3"></a>    <span class="cf">if</span> (t[root].val != val)</span>
<span id="cb36-4"><a aria-hidden="true" href="#cb36-4"></a>        <span class="cf">return</span>;</span>
<span id="cb36-5"><a aria-hidden="true" href="#cb36-5"></a>    <span class="cf">if</span> (t[root].cnt &gt; <span class="dv">1</span>)</span>
<span id="cb36-6"><a aria-hidden="true" href="#cb36-6"></a>    {</span>
<span id="cb36-7"><a aria-hidden="true" href="#cb36-7"></a>        t[root].cnt--;</span>
<span id="cb36-8"><a aria-hidden="true" href="#cb36-8"></a>        t[root].size--;</span>
<span id="cb36-9"><a aria-hidden="true" href="#cb36-9"></a>        <span class="cf">return</span>;</span>
<span id="cb36-10"><a aria-hidden="true" href="#cb36-10"></a>    }</span>
<span id="cb36-11"><a aria-hidden="true" href="#cb36-11"></a>    <span class="cf">if</span> ((!t[root].ch[<span class="dv">0</span>]) || (!t[root].ch[<span class="dv">1</span>]))</span>
<span id="cb36-12"><a aria-hidden="true" href="#cb36-12"></a>        root = t[root].ch[<span class="dv">0</span>] + t[root].ch[<span class="dv">1</span>];</span>
<span id="cb36-13"><a aria-hidden="true" href="#cb36-13"></a>    <span class="cf">else</span> {</span>
<span id="cb36-14"><a aria-hidden="true" href="#cb36-14"></a>        <span class="dt">int</span> lmax = t[root].ch[<span class="dv">0</span>];</span>
<span id="cb36-15"><a aria-hidden="true" href="#cb36-15"></a>        <span class="cf">while</span> (t[lmax].ch[<span class="dv">1</span>])</span>
<span id="cb36-16"><a aria-hidden="true" href="#cb36-16"></a>            lmax = t[lmax].ch[<span class="dv">1</span>];</span>
<span id="cb36-17"><a aria-hidden="true" href="#cb36-17"></a>        splay(lmax, root);</span>
<span id="cb36-18"><a aria-hidden="true" href="#cb36-18"></a>        t[t[root].ch[<span class="dv">1</span>]].fa = lmax;</span>
<span id="cb36-19"><a aria-hidden="true" href="#cb36-19"></a>        t[lmax].ch[<span class="dv">1</span>] = t[root].ch[<span class="dv">1</span>];</span>
<span id="cb36-20"><a aria-hidden="true" href="#cb36-20"></a>        maintain(root = lmax);</span>
<span id="cb36-21"><a aria-hidden="true" href="#cb36-21"></a>    }</span>
<span id="cb36-22"><a aria-hidden="true" href="#cb36-22"></a>    t[root].fa = <span class="dv">0</span>;<span class="co">//åƒä¸‡ä¸è¦å¿˜è®°æŠŠæ ¹çš„ fa è®¾ä¸º 0</span></span>
<span id="cb36-23"><a aria-hidden="true" href="#cb36-23"></a>    <span class="cf">return</span>;</span>
<span id="cb36-24"><a aria-hidden="true" href="#cb36-24"></a>}</span>
<span id="cb36-25"><a aria-hidden="true" href="#cb36-25"></a></span>
<span id="cb36-26"><a aria-hidden="true" href="#cb36-26"></a><span class="dt">int</span> getnxt(<span class="dt">int</span> val,<span class="dt">int</span> opt) {</span>
<span id="cb36-27"><a aria-hidden="true" href="#cb36-27"></a>    insert(val);</span>
<span id="cb36-28"><a aria-hidden="true" href="#cb36-28"></a>    <span class="dt">int</span> u = t[root].ch[opt], ans = t[u].val;</span>
<span id="cb36-29"><a aria-hidden="true" href="#cb36-29"></a>    <span class="cf">while</span> (t[u].ch[opt ^ <span class="dv">1</span>])</span>
<span id="cb36-30"><a aria-hidden="true" href="#cb36-30"></a>        u = t[u].ch[opt ^ <span class="dv">1</span>], ans = t[u].val;</span>
<span id="cb36-31"><a aria-hidden="true" href="#cb36-31"></a>    delnode(val);</span>
<span id="cb36-32"><a aria-hidden="true" href="#cb36-32"></a>    <span class="cf">return</span> ans;</span>
<span id="cb36-33"><a aria-hidden="true" href="#cb36-33"></a>}</span></code></pre></div>
<h3 id="æ™®é€šå¹³è¡¡æ ‘çš„å¦å¤–ä¸€ç§å®ç°">æ™®é€šå¹³è¡¡æ ‘çš„å¦å¤–ä¸€ç§å®ç°</h3>
<p><a href="https://www.luogu.com.cn/problem/P6136">æ´›è°·P6136</a> çš„å®ç°ï¼š<strong>è¿™ä¸ªç‰ˆæœ¬å¯ä»¥è¾ƒå¥½çš„å¤„ç†æŸ¥è¯¢å‰é©±/åç»§/æ’åæ—¶å¾…æŸ¥è¯¢æ•°ä¸å­˜åœ¨çš„æƒ…å†µ</strong></p>
<div class="sourceCode" id="cb37"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb37-1"><a aria-hidden="true" href="#cb37-1"></a><span class="pp">#include </span><span class="im">&lt;cstdio&gt;</span></span>
<span id="cb37-2"><a aria-hidden="true" href="#cb37-2"></a><span class="pp">#include </span><span class="im">&lt;cctype&gt;</span></span>
<span id="cb37-3"><a aria-hidden="true" href="#cb37-3"></a><span class="pp">#define L </span>t[u].ch[<span class="dv">0</span>]</span>
<span id="cb37-4"><a aria-hidden="true" href="#cb37-4"></a><span class="pp">#define R </span>t[u].ch[<span class="dv">1</span>]</span>
<span id="cb37-5"><a aria-hidden="true" href="#cb37-5"></a></span>
<span id="cb37-6"><a aria-hidden="true" href="#cb37-6"></a><span class="kw">inline</span> <span class="dt">int</span> read() {</span>
<span id="cb37-7"><a aria-hidden="true" href="#cb37-7"></a>    <span class="dt">char</span> c = getchar();</span>
<span id="cb37-8"><a aria-hidden="true" href="#cb37-8"></a>    <span class="dt">int</span> s = <span class="dv">0</span>;</span>
<span id="cb37-9"><a aria-hidden="true" href="#cb37-9"></a>    <span class="dt">bool</span> x = <span class="dv">0</span>;</span>
<span id="cb37-10"><a aria-hidden="true" href="#cb37-10"></a>    <span class="cf">while</span> (!isdigit(c))</span>
<span id="cb37-11"><a aria-hidden="true" href="#cb37-11"></a>        x = x | (c == <span class="ch">'-'</span>), c = getchar();</span>
<span id="cb37-12"><a aria-hidden="true" href="#cb37-12"></a>    <span class="cf">while</span> (isdigit(c))</span>
<span id="cb37-13"><a aria-hidden="true" href="#cb37-13"></a>        s = <span class="dv">10</span> * s + c - <span class="ch">'0'</span>, c = getchar();</span>
<span id="cb37-14"><a aria-hidden="true" href="#cb37-14"></a>    <span class="cf">return</span> x ? -s : s;</span>
<span id="cb37-15"><a aria-hidden="true" href="#cb37-15"></a>}</span>
<span id="cb37-16"><a aria-hidden="true" href="#cb37-16"></a></span>
<span id="cb37-17"><a aria-hidden="true" href="#cb37-17"></a><span class="kw">inline</span> <span class="dt">int</span> max(<span class="dt">int</span> a, <span class="dt">int</span> b) { <span class="cf">return</span> a &gt; b ? a : b; }</span>
<span id="cb37-18"><a aria-hidden="true" href="#cb37-18"></a><span class="kw">inline</span> <span class="dt">int</span> min(<span class="dt">int</span> a, <span class="dt">int</span> b) { <span class="cf">return</span> a &lt; b ? a : b; }</span>
<span id="cb37-19"><a aria-hidden="true" href="#cb37-19"></a></span>
<span id="cb37-20"><a aria-hidden="true" href="#cb37-20"></a><span class="at">const</span> <span class="dt">int</span> maxn = <span class="fl">2e6</span> + <span class="dv">5</span>, inf = <span class="dv">2147483647</span> - <span class="dv">20</span>;</span>
<span id="cb37-21"><a aria-hidden="true" href="#cb37-21"></a><span class="dt">int</span> cnt, root;</span>
<span id="cb37-22"><a aria-hidden="true" href="#cb37-22"></a></span>
<span id="cb37-23"><a aria-hidden="true" href="#cb37-23"></a><span class="kw">struct</span> Splay {</span>
<span id="cb37-24"><a aria-hidden="true" href="#cb37-24"></a>    <span class="dt">int</span> ch[<span class="dv">2</span>], fa;</span>
<span id="cb37-25"><a aria-hidden="true" href="#cb37-25"></a>    <span class="dt">int</span> cnt, size;</span>
<span id="cb37-26"><a aria-hidden="true" href="#cb37-26"></a>    <span class="dt">int</span> val;</span>
<span id="cb37-27"><a aria-hidden="true" href="#cb37-27"></a>} t[maxn];</span>
<span id="cb37-28"><a aria-hidden="true" href="#cb37-28"></a></span>
<span id="cb37-29"><a aria-hidden="true" href="#cb37-29"></a><span class="kw">inline</span> <span class="dt">bool</span> get(<span class="dt">int</span> u) {</span>
<span id="cb37-30"><a aria-hidden="true" href="#cb37-30"></a>    <span class="cf">return</span> t[t[u].fa].ch[<span class="dv">1</span>] == u;</span>
<span id="cb37-31"><a aria-hidden="true" href="#cb37-31"></a>}</span>
<span id="cb37-32"><a aria-hidden="true" href="#cb37-32"></a></span>
<span id="cb37-33"><a aria-hidden="true" href="#cb37-33"></a><span class="kw">inline</span> <span class="dt">void</span> maintain(<span class="dt">int</span> u) {</span>
<span id="cb37-34"><a aria-hidden="true" href="#cb37-34"></a>    t[u].size = t[u].cnt + t[L].size + t[R].size;</span>
<span id="cb37-35"><a aria-hidden="true" href="#cb37-35"></a>    <span class="cf">return</span>;</span>
<span id="cb37-36"><a aria-hidden="true" href="#cb37-36"></a>}</span>
<span id="cb37-37"><a aria-hidden="true" href="#cb37-37"></a></span>
<span id="cb37-38"><a aria-hidden="true" href="#cb37-38"></a><span class="dt">void</span> rotate(<span class="dt">int</span> u) {</span>
<span id="cb37-39"><a aria-hidden="true" href="#cb37-39"></a>    <span class="dt">int</span> fa = t[u].fa, gfa = t[fa].fa;</span>
<span id="cb37-40"><a aria-hidden="true" href="#cb37-40"></a>    <span class="dt">int</span> d1 = get(u), d2 = get(fa);</span>
<span id="cb37-41"><a aria-hidden="true" href="#cb37-41"></a>    t[fa].ch[d1] = t[u].ch[d1 ^ <span class="dv">1</span>], t[t[u].ch[d1 ^ <span class="dv">1</span>]].fa = fa;</span>
<span id="cb37-42"><a aria-hidden="true" href="#cb37-42"></a>    <span class="cf">if</span> (gfa)</span>
<span id="cb37-43"><a aria-hidden="true" href="#cb37-43"></a>        t[gfa].ch[d2] = u;</span>
<span id="cb37-44"><a aria-hidden="true" href="#cb37-44"></a>    t[u].fa = gfa;</span>
<span id="cb37-45"><a aria-hidden="true" href="#cb37-45"></a>    t[fa].fa = u, t[u].ch[d1 ^ <span class="dv">1</span>] = fa;</span>
<span id="cb37-46"><a aria-hidden="true" href="#cb37-46"></a>    maintain(fa);</span>
<span id="cb37-47"><a aria-hidden="true" href="#cb37-47"></a>    maintain(u);</span>
<span id="cb37-48"><a aria-hidden="true" href="#cb37-48"></a>}</span>
<span id="cb37-49"><a aria-hidden="true" href="#cb37-49"></a></span>
<span id="cb37-50"><a aria-hidden="true" href="#cb37-50"></a><span class="dt">void</span> splay(<span class="dt">int</span> u, <span class="dt">int</span> goal) {</span>
<span id="cb37-51"><a aria-hidden="true" href="#cb37-51"></a>    <span class="cf">while</span> (t[u].fa != goal) {</span>
<span id="cb37-52"><a aria-hidden="true" href="#cb37-52"></a>        <span class="dt">int</span> fa = t[u].fa, gfa = t[fa].fa;</span>
<span id="cb37-53"><a aria-hidden="true" href="#cb37-53"></a>        <span class="dt">int</span> d1 = get(u), d2 = get(fa);</span>
<span id="cb37-54"><a aria-hidden="true" href="#cb37-54"></a>        <span class="cf">if</span> (gfa != goal) {</span>
<span id="cb37-55"><a aria-hidden="true" href="#cb37-55"></a>            <span class="cf">if</span> (d1 == d2)</span>
<span id="cb37-56"><a aria-hidden="true" href="#cb37-56"></a>                rotate(fa);</span>
<span id="cb37-57"><a aria-hidden="true" href="#cb37-57"></a>            <span class="cf">else</span></span>
<span id="cb37-58"><a aria-hidden="true" href="#cb37-58"></a>                rotate(u);</span>
<span id="cb37-59"><a aria-hidden="true" href="#cb37-59"></a>        }</span>
<span id="cb37-60"><a aria-hidden="true" href="#cb37-60"></a>        rotate(u);</span>
<span id="cb37-61"><a aria-hidden="true" href="#cb37-61"></a>    }</span>
<span id="cb37-62"><a aria-hidden="true" href="#cb37-62"></a>    <span class="cf">if</span> (goal == <span class="dv">0</span>)</span>
<span id="cb37-63"><a aria-hidden="true" href="#cb37-63"></a>        root = u;</span>
<span id="cb37-64"><a aria-hidden="true" href="#cb37-64"></a>}</span>
<span id="cb37-65"><a aria-hidden="true" href="#cb37-65"></a></span>
<span id="cb37-66"><a aria-hidden="true" href="#cb37-66"></a><span class="dt">void</span> insert(<span class="dt">int</span> val) {</span>
<span id="cb37-67"><a aria-hidden="true" href="#cb37-67"></a>    <span class="dt">int</span> u = root, fa = <span class="dv">0</span>;</span>
<span id="cb37-68"><a aria-hidden="true" href="#cb37-68"></a>    <span class="cf">while</span> (u &amp;&amp; t[u].val != val)</span>
<span id="cb37-69"><a aria-hidden="true" href="#cb37-69"></a>        fa = u, u = t[u].ch[t[u].val &lt; val];</span>
<span id="cb37-70"><a aria-hidden="true" href="#cb37-70"></a>    <span class="cf">if</span> (u)</span>
<span id="cb37-71"><a aria-hidden="true" href="#cb37-71"></a>        t[u].cnt++;</span>
<span id="cb37-72"><a aria-hidden="true" href="#cb37-72"></a>    <span class="cf">else</span> {</span>
<span id="cb37-73"><a aria-hidden="true" href="#cb37-73"></a>        u = ++cnt;</span>
<span id="cb37-74"><a aria-hidden="true" href="#cb37-74"></a>        <span class="cf">if</span> (fa)</span>
<span id="cb37-75"><a aria-hidden="true" href="#cb37-75"></a>            t[fa].ch[t[fa].val &lt; val] = u;</span>
<span id="cb37-76"><a aria-hidden="true" href="#cb37-76"></a>        t[u].fa = fa;</span>
<span id="cb37-77"><a aria-hidden="true" href="#cb37-77"></a>        t[u].size = t[u].cnt = <span class="dv">1</span>;</span>
<span id="cb37-78"><a aria-hidden="true" href="#cb37-78"></a>        t[u].val = val;</span>
<span id="cb37-79"><a aria-hidden="true" href="#cb37-79"></a>    }</span>
<span id="cb37-80"><a aria-hidden="true" href="#cb37-80"></a>    splay(u, <span class="dv">0</span>);</span>
<span id="cb37-81"><a aria-hidden="true" href="#cb37-81"></a>}</span>
<span id="cb37-82"><a aria-hidden="true" href="#cb37-82"></a></span>
<span id="cb37-83"><a aria-hidden="true" href="#cb37-83"></a><span class="dt">int</span> find(<span class="dt">int</span> val) {</span>
<span id="cb37-84"><a aria-hidden="true" href="#cb37-84"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb37-85"><a aria-hidden="true" href="#cb37-85"></a>    <span class="cf">while</span> (t[u].val != val &amp;&amp; t[u].ch[t[u].val &lt; val])</span>
<span id="cb37-86"><a aria-hidden="true" href="#cb37-86"></a>        u = t[u].ch[t[u].val &lt; val];</span>
<span id="cb37-87"><a aria-hidden="true" href="#cb37-87"></a>    <span class="cf">return</span> u;</span>
<span id="cb37-88"><a aria-hidden="true" href="#cb37-88"></a>}</span>
<span id="cb37-89"><a aria-hidden="true" href="#cb37-89"></a></span>
<span id="cb37-90"><a aria-hidden="true" href="#cb37-90"></a><span class="dt">int</span> kth(<span class="dt">int</span> k) {</span>
<span id="cb37-91"><a aria-hidden="true" href="#cb37-91"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb37-92"><a aria-hidden="true" href="#cb37-92"></a>    <span class="cf">while</span> (<span class="kw">true</span>) {</span>
<span id="cb37-93"><a aria-hidden="true" href="#cb37-93"></a>        <span class="cf">if</span> (k &lt;= t[L].size)</span>
<span id="cb37-94"><a aria-hidden="true" href="#cb37-94"></a>            u = L;</span>
<span id="cb37-95"><a aria-hidden="true" href="#cb37-95"></a>        <span class="cf">else</span> <span class="cf">if</span> (k &gt; t[L].size + t[u].cnt) {</span>
<span id="cb37-96"><a aria-hidden="true" href="#cb37-96"></a>            k -= t[L].size + t[u].cnt;</span>
<span id="cb37-97"><a aria-hidden="true" href="#cb37-97"></a>            u = R;</span>
<span id="cb37-98"><a aria-hidden="true" href="#cb37-98"></a>        }</span>
<span id="cb37-99"><a aria-hidden="true" href="#cb37-99"></a>        <span class="cf">else</span></span>
<span id="cb37-100"><a aria-hidden="true" href="#cb37-100"></a>            <span class="cf">return</span> t[u].val;</span>
<span id="cb37-101"><a aria-hidden="true" href="#cb37-101"></a>    }</span>
<span id="cb37-102"><a aria-hidden="true" href="#cb37-102"></a>}</span>
<span id="cb37-103"><a aria-hidden="true" href="#cb37-103"></a></span>
<span id="cb37-104"><a aria-hidden="true" href="#cb37-104"></a><span class="dt">void</span> delnode(<span class="dt">int</span> val) {</span>
<span id="cb37-105"><a aria-hidden="true" href="#cb37-105"></a>    splay(find(val), <span class="dv">0</span>);</span>
<span id="cb37-106"><a aria-hidden="true" href="#cb37-106"></a>    <span class="cf">if</span> (t[root].val != val)</span>
<span id="cb37-107"><a aria-hidden="true" href="#cb37-107"></a>        <span class="cf">return</span>;</span>
<span id="cb37-108"><a aria-hidden="true" href="#cb37-108"></a>    <span class="cf">if</span> (t[root].cnt &gt; <span class="dv">1</span>) {</span>
<span id="cb37-109"><a aria-hidden="true" href="#cb37-109"></a>        t[root].cnt--;</span>
<span id="cb37-110"><a aria-hidden="true" href="#cb37-110"></a>        t[root].size--;</span>
<span id="cb37-111"><a aria-hidden="true" href="#cb37-111"></a>        <span class="cf">return</span>;</span>
<span id="cb37-112"><a aria-hidden="true" href="#cb37-112"></a>    }</span>
<span id="cb37-113"><a aria-hidden="true" href="#cb37-113"></a>    <span class="cf">if</span> ((!t[root].ch[<span class="dv">0</span>]) || (!t[root].ch[<span class="dv">1</span>]))</span>
<span id="cb37-114"><a aria-hidden="true" href="#cb37-114"></a>        root = t[root].ch[<span class="dv">0</span>] + t[root].ch[<span class="dv">1</span>];</span>
<span id="cb37-115"><a aria-hidden="true" href="#cb37-115"></a>    <span class="cf">else</span> {</span>
<span id="cb37-116"><a aria-hidden="true" href="#cb37-116"></a>        <span class="dt">int</span> lmax = t[root].ch[<span class="dv">0</span>];</span>
<span id="cb37-117"><a aria-hidden="true" href="#cb37-117"></a>        <span class="cf">while</span> (t[lmax].ch[<span class="dv">1</span>])</span>
<span id="cb37-118"><a aria-hidden="true" href="#cb37-118"></a>            lmax = t[lmax].ch[<span class="dv">1</span>];</span>
<span id="cb37-119"><a aria-hidden="true" href="#cb37-119"></a>        splay(lmax, root);</span>
<span id="cb37-120"><a aria-hidden="true" href="#cb37-120"></a>        t[t[root].ch[<span class="dv">1</span>]].fa = lmax;</span>
<span id="cb37-121"><a aria-hidden="true" href="#cb37-121"></a>        t[lmax].ch[<span class="dv">1</span>] = t[root].ch[<span class="dv">1</span>];</span>
<span id="cb37-122"><a aria-hidden="true" href="#cb37-122"></a>        maintain(root = lmax);</span>
<span id="cb37-123"><a aria-hidden="true" href="#cb37-123"></a>    }</span>
<span id="cb37-124"><a aria-hidden="true" href="#cb37-124"></a>    t[root].fa = <span class="dv">0</span>;</span>
<span id="cb37-125"><a aria-hidden="true" href="#cb37-125"></a>    <span class="cf">return</span>;</span>
<span id="cb37-126"><a aria-hidden="true" href="#cb37-126"></a>}</span>
<span id="cb37-127"><a aria-hidden="true" href="#cb37-127"></a></span>
<span id="cb37-128"><a aria-hidden="true" href="#cb37-128"></a><span class="dt">int</span> rank(<span class="dt">int</span> val) {</span>
<span id="cb37-129"><a aria-hidden="true" href="#cb37-129"></a>    insert(val);</span>
<span id="cb37-130"><a aria-hidden="true" href="#cb37-130"></a>    <span class="dt">int</span> ans = t[t[root].ch[<span class="dv">0</span>]].size + <span class="dv">1</span>;</span>
<span id="cb37-131"><a aria-hidden="true" href="#cb37-131"></a>    delnode(val);</span>
<span id="cb37-132"><a aria-hidden="true" href="#cb37-132"></a>    <span class="cf">return</span> ans;</span>
<span id="cb37-133"><a aria-hidden="true" href="#cb37-133"></a>}</span>
<span id="cb37-134"><a aria-hidden="true" href="#cb37-134"></a></span>
<span id="cb37-135"><a aria-hidden="true" href="#cb37-135"></a><span class="dt">int</span> getnxt(<span class="dt">int</span> val, <span class="dt">int</span> opt) {</span>
<span id="cb37-136"><a aria-hidden="true" href="#cb37-136"></a>    insert(val);</span>
<span id="cb37-137"><a aria-hidden="true" href="#cb37-137"></a>    <span class="dt">int</span> u = t[root].ch[opt], ans = t[u].val;</span>
<span id="cb37-138"><a aria-hidden="true" href="#cb37-138"></a>    <span class="cf">while</span> (t[u].ch[opt ^ <span class="dv">1</span>])</span>
<span id="cb37-139"><a aria-hidden="true" href="#cb37-139"></a>        u = t[u].ch[opt ^ <span class="dv">1</span>], ans = t[u].val;</span>
<span id="cb37-140"><a aria-hidden="true" href="#cb37-140"></a>    delnode(val);</span>
<span id="cb37-141"><a aria-hidden="true" href="#cb37-141"></a>    <span class="cf">return</span> ans;</span>
<span id="cb37-142"><a aria-hidden="true" href="#cb37-142"></a>}</span>
<span id="cb37-143"><a aria-hidden="true" href="#cb37-143"></a></span>
<span id="cb37-144"><a aria-hidden="true" href="#cb37-144"></a><span class="dt">int</span> main() {</span>
<span id="cb37-145"><a aria-hidden="true" href="#cb37-145"></a>    insert(inf), insert(-inf);</span>
<span id="cb37-146"><a aria-hidden="true" href="#cb37-146"></a>    <span class="dt">int</span> n = read(), m = read();</span>
<span id="cb37-147"><a aria-hidden="true" href="#cb37-147"></a>    <span class="cf">while</span> (n--)</span>
<span id="cb37-148"><a aria-hidden="true" href="#cb37-148"></a>        insert(read());</span>
<span id="cb37-149"><a aria-hidden="true" href="#cb37-149"></a>    <span class="dt">int</span> ans = <span class="dv">0</span>, last = <span class="dv">0</span>;</span>
<span id="cb37-150"><a aria-hidden="true" href="#cb37-150"></a>    <span class="cf">while</span> (m--) {</span>
<span id="cb37-151"><a aria-hidden="true" href="#cb37-151"></a>        <span class="dt">int</span> opt = read(), x = read() ^ last;</span>
<span id="cb37-152"><a aria-hidden="true" href="#cb37-152"></a>        <span class="cf">switch</span> (opt) {</span>
<span id="cb37-153"><a aria-hidden="true" href="#cb37-153"></a>        <span class="cf">case</span> <span class="dv">1</span>:</span>
<span id="cb37-154"><a aria-hidden="true" href="#cb37-154"></a>            insert(x);</span>
<span id="cb37-155"><a aria-hidden="true" href="#cb37-155"></a>            <span class="cf">break</span>;</span>
<span id="cb37-156"><a aria-hidden="true" href="#cb37-156"></a>        <span class="cf">case</span> <span class="dv">2</span>:</span>
<span id="cb37-157"><a aria-hidden="true" href="#cb37-157"></a>            delnode(x);</span>
<span id="cb37-158"><a aria-hidden="true" href="#cb37-158"></a>            <span class="cf">break</span>;</span>
<span id="cb37-159"><a aria-hidden="true" href="#cb37-159"></a>        <span class="cf">case</span> <span class="dv">3</span>:</span>
<span id="cb37-160"><a aria-hidden="true" href="#cb37-160"></a>            ans ^= (last = rank(x) - <span class="dv">1</span>);</span>
<span id="cb37-161"><a aria-hidden="true" href="#cb37-161"></a>            <span class="cf">break</span>;</span>
<span id="cb37-162"><a aria-hidden="true" href="#cb37-162"></a>        <span class="cf">case</span> <span class="dv">4</span>:</span>
<span id="cb37-163"><a aria-hidden="true" href="#cb37-163"></a>            ans ^= (last = kth(x + <span class="dv">1</span>));</span>
<span id="cb37-164"><a aria-hidden="true" href="#cb37-164"></a>            <span class="cf">break</span>;</span>
<span id="cb37-165"><a aria-hidden="true" href="#cb37-165"></a>        <span class="cf">case</span> <span class="dv">5</span>:</span>
<span id="cb37-166"><a aria-hidden="true" href="#cb37-166"></a>            ans ^= (last = getnxt(x, <span class="dv">0</span>));</span>
<span id="cb37-167"><a aria-hidden="true" href="#cb37-167"></a>            <span class="cf">break</span>;</span>
<span id="cb37-168"><a aria-hidden="true" href="#cb37-168"></a>        <span class="cf">case</span> <span class="dv">6</span>:</span>
<span id="cb37-169"><a aria-hidden="true" href="#cb37-169"></a>            ans ^= (last = getnxt(x, <span class="dv">1</span>));</span>
<span id="cb37-170"><a aria-hidden="true" href="#cb37-170"></a>        <span class="cf">default</span>:</span>
<span id="cb37-171"><a aria-hidden="true" href="#cb37-171"></a>            <span class="cf">break</span>;</span>
<span id="cb37-172"><a aria-hidden="true" href="#cb37-172"></a>        }</span>
<span id="cb37-173"><a aria-hidden="true" href="#cb37-173"></a>    }</span>
<span id="cb37-174"><a aria-hidden="true" href="#cb37-174"></a>    printf(<span class="st">"</span><span class="sc">%d\n</span><span class="st">"</span>, ans);</span>
<span id="cb37-175"><a aria-hidden="true" href="#cb37-175"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb37-176"><a aria-hidden="true" href="#cb37-176"></a>}</span></code></pre></div>
<h3 id="æ–‡è‰ºå¹³è¡¡æ ‘çš„å®ç°">æ–‡è‰ºå¹³è¡¡æ ‘çš„å®ç°</h3>
<p>æ–‡è‰ºå¹³è¡¡æ ‘ï¼Œå¯å®ç°å¿«é€ŸåŒºé—´ç¿»è½¬ï¼Œä¸»è¦å¾—ç›Šäº Splay çš„åŒºé—´æ“ä½œåŠŸèƒ½ã€‚å…·ä½“åœ°ï¼Œæˆ‘ä»¬å¯¹åºåˆ— <span class="math inline">\(1 - n\)</span> å»ºä¸€æ£µ Splayï¼Œè¿™æ£µ Splay çš„ä¸­åºéå†å³ä¸ºæˆ‘ä»¬çš„åºåˆ—ã€‚ç„¶åå¦‚æœè¦å¯¹ <span class="math inline">\([l,r]\)</span> ç¿»è½¬ï¼Œå°±éœ€è¦å…ˆæŠŠ <span class="math inline">\([l,r]\)</span> åŒºé—´ç‹¬ç«‹å‡ºæ¥æˆå•ç‹¬ä¸€ä¸ªå­æ ‘ç„¶åæ‰“æ ‡è®°ã€‚æˆ‘ä»¬å¯ä»¥è€ƒè™‘å…ˆæŠŠåœ¨ Splay ä¸­æ’åä¸º <span class="math inline">\(l-1\)</span> çš„ç‚¹ splay åˆ°æ ¹ï¼Œç„¶åå°†æ’åä¸º <span class="math inline">\(r+1\)</span> çš„ç‚¹ splay åˆ°æ ¹ä¸‹æ–¹ï¼Œç”± BST çš„æ€§è´¨æˆ‘ä»¬å¯ä»¥çŸ¥é“æ­¤æ—¶ <span class="math inline">\(r+1\)</span> çš„å·¦å­æ ‘å°±æ˜¯æˆ‘ä»¬çš„ <span class="math inline">\([l,r]\)</span>ã€‚</p>
<p>æ‰¾åˆ°ä¹‹åæ‰“æ ‡è®°å³å¯ï¼Œæ³¨æ„æ—‹è½¬å’Œ Splay ä»¥åŠæ‰¾èŠ‚ç‚¹çš„æ—¶å€™åƒä¸‡è®°å¾—<strong>ä¸‹æ”¾æ ‡è®°</strong>ã€‚</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb38-1"><a aria-hidden="true" href="#cb38-1"></a><span class="kw">inline</span> <span class="dt">void</span> pushdown(<span class="dt">int</span> u) {</span>
<span id="cb38-2"><a aria-hidden="true" href="#cb38-2"></a>    <span class="cf">if</span> (t[u].mark &amp;&amp; u) {</span>
<span id="cb38-3"><a aria-hidden="true" href="#cb38-3"></a>        swap(L, R);</span>
<span id="cb38-4"><a aria-hidden="true" href="#cb38-4"></a>        t[L].mark ^= <span class="dv">1</span>;</span>
<span id="cb38-5"><a aria-hidden="true" href="#cb38-5"></a>        t[R].mark ^= <span class="dv">1</span>;</span>
<span id="cb38-6"><a aria-hidden="true" href="#cb38-6"></a>        t[u].mark = <span class="dv">0</span>;</span>
<span id="cb38-7"><a aria-hidden="true" href="#cb38-7"></a>    }</span>
<span id="cb38-8"><a aria-hidden="true" href="#cb38-8"></a>    <span class="cf">return</span>;</span>
<span id="cb38-9"><a aria-hidden="true" href="#cb38-9"></a>}</span></code></pre></div>
<p>ç„¶åæ˜¯ç¿»è½¬å‡½æ•°çš„å®ç°ã€‚<strong>æ³¨æ„ç”±äº <span class="math inline">\(l-1\)</span> å¯èƒ½ç­‰äº <span class="math inline">\(0\)</span></strong>ï¼Œæ‰€ä»¥éœ€è¦æå‰æ’å…¥æ­£æ— ç©·å’Œè´Ÿæ— ç©·èŠ‚ç‚¹ï¼ŒåŒæ—¶è¯»å…¥çš„ <span class="math inline">\([l,r]\)</span> è¦å„è‡ªè‡ªå¢ <span class="math inline">\(1\)</span>ã€‚<strong>åŒæ—¶æ³¨æ„æ­¤å¤„ <code>find()</code> å‡½æ•°ä¸ä¹‹å‰çš„åŒºåˆ«</strong></p>
<div class="sourceCode" id="cb39"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb39-1"><a aria-hidden="true" href="#cb39-1"></a><span class="dt">int</span> find(<span class="dt">int</span> val) {</span>
<span id="cb39-2"><a aria-hidden="true" href="#cb39-2"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb39-3"><a aria-hidden="true" href="#cb39-3"></a>    <span class="cf">while</span> (<span class="dv">1</span>) {</span>
<span id="cb39-4"><a aria-hidden="true" href="#cb39-4"></a>        pushdown(u);</span>
<span id="cb39-5"><a aria-hidden="true" href="#cb39-5"></a>        <span class="cf">if</span> (val &lt;= t[L].size)</span>
<span id="cb39-6"><a aria-hidden="true" href="#cb39-6"></a>            u = L;</span>
<span id="cb39-7"><a aria-hidden="true" href="#cb39-7"></a>        <span class="cf">else</span> {</span>
<span id="cb39-8"><a aria-hidden="true" href="#cb39-8"></a>            val -= t[L].size + <span class="dv">1</span>;</span>
<span id="cb39-9"><a aria-hidden="true" href="#cb39-9"></a>            <span class="cf">if</span> (!val)</span>
<span id="cb39-10"><a aria-hidden="true" href="#cb39-10"></a>                <span class="cf">return</span> u;</span>
<span id="cb39-11"><a aria-hidden="true" href="#cb39-11"></a>            u = R;</span>
<span id="cb39-12"><a aria-hidden="true" href="#cb39-12"></a>        }</span>
<span id="cb39-13"><a aria-hidden="true" href="#cb39-13"></a>    }</span>
<span id="cb39-14"><a aria-hidden="true" href="#cb39-14"></a>}</span>
<span id="cb39-15"><a aria-hidden="true" href="#cb39-15"></a></span>
<span id="cb39-16"><a aria-hidden="true" href="#cb39-16"></a><span class="dt">void</span> reverse(<span class="dt">int</span> l, <span class="dt">int</span> r) {</span>
<span id="cb39-17"><a aria-hidden="true" href="#cb39-17"></a>    splay(find(l - <span class="dv">1</span>), <span class="dv">0</span>);</span>
<span id="cb39-18"><a aria-hidden="true" href="#cb39-18"></a>    splay(find(r + <span class="dv">1</span>), root);</span>
<span id="cb39-19"><a aria-hidden="true" href="#cb39-19"></a>    <span class="dt">int</span> u = t[root].ch[<span class="dv">1</span>];</span>
<span id="cb39-20"><a aria-hidden="true" href="#cb39-20"></a>    u = t[u].ch[<span class="dv">0</span>];</span>
<span id="cb39-21"><a aria-hidden="true" href="#cb39-21"></a>    t[u].mark ^= <span class="dv">1</span>;</span>
<span id="cb39-22"><a aria-hidden="true" href="#cb39-22"></a>    <span class="cf">return</span>;</span>
<span id="cb39-23"><a aria-hidden="true" href="#cb39-23"></a>}</span></code></pre></div>
<p>å…¨éƒ¨å…·ä½“å®ç°å¦‚ä¸‹ï¼š<a href="https://www.luogu.com.cn/problem/P3391">æ´›è°·P3391</a></p>
<div class="sourceCode" id="cb40"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb40-1"><a aria-hidden="true" href="#cb40-1"></a><span class="pp">#define L </span>(t[u].ch[<span class="dv">0</span>])</span>
<span id="cb40-2"><a aria-hidden="true" href="#cb40-2"></a><span class="pp">#define R </span>(t[u].ch[<span class="dv">1</span>])</span>
<span id="cb40-3"><a aria-hidden="true" href="#cb40-3"></a>...</span>
<span id="cb40-4"><a aria-hidden="true" href="#cb40-4"></a><span class="kw">struct</span> Splay {</span>
<span id="cb40-5"><a aria-hidden="true" href="#cb40-5"></a>    <span class="dt">int</span> ch[<span class="dv">2</span>], fa;</span>
<span id="cb40-6"><a aria-hidden="true" href="#cb40-6"></a>    <span class="dt">int</span> size, val;</span>
<span id="cb40-7"><a aria-hidden="true" href="#cb40-7"></a>    <span class="dt">int</span> mark;</span>
<span id="cb40-8"><a aria-hidden="true" href="#cb40-8"></a>} t[maxn];</span>
<span id="cb40-9"><a aria-hidden="true" href="#cb40-9"></a></span>
<span id="cb40-10"><a aria-hidden="true" href="#cb40-10"></a><span class="dt">int</span> root, cnt, n, m;</span>
<span id="cb40-11"><a aria-hidden="true" href="#cb40-11"></a></span>
<span id="cb40-12"><a aria-hidden="true" href="#cb40-12"></a><span class="dt">void</span> maintain(<span class="dt">int</span> u) {</span>
<span id="cb40-13"><a aria-hidden="true" href="#cb40-13"></a>    t[u].size = t[L].size + t[R].size + <span class="dv">1</span>;</span>
<span id="cb40-14"><a aria-hidden="true" href="#cb40-14"></a>    <span class="cf">return</span>;</span>
<span id="cb40-15"><a aria-hidden="true" href="#cb40-15"></a>}</span>
<span id="cb40-16"><a aria-hidden="true" href="#cb40-16"></a></span>
<span id="cb40-17"><a aria-hidden="true" href="#cb40-17"></a><span class="dt">int</span> get(<span class="dt">int</span> u) {</span>
<span id="cb40-18"><a aria-hidden="true" href="#cb40-18"></a>    <span class="cf">return</span> t[t[u].fa].ch[<span class="dv">1</span>] == u;</span>
<span id="cb40-19"><a aria-hidden="true" href="#cb40-19"></a>}</span>
<span id="cb40-20"><a aria-hidden="true" href="#cb40-20"></a></span>
<span id="cb40-21"><a aria-hidden="true" href="#cb40-21"></a><span class="kw">inline</span> <span class="dt">void</span> pushdown(<span class="dt">int</span> u) {</span>
<span id="cb40-22"><a aria-hidden="true" href="#cb40-22"></a>    <span class="cf">if</span> (t[u].mark &amp;&amp; u) {</span>
<span id="cb40-23"><a aria-hidden="true" href="#cb40-23"></a>        swap(L, R);</span>
<span id="cb40-24"><a aria-hidden="true" href="#cb40-24"></a>        t[L].mark ^= <span class="dv">1</span>;</span>
<span id="cb40-25"><a aria-hidden="true" href="#cb40-25"></a>        t[R].mark ^= <span class="dv">1</span>;</span>
<span id="cb40-26"><a aria-hidden="true" href="#cb40-26"></a>        t[u].mark = <span class="dv">0</span>;</span>
<span id="cb40-27"><a aria-hidden="true" href="#cb40-27"></a>    }</span>
<span id="cb40-28"><a aria-hidden="true" href="#cb40-28"></a>    <span class="cf">return</span>;</span>
<span id="cb40-29"><a aria-hidden="true" href="#cb40-29"></a>}</span>
<span id="cb40-30"><a aria-hidden="true" href="#cb40-30"></a></span>
<span id="cb40-31"><a aria-hidden="true" href="#cb40-31"></a><span class="dt">void</span> rotate(<span class="dt">int</span> u) {</span>
<span id="cb40-32"><a aria-hidden="true" href="#cb40-32"></a>    <span class="dt">int</span> fa = t[u].fa, gfa = t[fa].fa;</span>
<span id="cb40-33"><a aria-hidden="true" href="#cb40-33"></a>    pushdown(fa); pushdown(u);</span>
<span id="cb40-34"><a aria-hidden="true" href="#cb40-34"></a>    <span class="dt">int</span> d1 = get(u), d2 = get(fa);</span>
<span id="cb40-35"><a aria-hidden="true" href="#cb40-35"></a>    t[fa].ch[d1] = t[u].ch[d1 ^ <span class="dv">1</span>];</span>
<span id="cb40-36"><a aria-hidden="true" href="#cb40-36"></a>    t[t[u].ch[d1 ^ <span class="dv">1</span>]].fa = fa;</span>
<span id="cb40-37"><a aria-hidden="true" href="#cb40-37"></a>    t[u].ch[d1 ^ <span class="dv">1</span>] = fa;</span>
<span id="cb40-38"><a aria-hidden="true" href="#cb40-38"></a>    t[fa].fa = u;</span>
<span id="cb40-39"><a aria-hidden="true" href="#cb40-39"></a>    <span class="cf">if</span> (gfa)</span>
<span id="cb40-40"><a aria-hidden="true" href="#cb40-40"></a>        t[gfa].ch[d2] = u;</span>
<span id="cb40-41"><a aria-hidden="true" href="#cb40-41"></a>    t[u].fa = gfa;</span>
<span id="cb40-42"><a aria-hidden="true" href="#cb40-42"></a>    maintain(fa);</span>
<span id="cb40-43"><a aria-hidden="true" href="#cb40-43"></a>    maintain(u);</span>
<span id="cb40-44"><a aria-hidden="true" href="#cb40-44"></a>    <span class="cf">return</span>;</span>
<span id="cb40-45"><a aria-hidden="true" href="#cb40-45"></a>}</span>
<span id="cb40-46"><a aria-hidden="true" href="#cb40-46"></a></span>
<span id="cb40-47"><a aria-hidden="true" href="#cb40-47"></a><span class="dt">void</span> splay(<span class="dt">int</span> u, <span class="dt">int</span> goal) {</span>
<span id="cb40-48"><a aria-hidden="true" href="#cb40-48"></a>    pushdown(u);</span>
<span id="cb40-49"><a aria-hidden="true" href="#cb40-49"></a>    <span class="cf">while</span> (t[u].fa != goal) {</span>
<span id="cb40-50"><a aria-hidden="true" href="#cb40-50"></a>        <span class="dt">int</span> fa = t[u].fa, gfa = t[fa].fa;</span>
<span id="cb40-51"><a aria-hidden="true" href="#cb40-51"></a>        <span class="dt">int</span> d1 = get(u), d2 = get(fa);</span>
<span id="cb40-52"><a aria-hidden="true" href="#cb40-52"></a>        <span class="cf">if</span> (gfa != goal) {</span>
<span id="cb40-53"><a aria-hidden="true" href="#cb40-53"></a>            <span class="cf">if</span> (d1 == d2)</span>
<span id="cb40-54"><a aria-hidden="true" href="#cb40-54"></a>                rotate(fa);</span>
<span id="cb40-55"><a aria-hidden="true" href="#cb40-55"></a>            <span class="cf">else</span> rotate(u);</span>
<span id="cb40-56"><a aria-hidden="true" href="#cb40-56"></a>        }</span>
<span id="cb40-57"><a aria-hidden="true" href="#cb40-57"></a>        rotate(u);</span>
<span id="cb40-58"><a aria-hidden="true" href="#cb40-58"></a>    }</span>
<span id="cb40-59"><a aria-hidden="true" href="#cb40-59"></a>    <span class="cf">if</span> (!goal)</span>
<span id="cb40-60"><a aria-hidden="true" href="#cb40-60"></a>        root = u;</span>
<span id="cb40-61"><a aria-hidden="true" href="#cb40-61"></a>    <span class="cf">return</span>;</span>
<span id="cb40-62"><a aria-hidden="true" href="#cb40-62"></a>}</span>
<span id="cb40-63"><a aria-hidden="true" href="#cb40-63"></a></span>
<span id="cb40-64"><a aria-hidden="true" href="#cb40-64"></a><span class="dt">void</span> build(<span class="dt">int</span> i, <span class="dt">int</span> j, <span class="dt">int</span>&amp; u, <span class="dt">int</span> fa) {</span>
<span id="cb40-65"><a aria-hidden="true" href="#cb40-65"></a>    <span class="dt">int</span> cur = (i + j) &gt;&gt; <span class="dv">1</span>;</span>
<span id="cb40-66"><a aria-hidden="true" href="#cb40-66"></a>    u = ++cnt;</span>
<span id="cb40-67"><a aria-hidden="true" href="#cb40-67"></a>    t[u].fa = fa;</span>
<span id="cb40-68"><a aria-hidden="true" href="#cb40-68"></a>    t[u].size = <span class="dv">1</span>;</span>
<span id="cb40-69"><a aria-hidden="true" href="#cb40-69"></a>    <span class="cf">if</span> (cur == <span class="dv">1</span>)</span>
<span id="cb40-70"><a aria-hidden="true" href="#cb40-70"></a>        t[u].val = -(maxn &lt;&lt; <span class="dv">1</span>);</span>
<span id="cb40-71"><a aria-hidden="true" href="#cb40-71"></a>    <span class="cf">else</span> <span class="cf">if</span> (cur == n + <span class="dv">2</span>)</span>
<span id="cb40-72"><a aria-hidden="true" href="#cb40-72"></a>        t[u].val = maxn &lt;&lt; <span class="dv">1</span>;</span>
<span id="cb40-73"><a aria-hidden="true" href="#cb40-73"></a>    <span class="cf">else</span></span>
<span id="cb40-74"><a aria-hidden="true" href="#cb40-74"></a>        t[u].val = cur - <span class="dv">1</span>;</span>
<span id="cb40-75"><a aria-hidden="true" href="#cb40-75"></a>    <span class="cf">if</span> (cur &gt; i)</span>
<span id="cb40-76"><a aria-hidden="true" href="#cb40-76"></a>        build(i, cur - <span class="dv">1</span>, t[u].ch[<span class="dv">0</span>], u);</span>
<span id="cb40-77"><a aria-hidden="true" href="#cb40-77"></a>    <span class="cf">if</span> (cur &lt; j)</span>
<span id="cb40-78"><a aria-hidden="true" href="#cb40-78"></a>        build(cur + <span class="dv">1</span>, j, t[u].ch[<span class="dv">1</span>], u);</span>
<span id="cb40-79"><a aria-hidden="true" href="#cb40-79"></a>    maintain(u);</span>
<span id="cb40-80"><a aria-hidden="true" href="#cb40-80"></a>    <span class="cf">return</span>;</span>
<span id="cb40-81"><a aria-hidden="true" href="#cb40-81"></a>}</span>
<span id="cb40-82"><a aria-hidden="true" href="#cb40-82"></a></span>
<span id="cb40-83"><a aria-hidden="true" href="#cb40-83"></a><span class="dt">int</span> find(<span class="dt">int</span> val) {</span>
<span id="cb40-84"><a aria-hidden="true" href="#cb40-84"></a>    <span class="dt">int</span> u = root;</span>
<span id="cb40-85"><a aria-hidden="true" href="#cb40-85"></a>    <span class="cf">while</span> (<span class="dv">1</span>) {</span>
<span id="cb40-86"><a aria-hidden="true" href="#cb40-86"></a>        pushdown(u);</span>
<span id="cb40-87"><a aria-hidden="true" href="#cb40-87"></a>        <span class="cf">if</span> (val &lt;= t[L].size)</span>
<span id="cb40-88"><a aria-hidden="true" href="#cb40-88"></a>            u = L;</span>
<span id="cb40-89"><a aria-hidden="true" href="#cb40-89"></a>        <span class="cf">else</span> {</span>
<span id="cb40-90"><a aria-hidden="true" href="#cb40-90"></a>            val -= t[L].size + <span class="dv">1</span>;</span>
<span id="cb40-91"><a aria-hidden="true" href="#cb40-91"></a>            <span class="cf">if</span> (!val)</span>
<span id="cb40-92"><a aria-hidden="true" href="#cb40-92"></a>                <span class="cf">return</span> u;</span>
<span id="cb40-93"><a aria-hidden="true" href="#cb40-93"></a>            u = R;</span>
<span id="cb40-94"><a aria-hidden="true" href="#cb40-94"></a>        }</span>
<span id="cb40-95"><a aria-hidden="true" href="#cb40-95"></a>    }</span>
<span id="cb40-96"><a aria-hidden="true" href="#cb40-96"></a>}</span>
<span id="cb40-97"><a aria-hidden="true" href="#cb40-97"></a></span>
<span id="cb40-98"><a aria-hidden="true" href="#cb40-98"></a><span class="dt">void</span> reverse(<span class="dt">int</span> l, <span class="dt">int</span> r) {</span>
<span id="cb40-99"><a aria-hidden="true" href="#cb40-99"></a>    splay(find(l - <span class="dv">1</span>), <span class="dv">0</span>);</span>
<span id="cb40-100"><a aria-hidden="true" href="#cb40-100"></a>    splay(find(r + <span class="dv">1</span>), root);</span>
<span id="cb40-101"><a aria-hidden="true" href="#cb40-101"></a>    <span class="dt">int</span> u = t[root].ch[<span class="dv">1</span>];</span>
<span id="cb40-102"><a aria-hidden="true" href="#cb40-102"></a>    u = t[u].ch[<span class="dv">0</span>];</span>
<span id="cb40-103"><a aria-hidden="true" href="#cb40-103"></a>    t[u].mark ^= <span class="dv">1</span>;</span>
<span id="cb40-104"><a aria-hidden="true" href="#cb40-104"></a>    <span class="cf">return</span>;</span>
<span id="cb40-105"><a aria-hidden="true" href="#cb40-105"></a>}</span>
<span id="cb40-106"><a aria-hidden="true" href="#cb40-106"></a></span>
<span id="cb40-107"><a aria-hidden="true" href="#cb40-107"></a><span class="dt">void</span> dfs(<span class="dt">int</span> u) {</span>
<span id="cb40-108"><a aria-hidden="true" href="#cb40-108"></a>    <span class="cf">if</span> (!u)</span>
<span id="cb40-109"><a aria-hidden="true" href="#cb40-109"></a>        <span class="cf">return</span>;</span>
<span id="cb40-110"><a aria-hidden="true" href="#cb40-110"></a>    pushdown(u);</span>
<span id="cb40-111"><a aria-hidden="true" href="#cb40-111"></a>    dfs(L);</span>
<span id="cb40-112"><a aria-hidden="true" href="#cb40-112"></a>    <span class="cf">if</span> (t[u].val &lt;= <span class="dv">0</span> || t[u].val &gt; n + <span class="dv">1</span>);</span>
<span id="cb40-113"><a aria-hidden="true" href="#cb40-113"></a>    <span class="cf">else</span></span>
<span id="cb40-114"><a aria-hidden="true" href="#cb40-114"></a>        printf(<span class="st">"</span><span class="sc">%d</span><span class="st"> "</span>, t[u].val);</span>
<span id="cb40-115"><a aria-hidden="true" href="#cb40-115"></a>    dfs(R);</span>
<span id="cb40-116"><a aria-hidden="true" href="#cb40-116"></a>    <span class="cf">return</span>;</span>
<span id="cb40-117"><a aria-hidden="true" href="#cb40-117"></a>}</span>
<span id="cb40-118"><a aria-hidden="true" href="#cb40-118"></a></span>
<span id="cb40-119"><a aria-hidden="true" href="#cb40-119"></a><span class="dt">int</span> main() {</span>
<span id="cb40-120"><a aria-hidden="true" href="#cb40-120"></a>    n = read(), m = read();</span>
<span id="cb40-121"><a aria-hidden="true" href="#cb40-121"></a>    build(<span class="dv">1</span>, n + <span class="dv">2</span>, root, <span class="dv">0</span>);</span>
<span id="cb40-122"><a aria-hidden="true" href="#cb40-122"></a>    <span class="cf">while</span> (m--) {</span>
<span id="cb40-123"><a aria-hidden="true" href="#cb40-123"></a>        <span class="dt">int</span> l = read() + <span class="dv">1</span>, r = read() + <span class="dv">1</span>;</span>
<span id="cb40-124"><a aria-hidden="true" href="#cb40-124"></a>        reverse(l, r);</span>
<span id="cb40-125"><a aria-hidden="true" href="#cb40-125"></a>    }</span>
<span id="cb40-126"><a aria-hidden="true" href="#cb40-126"></a>    dfs(root);</span>
<span id="cb40-127"><a aria-hidden="true" href="#cb40-127"></a>    <span class="cf">return</span> <span class="dv">0</span>;</span>
<span id="cb40-128"><a aria-hidden="true" href="#cb40-128"></a>}</span></code></pre></div>
<h3 id="æ˜“é”™ç‚¹-1">æ˜“é”™ç‚¹</h3>
<ul>
<li>ä¸€å¼€å§‹è®°å¾—<strong>æ’å…¥æ­£è´Ÿæ— ç©·</strong>ï¼Œç„¶ååœ¨<strong>è®¡ç®—æ’åå’Œç¬¬ <span class="math inline">\(k\)</span> å¤§çš„æ—¶å€™è¦è€ƒè™‘å…¶å½±å“</strong></li>
<li><strong>æ—‹è½¬æ“ä½œå®ŒæˆååŠ¡å¿… pushup</strong></li>
<li>å¦‚æœæ¶‰åŠåˆ°æ ‡è®°ä¸‹ä¼ ï¼Œ<strong>éœ€è¦åœ¨å¯èƒ½æ”¹å˜æ ‘å½¢çš„æ—¶å€™æˆ–è€…å‘ä¸‹éå†èŠ‚ç‚¹çš„æ—¶å€™å…ˆ pushdown</strong></li>
<li><strong>æ’å…¥å®Œæˆä¸€ä¸ªèŠ‚ç‚¹ä¹‹åè¦å°†å…¶ splay åˆ°æ ¹</strong>ï¼Œå¦åˆ™å¯èƒ½ <strong>TLE</strong> æˆ–è€…<strong>å¯¼è‡´å…¶çˆ¶äº²çš„ <code>size</code> è®¡ç®—é”™è¯¯</strong>ï¼ˆå› ä¸º splay æ—¶ä¼šä¸€è·¯æ›´æ–° <code>size</code>ï¼‰</li>
<li>splay ä¸€ä¸ªèŠ‚ç‚¹åˆ°æ ¹ä¹‹å<strong>åŠ¡å¿…æ›´æ–° <code>root</code> å˜é‡</strong></li>
<li><strong>å¯¹äºä»»ä½•æ“ä½œï¼Œå¦‚æœè¯¥æ”¹å˜äº†èŠ‚ç‚¹çš„çˆ¶å­å…³ç³»ï¼Œä¸€å®šè®°å¾—æ—¢è¦æ›´æ”¹å„¿å­çš„ï¼Œä¹Ÿè¦æ›´æ”¹çˆ¶äº²çš„</strong></li>
</ul>
<p>è¿™æ ·ï¼Œæœ€åŸºç¡€çš„å¹³è¡¡æ ‘å°±å­¦ä¹ å®Œäº†ï¼Œå½“ç„¶å¹³è¡¡æ ‘è¿˜æœ‰å¾ˆå¤šå…¶ä»–å“ç§ï¼Œå¦‚çº¢é»‘æ ‘ã€AVLã€æ›¿ç½ªç¾Šæ ‘ã€SBT ç­‰ç­‰ï¼Œä½†äº‹å®ä¸Š FHQ-Treap å’Œ Splay å·²ç»åŸºæœ¬èƒ½è§£å†³å¤§å¤šæ•°é—®é¢˜äº†ï¼Œæ‰€ä»¥å°±ä¸å†ç»§ç»­æ·±å…¥äº†ã€‚ç¥å¤§å®¶ debug å¿«ä¹ã€‚</p>
<h2 id="å¯æŒä¹…åŒ–å¹³è¡¡æ ‘">å¯æŒä¹…åŒ–å¹³è¡¡æ ‘</h2>
<h3 id="ç®€ä»‹-1">ç®€ä»‹</h3>
<p>ä¸å¯æŒä¹…åŒ–çº¿æ®µæ ‘ç±»ä¼¼ï¼Œå¯æŒä¹…åŒ–å¹³è¡¡æ ‘æ”¯æŒæ™®é€šå¹³è¡¡æ ‘çš„åŸºæœ¬æ“ä½œï¼ŒåŒæ—¶æ”¯æŒåœ¨æŸä¸ªå†å²ç‰ˆæœ¬çš„åŸºç¡€ä¸Šè¿›è¡ŒæŸ¥è¯¢å’Œä¿®æ”¹ã€‚</p>
<p>é‰´äº splay æ˜¯å‡æ‘Šæ•°æ®ç»“æ„ï¼Œå½¢æ€å¤šå˜ï¼Œä¸å¥½è¿›è¡Œå¯æŒä¹…åŒ–ï¼›è€Œ fhq-treap åªæ¶‰åŠåˆ†è£‚/åˆå¹¶ï¼Œä¸”ä¸æ—‹è½¬ï¼Œå®¹æ˜“å®ç°ï¼Œæ‰€ä»¥ä¸€èˆ¬çš„â€œå¯æŒä¹…åŒ–å¹³è¡¡æ ‘â€å‡æŒ‡â€œå¯æŒä¹…åŒ– fhq-treapâ€</p>
<p>å‰ç½®çŸ¥è¯†ï¼šä¸»å¸­æ ‘ï¼Œfhq-treap</p>
<h3 id="åšæ³•">åšæ³•</h3>
<p>å¯¹äº merge å’Œ split æ“ä½œï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹è¿™äº›è¿‡ç¨‹ç»è¿‡çš„èŠ‚ç‚¹è¿›è¡Œå¤åˆ¶ä»¥è¾¾åˆ°å¯æŒä¹…åŒ–çš„æ•ˆæœã€‚</p>
<p>å…¶ç›¸æ¯”æ™®é€šçš„å¹³è¡¡æ ‘ï¼Œæ˜¯æ²¡æœ‰ä»€ä¹ˆæ”¹å˜çš„ï¼š</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb41-1"><a aria-hidden="true" href="#cb41-1"></a><span class="dt">void</span> split(<span class="dt">int</span> u, <span class="dt">int</span> k, <span class="dt">int</span>&amp; x, <span class="dt">int</span>&amp; y) {</span>
<span id="cb41-2"><a aria-hidden="true" href="#cb41-2"></a>    <span class="cf">if</span> (!u) {</span>
<span id="cb41-3"><a aria-hidden="true" href="#cb41-3"></a>        x = y = <span class="dv">0</span>;</span>
<span id="cb41-4"><a aria-hidden="true" href="#cb41-4"></a>        <span class="cf">return</span>;</span>
<span id="cb41-5"><a aria-hidden="true" href="#cb41-5"></a>    }</span>
<span id="cb41-6"><a aria-hidden="true" href="#cb41-6"></a>    <span class="cf">if</span> (t[u].val &lt;= k) {</span>
<span id="cb41-7"><a aria-hidden="true" href="#cb41-7"></a>        x = clone(u);<span class="co">//*****************</span></span>
<span id="cb41-8"><a aria-hidden="true" href="#cb41-8"></a>        split(t[x].ch[<span class="dv">1</span>], k, t[x].ch[<span class="dv">1</span>], y);</span>
<span id="cb41-9"><a aria-hidden="true" href="#cb41-9"></a>        pushup(x);</span>
<span id="cb41-10"><a aria-hidden="true" href="#cb41-10"></a>    } <span class="cf">else</span> {</span>
<span id="cb41-11"><a aria-hidden="true" href="#cb41-11"></a>        y = clone(u);<span class="co">//*****************</span></span>
<span id="cb41-12"><a aria-hidden="true" href="#cb41-12"></a>        split(t[y].ch[<span class="dv">0</span>], k, x, t[y].ch[<span class="dv">0</span>]);</span>
<span id="cb41-13"><a aria-hidden="true" href="#cb41-13"></a>        pushup(y);</span>
<span id="cb41-14"><a aria-hidden="true" href="#cb41-14"></a>    }</span>
<span id="cb41-15"><a aria-hidden="true" href="#cb41-15"></a>    <span class="cf">return</span>;</span>
<span id="cb41-16"><a aria-hidden="true" href="#cb41-16"></a>}</span></code></pre></div>
<p>å¯¹æ¯”ä¸€ä¸‹æ™®é€šç‰ˆçš„ï¼š</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb42-1"><a aria-hidden="true" href="#cb42-1"></a><span class="dt">void</span> split(<span class="dt">int</span> u, <span class="dt">int</span> k, <span class="dt">int</span> &amp;x, <span class="dt">int</span> &amp;y) {</span>
<span id="cb42-2"><a aria-hidden="true" href="#cb42-2"></a>    <span class="cf">if</span> (!u) {</span>
<span id="cb42-3"><a aria-hidden="true" href="#cb42-3"></a>        x = y = <span class="dv">0</span>;</span>
<span id="cb42-4"><a aria-hidden="true" href="#cb42-4"></a>        <span class="cf">return</span>;</span>
<span id="cb42-5"><a aria-hidden="true" href="#cb42-5"></a>    }</span>
<span id="cb42-6"><a aria-hidden="true" href="#cb42-6"></a>    <span class="cf">if</span> (t[u].val &lt;= k)</span>
<span id="cb42-7"><a aria-hidden="true" href="#cb42-7"></a>        x = u, split(R, k, R, y);</span>
<span id="cb42-8"><a aria-hidden="true" href="#cb42-8"></a>    <span class="cf">else</span></span>
<span id="cb42-9"><a aria-hidden="true" href="#cb42-9"></a>        y = u, split(L, k, x, L);</span>
<span id="cb42-10"><a aria-hidden="true" href="#cb42-10"></a>    pushup(u);</span>
<span id="cb42-11"><a aria-hidden="true" href="#cb42-11"></a>    <span class="cf">return</span>;</span>
<span id="cb42-12"><a aria-hidden="true" href="#cb42-12"></a>}</span></code></pre></div>
<p>æ³¨æ„ä¸€ä¸‹æ˜Ÿå·çš„å‡ è¡Œã€‚å…¶æœ¬è´¨ä¹Ÿå°±æ˜¯å¯¹è¿›è¡Œäº†ä¿®æ”¹çš„èŠ‚ç‚¹è¿›è¡Œå¢åŠ å¹¶ä¸”å¤åˆ¶ã€‚</p>
<p>ç”±äºæˆ‘ä»¬è¿›è¡Œä¿®æ”¹çš„æ—¶å€™ï¼Œsplit å’Œ merge æ˜¯æˆå¯¹å­˜åœ¨çš„ï¼Œæ‰€ä»¥åœ¨ merge çš„æ—¶å€™å°±ä¸éœ€è¦å†å¤åˆ¶ä¸€éèŠ‚ç‚¹äº†ã€‚</p>
<p>å®¹æ˜“å‡ºé”™çš„åœ°æ–¹ï¼š</p>
<ul>
<li>å¦‚æœå­˜åœ¨ pushdown æ“ä½œï¼Œé‚£ä¹ˆ pushdown çš„æ—¶å€™ä¹Ÿè¦å¤åˆ¶ä¸€éèŠ‚ç‚¹</li>
<li>æ³¨æ„å“ªé‡Œè¦ pushdown ä»¥åŠå“ªé‡Œä¸è¦ pushdown</li>
<li>æ€è€ƒæ¸…æ¥šå„ä¸ªæ•°æ®é—´è¢«è°ƒç”¨çš„å…ˆåé¡ºåºåŠå…³ç³»</li>
</ul>
<h3 id="æ™®é€šå¹³è¡¡æ ‘çš„å®ç°-2">æ™®é€šå¹³è¡¡æ ‘çš„å®ç°</h3>
<div class="sourceCode" id="cb43"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb43-1"><a aria-hidden="true" href="#cb43-1"></a><span class="pp">#include </span><span class="im">&lt;cstdio&gt;</span></span>
<span id="cb43-2"><a aria-hidden="true" href="#cb43-2"></a><span class="pp">#include </span><span class="im">&lt;cctype&gt;</span></span>
<span id="cb43-3"><a aria-hidden="true" href="#cb43-3"></a><span class="pp">#include </span><span class="im">&lt;cstdlib&gt;</span></span>
<span id="cb43-4"><a aria-hidden="true" href="#cb43-4"></a><span class="pp">#define il </span><span class="kw">inline</span></span>
<span id="cb43-5"><a aria-hidden="true" href="#cb43-5"></a><span class="pp">#define FOR</span>(i,<span class="pp"> </span>a,<span class="pp"> </span>b)<span class="pp"> </span><span class="cf">for</span><span class="pp"> </span>(<span class="dt">int</span><span class="pp"> </span>i<span class="pp"> </span>=<span class="pp"> </span>a;<span class="pp"> </span>i<span class="pp"> </span>&lt;=<span class="pp"> </span>b;<span class="pp"> </span>++i)</span>
<span id="cb43-6"><a aria-hidden="true" href="#cb43-6"></a><span class="pp">#define DEC</span>(i,<span class="pp"> </span>a,<span class="pp"> </span>b)<span class="pp"> </span><span class="cf">for</span><span class="pp"> </span>(<span class="dt">int</span><span class="pp"> </span>i<span class="pp"> </span>=<span class="pp"> </span>a;<span class="pp"> </span>i<span class="pp"> </span>&gt;=<span class="pp"> </span>b;<span class="pp"> </span>--i)</span>
<span id="cb43-7"><a aria-hidden="true" href="#cb43-7"></a></span>
<span id="cb43-8"><a aria-hidden="true" href="#cb43-8"></a><span class="kw">namespace</span> fastIO {</span>
<span id="cb43-9"><a aria-hidden="true" href="#cb43-9"></a>    <span class="at">const</span> <span class="dt">int</span> maxc = <span class="dv">1</span> &lt;&lt; <span class="dv">21</span>;</span>
<span id="cb43-10"><a aria-hidden="true" href="#cb43-10"></a>    <span class="dt">char</span> ibuf[maxc], * __p1 = ibuf, * __p2 = ibuf;</span>
<span id="cb43-11"><a aria-hidden="true" href="#cb43-11"></a>    il <span class="dt">char</span> getchar() { <span class="cf">return</span> __p1 == __p2 &amp;&amp; (__p2 = (__p1 = ibuf) + fread(ibuf, <span class="dv">1</span>, maxc, stdin), __p1 == __p2) ? EOF : *__p1++; }</span>
<span id="cb43-12"><a aria-hidden="true" href="#cb43-12"></a>    <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt; <span class="dt">void</span> read(T&amp; n) {</span>
<span id="cb43-13"><a aria-hidden="true" href="#cb43-13"></a>        <span class="dt">int</span> x = <span class="dv">0</span>; n = <span class="dv">0</span>;</span>
<span id="cb43-14"><a aria-hidden="true" href="#cb43-14"></a>        <span class="dt">char</span> c = getchar();</span>
<span id="cb43-15"><a aria-hidden="true" href="#cb43-15"></a>        <span class="cf">while</span> (!isdigit(c))</span>
<span id="cb43-16"><a aria-hidden="true" href="#cb43-16"></a>            x |= (c == <span class="ch">'-'</span>), c = getchar();</span>
<span id="cb43-17"><a aria-hidden="true" href="#cb43-17"></a>        <span class="cf">while</span> (isdigit(c))</span>
<span id="cb43-18"><a aria-hidden="true" href="#cb43-18"></a>            n = n * <span class="dv">10</span> + c - <span class="ch">'0'</span>, c = getchar();</span>
<span id="cb43-19"><a aria-hidden="true" href="#cb43-19"></a>        n = x ? -n : n;</span>
<span id="cb43-20"><a aria-hidden="true" href="#cb43-20"></a>    }</span>
<span id="cb43-21"><a aria-hidden="true" href="#cb43-21"></a>    <span class="dt">char</span> obuf[maxc], * __pO = obuf;</span>
<span id="cb43-22"><a aria-hidden="true" href="#cb43-22"></a>    il <span class="dt">void</span> putchar(<span class="dt">char</span> c) { *__pO++ = c; }</span>
<span id="cb43-23"><a aria-hidden="true" href="#cb43-23"></a>    <span class="kw">template</span>&lt;<span class="kw">typename</span> T&gt; <span class="dt">void</span> print(T x) {</span>
<span id="cb43-24"><a aria-hidden="true" href="#cb43-24"></a>        <span class="cf">if</span> (x &lt; <span class="dv">0</span>) putchar(<span class="ch">'-'</span>), print(-x);</span>
<span id="cb43-25"><a aria-hidden="true" href="#cb43-25"></a>        <span class="cf">else</span> {</span>
<span id="cb43-26"><a aria-hidden="true" href="#cb43-26"></a>            <span class="cf">if</span> (x &gt; <span class="dv">9</span>) print(x / <span class="dv">10</span>);</span>
<span id="cb43-27"><a aria-hidden="true" href="#cb43-27"></a>            putchar(x % <span class="dv">10</span> + <span class="ch">'0'</span>);</span>
<span id="cb43-28"><a aria-hidden="true" href="#cb43-28"></a>        }</span>
<span id="cb43-29"><a aria-hidden="true" href="#cb43-29"></a>        <span class="cf">return</span>;</span>
<span id="cb43-30"><a aria-hidden="true" href="#cb43-30"></a>    }</span>
<span id="cb43-31"><a aria-hidden="true" href="#cb43-31"></a>    <span class="dt">void</span> output() { fwrite(obuf, __pO - obuf, <span class="dv">1</span>, stdout); }</span>
<span id="cb43-32"><a aria-hidden="true" href="#cb43-32"></a>}</span>
<span id="cb43-33"><a aria-hidden="true" href="#cb43-33"></a></span>
<span id="cb43-34"><a aria-hidden="true" href="#cb43-34"></a><span class="kw">using</span> <span class="kw">namespace</span> fastIO;</span>
<span id="cb43-35"><a aria-hidden="true" href="#cb43-35"></a></span>
<span id="cb43-36"><a aria-hidden="true" href="#cb43-36"></a><span class="at">const</span> <span class="dt">int</span> maxn = <span class="fl">5e5</span> + <span class="dv">5</span>;</span>
<span id="cb43-37"><a aria-hidden="true" href="#cb43-37"></a></span>
<span id="cb43-38"><a aria-hidden="true" href="#cb43-38"></a><span class="dt">int</span> root[maxn], cnt;</span>
<span id="cb43-39"><a aria-hidden="true" href="#cb43-39"></a></span>
<span id="cb43-40"><a aria-hidden="true" href="#cb43-40"></a><span class="kw">struct</span> node {</span>
<span id="cb43-41"><a aria-hidden="true" href="#cb43-41"></a>    <span class="dt">int</span> ch[<span class="dv">2</span>], size, val, key;</span>
<span id="cb43-42"><a aria-hidden="true" href="#cb43-42"></a>    <span class="dt">void</span> clear() {ch[<span class="dv">0</span>] = ch[<span class="dv">1</span>] = size = val = key = <span class="dv">0</span>;}</span>
<span id="cb43-43"><a aria-hidden="true" href="#cb43-43"></a>} t[maxn * <span class="dv">50</span>];</span>
<span id="cb43-44"><a aria-hidden="true" href="#cb43-44"></a></span>
<span id="cb43-45"><a aria-hidden="true" href="#cb43-45"></a><span class="pp">#define L </span>t[u].ch[<span class="dv">0</span>]</span>
<span id="cb43-46"><a aria-hidden="true" href="#cb43-46"></a><span class="pp">#define R </span>t[u].ch[<span class="dv">1</span>]</span>
<span id="cb43-47"><a aria-hidden="true" href="#cb43-47"></a></span>
<span id="cb43-48"><a aria-hidden="true" href="#cb43-48"></a>il <span class="dt">void</span> pushup(<span class="dt">int</span> u) { t[u].size = t[L].size + t[R].size + <span class="dv">1</span>; }</span>
<span id="cb43-49"><a aria-hidden="true" href="#cb43-49"></a></span>
<span id="cb43-50"><a aria-hidden="true" href="#cb43-50"></a>il <span class="dt">int</span> newnode() { <span class="cf">return</span> ++cnt; }</span>
<span id="cb43-51"><a aria-hidden="true" href="#cb43-51"></a></span>
<span id="cb43-52"><a aria-hidden="true" href="#cb43-52"></a>il <span class="dt">int</span> newnode(<span class="dt">int</span> val) {</span>
<span id="cb43-53"><a aria-hidden="true" href="#cb43-53"></a>    <span class="dt">int</span> u = newnode();</span>
<span id="cb43-54"><a aria-hidden="true" href="#cb43-54"></a>    t[u].ch[<span class="dv">0</span>] = t[u].ch[<span class="dv">1</span>] = <span class="dv">0</span>, t[u].size = <span class="dv">1</span>, t[u].val = val, t[u].key = rand();</span>
<span id="cb43-55"><a aria-hidden="true" href="#cb43-55"></a>    <span class="cf">return</span> u;</span>
<span id="cb43-56"><a aria-hidden="true" href="#cb43-56"></a>}</span>
<span id="cb43-57"><a aria-hidden="true" href="#cb43-57"></a></span>
<span id="cb43-58"><a aria-hidden="true" href="#cb43-58"></a><span class="dt">int</span> merge(<span class="dt">int</span> x, <span class="dt">int</span> y) {</span>
<span id="cb43-59"><a aria-hidden="true" href="#cb43-59"></a>    <span class="cf">if</span> (!x || !y) <span class="cf">return</span> x ^ y;</span>
<span id="cb43-60"><a aria-hidden="true" href="#cb43-60"></a>    <span class="cf">if</span> (t[x].key &lt; t[y].key)</span>
<span id="cb43-61"><a aria-hidden="true" href="#cb43-61"></a>        <span class="cf">return</span> t[x].ch[<span class="dv">1</span>] = merge(t[x].ch[<span class="dv">1</span>], y), pushup(x), x;</span>
<span id="cb43-62"><a aria-hidden="true" href="#cb43-62"></a>    <span class="cf">else</span> <span class="cf">return</span> t[y].ch[<span class="dv">0</span>] = merge(x, t[y].ch[<span class="dv">0</span>]), pushup(y), y;</span>
<span id="cb43-63"><a aria-hidden="true" href="#cb43-63"></a>}</span>
<span id="cb43-64"><a aria-hidden="true" href="#cb43-64"></a></span>
<span id="cb43-65"><a aria-hidden="true" href="#cb43-65"></a><span class="dt">void</span> split(<span class="dt">int</span> u, <span class="dt">int</span> k, <span class="dt">int</span>&amp; x, <span class="dt">int</span>&amp; y) {</span>
<span id="cb43-66"><a aria-hidden="true" href="#cb43-66"></a>    <span class="cf">if</span> (!u) {</span>
<span id="cb43-67"><a aria-hidden="true" href="#cb43-67"></a>        x = y = <span class="dv">0</span>;</span>
<span id="cb43-68"><a aria-hidden="true" href="#cb43-68"></a>        <span class="cf">return</span>;</span>
<span id="cb43-69"><a aria-hidden="true" href="#cb43-69"></a>    }</span>
<span id="cb43-70"><a aria-hidden="true" href="#cb43-70"></a>    <span class="cf">if</span> (t[u].val &lt;= k) {</span>
<span id="cb43-71"><a aria-hidden="true" href="#cb43-71"></a>        x = newnode(), t[x] = t[u];</span>
<span id="cb43-72"><a aria-hidden="true" href="#cb43-72"></a>        split(t[x].ch[<span class="dv">1</span>], k, t[x].ch[<span class="dv">1</span>], y);</span>
<span id="cb43-73"><a aria-hidden="true" href="#cb43-73"></a>        pushup(x);</span>
<span id="cb43-74"><a aria-hidden="true" href="#cb43-74"></a>    } <span class="cf">else</span> {</span>
<span id="cb43-75"><a aria-hidden="true" href="#cb43-75"></a>        y = newnode(), t[y] = t[u];</span>
<span id="cb43-76"><a aria-hidden="true" href="#cb43-76"></a>        split(t[y].ch[<span class="dv">0</span>], k, x, t[y].ch[<span class="dv">0</span>]);</span>
<span id="cb43-77"><a aria-hidden="true" href="#cb43-77"></a>        pushup(y);</span>
<span id="cb43-78"><a aria-hidden="true" href="#cb43-78"></a>    }</span>
<span id="cb43-79"><a aria-hidden="true" href="#cb43-79"></a>    <span class="cf">return</span>;</span>
<span id="cb43-80"><a aria-hidden="true" href="#cb43-80"></a>}</span>
<span id="cb43-81"><a aria-hidden="true" href="#cb43-81"></a></span>
<span id="cb43-82"><a aria-hidden="true" href="#cb43-82"></a><span class="dt">void</span> insert(<span class="dt">int</span>&amp; u, <span class="dt">int</span> val) {</span>
<span id="cb43-83"><a aria-hidden="true" href="#cb43-83"></a>    <span class="dt">int</span> x, y, z;</span>
<span id="cb43-84"><a aria-hidden="true" href="#cb43-84"></a>    split(u, val, x, z);</span>
<span id="cb43-85"><a aria-hidden="true" href="#cb43-85"></a>    y = newnode(val);</span>
<span id="cb43-86"><a aria-hidden="true" href="#cb43-86"></a>    u = merge(merge(x, y), z);</span>
<span id="cb43-87"><a aria-hidden="true" href="#cb43-87"></a>    <span class="cf">return</span>;</span>
<span id="cb43-88"><a aria-hidden="true" href="#cb43-88"></a>}</span>
<span id="cb43-89"><a aria-hidden="true" href="#cb43-89"></a></span>
<span id="cb43-90"><a aria-hidden="true" href="#cb43-90"></a><span class="dt">void</span> delNode(<span class="dt">int</span>&amp; u, <span class="dt">int</span> val) {</span>
<span id="cb43-91"><a aria-hidden="true" href="#cb43-91"></a>    <span class="dt">int</span> x, y, z;</span>
<span id="cb43-92"><a aria-hidden="true" href="#cb43-92"></a>    split(u, val, x, z);</span>
<span id="cb43-93"><a aria-hidden="true" href="#cb43-93"></a>    split(x, val - <span class="dv">1</span>, x, y);</span>
<span id="cb43-94"><a aria-hidden="true" href="#cb43-94"></a>    y = merge(t[y].ch[<span class="dv">0</span>], t[y].ch[<span class="dv">1</span>]);</span>
<span id="cb43-95"><a aria-hidden="true" href="#cb43-95"></a>    u = merge(merge(x, y), z);</span>
<span id="cb43-96"><a aria-hidden="true" href="#cb43-96"></a>    <span class="cf">return</span>;</span>
<span id="cb43-97"><a aria-hidden="true" href="#cb43-97"></a>}</span>
<span id="cb43-98"><a aria-hidden="true" href="#cb43-98"></a></span>
<span id="cb43-99"><a aria-hidden="true" href="#cb43-99"></a><span class="dt">int</span> getRank(<span class="dt">int</span>&amp; u, <span class="dt">int</span> val) {</span>
<span id="cb43-100"><a aria-hidden="true" href="#cb43-100"></a>    <span class="dt">int</span> x, y;</span>
<span id="cb43-101"><a aria-hidden="true" href="#cb43-101"></a>    split(u, val - <span class="dv">1</span>, x, y);</span>
<span id="cb43-102"><a aria-hidden="true" href="#cb43-102"></a>    <span class="dt">int</span> ans = t[x].size + <span class="dv">1</span>;</span>
<span id="cb43-103"><a aria-hidden="true" href="#cb43-103"></a>    u = merge(x, y);</span>
<span id="cb43-104"><a aria-hidden="true" href="#cb43-104"></a>    <span class="cf">return</span> ans;</span>
<span id="cb43-105"><a aria-hidden="true" href="#cb43-105"></a>}</span>
<span id="cb43-106"><a aria-hidden="true" href="#cb43-106"></a></span>
<span id="cb43-107"><a aria-hidden="true" href="#cb43-107"></a><span class="dt">int</span> getKth(<span class="dt">int</span> u, <span class="dt">int</span> k) {</span>
<span id="cb43-108"><a aria-hidden="true" href="#cb43-108"></a>    <span class="cf">if</span> (k == t[L].size + <span class="dv">1</span>) <span class="cf">return</span> t[u].val;</span>
<span id="cb43-109"><a aria-hidden="true" href="#cb43-109"></a>    <span class="cf">else</span> <span class="cf">if</span> (k &lt;= t[L].size) <span class="cf">return</span> getKth(L, k);</span>
<span id="cb43-110"><a aria-hidden="true" href="#cb43-110"></a>    <span class="cf">else</span> <span class="cf">return</span> getKth(R, k - t[L].size - <span class="dv">1</span>);</span>
<span id="cb43-111"><a aria-hidden="true" href="#cb43-111"></a>}</span>
<span id="cb43-112"><a aria-hidden="true" href="#cb43-112"></a></span>
<span id="cb43-113"><a aria-hidden="true" href="#cb43-113"></a><span class="dt">int</span> getPre(<span class="dt">int</span>&amp; root, <span class="dt">int</span> val) {</span>
<span id="cb43-114"><a aria-hidden="true" href="#cb43-114"></a>    <span class="dt">int</span> x, y, ans;</span>
<span id="cb43-115"><a aria-hidden="true" href="#cb43-115"></a>    split(root, val - <span class="dv">1</span>, x, y);</span>
<span id="cb43-116"><a aria-hidden="true" href="#cb43-116"></a>    <span class="cf">if</span> (!x) <span class="cf">return</span> -<span class="dv">2147483647</span>;</span>
<span id="cb43-117"><a aria-hidden="true" href="#cb43-117"></a>    ans = getKth(x, t[x].size);</span>
<span id="cb43-118"><a aria-hidden="true" href="#cb43-118"></a>    root = merge(x, y);</span>
<span id="cb43-119"><a aria-hidden="true" href="#cb43-119"></a>    <span class="cf">return</span> ans;</span>
<span id="cb43-120"><a aria-hidden="true" href="#cb43-120"></a>}</span>
<span id="cb43-121"><a aria-hidden="true" href="#cb43-121"></a></span>
<span id="cb43-122"><a aria-hidden="true" href="#cb43-122"></a><span class="dt">int</span> getSuc(<span class="dt">int</span>&amp; root, <span class="dt">int</span> val) {</span>
<span id="cb43-123"><a aria-hidden="true" href="#cb43-123"></a>    <span class="dt">int</span> x, y, ans;</span>
<span id="cb43-124"><a aria-hidden="true" href="#cb43-124"></a>    split(root, val, x, y);</span>
<span id="cb43-125"><a aria-hidden="true" href="#cb43-125"></a>    <span class="cf">if</span> (!y) <span class="cf">return</span> <span class="dv">2147483647</span>;</span>
<span id="cb43-126"><a aria-hidden="true" href="#cb43-126"></a>    ans = getKth(y, <span class="dv">1</span>);</span>
<span id="cb43-127"><a aria-hidden="true" href="#cb43-127"></a>    root = merge(x, y);</span>
<span id="cb43-128"><a aria-hidden="true" href="#cb43-128"></a>    <span class="cf">return</span> ans;</span>
<span id="cb43-129"><a aria-hidden="true" href="#cb43-129"></a>}</span>
<span id="cb43-130"><a aria-hidden="true" href="#cb43-130"></a></span>
<span id="cb43-131"><a aria-hidden="true" href="#cb43-131"></a><span class="dt">int</span> main() {</span>
<span id="cb43-132"><a aria-hidden="true" href="#cb43-132"></a>    srand(<span class="dv">20041031</span>);</span>
<span id="cb43-133"><a aria-hidden="true" href="#cb43-133"></a>    <span class="dt">int</span> n; read(n);</span>
<span id="cb43-134"><a aria-hidden="true" href="#cb43-134"></a>    FOR(i, <span class="dv">1</span>, n) {</span>
<span id="cb43-135"><a aria-hidden="true" href="#cb43-135"></a>        <span class="dt">int</span> v, op, val; read(v), read(op), read(val);</span>
<span id="cb43-136"><a aria-hidden="true" href="#cb43-136"></a>        root[i] = root[v];</span>
<span id="cb43-137"><a aria-hidden="true" href="#cb43-137"></a>        <span class="cf">if</span> (op == <span class="dv">1</span>) insert(root[i], val);</span>
<span id="cb43-138"><a aria-hidden="true" href="#cb43-138"></a>        <span class="cf">else</span> <span class="cf">if</span> (op == <span class="dv">2</span>) delNode(root[i], val);</span>
<span id="cb43-139"><a aria-hidden="true" href="#cb43-139"></a>        <span class="cf">else</span> <span class="cf">if</span> (op == <span class="dv">3</span>) print(getRank(root[i], val)), putchar(<span class="ch">'</span><span class="sc">\n</span><span class="ch">'</span>);</span>
<span id="cb43-140"><a aria-hidden="true" href="#cb43-140"></a>        <span class="cf">else</span> <span class="cf">if</span> (op == <span class="dv">4</span>) print(getKth(root[i], val)), putchar(<span class="ch">'</span><span class="sc">\n</span><span class="ch">'</span>);</span>
<span id="cb43-141"><a aria-hidden="true" href="#cb43-141"></a>        <span class="cf">else</span> <span class="cf">if</span> (op == <span class="dv">5</span>) print(getPre(root[i], val)), putchar(<span class="ch">'</span><span class="sc">\n</span><span class="ch">'</span>);</span>
<span id="cb43-142"><a aria-hidden="true" href="#cb43-142"></a>        <span class="cf">else</span> <span class="cf">if</span> (op == <span class="dv">6</span>) print(getSuc(root[i], val)), putchar(<span class="ch">'</span><span class="sc">\n</span><span class="ch">'</span>);</span>
<span id="cb43-143"><a aria-hidden="true" href="#cb43-143"></a>    }</span>
<span id="cb43-144"><a aria-hidden="true" href="#cb43-144"></a>    <span class="cf">return</span> output(), <span class="dv">0</span>;</span>
<span id="cb43-145"><a aria-hidden="true" href="#cb43-145"></a>}</span></code></pre></div>
</section>
<footer class="article-footer">
<section class="article-tags">
<a href="/tags/OI/">OI</a>
<a href="/tags/note/">ç¬”è®°</a>
<a href="/tags/balanced-bst/">å¹³è¡¡æ ‘</a>
</section>
<section class="article-copyright">
<svg class="icon icon-tabler icon-tabler-copyright" fill="none" height="24" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" viewbox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg">
<path d="M0 0h24v24H0z" stroke="none"></path>
<circle cx="12" cy="12" r="9"></circle>
<path d="M14.5 9a3.5 4 0 1 0 0 6"></path>
</svg>
<span>Licensed under CC BY-NC-SA 4.0</span>
</section>
</footer>
<link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.css" integrity="sha384-RZU/ijkSsFbcmivfdRBQDtwuwVqK7GMOw6IMvKyeWL2K5UAlyp6WonmB8m7Jd0Hn" rel="stylesheet"/><script crossorigin="anonymous" defer="" integrity="sha384-pK1WpvzWVBQiP0/GjnvRxV4mOb0oxFuyRxJlk6vVw146n3egcN5C925NCP7a7BY8" src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/katex.min.js">
</script><script crossorigin="anonymous" defer="" integrity="sha384-vZTG03m+2yp6N6BNi5iM4rW4oIwk5DfcNdFfxkk9ZWpDriOkXX8voJBFrAO7MpVl" src="https://cdn.jsdelivr.net/npm/katex@0.13.13/dist/contrib/auto-render.min.js">
</script><script>
    window.addEventListener("DOMContentLoaded", () => {
        renderMathInElement(document.querySelector(`.article-content`), {
            delimiters: [
                { left: "$$", right: "$$", display: true },
                { left: "$", right: "$", display: false },
                { left: "\\(", right: "\\)", display: false },
                { left: "\\[", right: "\\]", display: true }
            ]
        });})
</script>
</article>
<aside class="related-contents--wrapper">
<h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
<div class="related-contents">
<div class="flex article-list--tile">
<article class="has-image">
<a href="/note-gf/">
<div class="article-image">
<img data-hash="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg28.webp" data-key="" loading="lazy" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg28.webp"/>
</div>
<div class="article-details">
<h2 class="article-title">ç”Ÿæˆå‡½æ•°èƒ¡æ‰¯</h2>
</div>
</a>
</article>
<article class="has-image">
<a href="/note-set-power-series/">
<div class="article-image">
<img data-hash="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg39.webp" data-key="" loading="lazy" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg39.webp"/>
</div>
<div class="article-details">
<h2 class="article-title">é›†åˆå¹‚çº§æ•°èƒ¡æ‰¯</h2>
</div>
</a>
</article>
<article class="has-image">
<a href="/note-linear-basis/">
<div class="article-image">
<img data-hash="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg19.webp" data-key="" loading="lazy" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg19.webp"/>
</div>
<div class="article-details">
<h2 class="article-title">çº¿æ€§åŸºå­¦ä¹ ç¬”è®°</h2>
</div>
</a>
</article>
<article class="has-image">
<a href="/note-wqs/">
<div class="article-image">
<img data-hash="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg28.webp" data-key="" loading="lazy" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg28.webp"/>
</div>
<div class="article-details">
<h2 class="article-title">wqs äºŒåˆ†å­¦ä¹ ç¬”è®°</h2>
</div>
</a>
</article>
<article class="has-image">
<a href="/sol-sp-gss/">
<div class="article-image">
<img data-hash="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg41.webp" data-key="" loading="lazy" src="https://yangty-pic.oss-cn-beijing.aliyuncs.com/bg41.webp"/>
</div>
<div class="article-details">
<h2 class="article-title">SPOJ GSS ç³»åˆ—é¢˜è§£</h2>
</div>
</a>
</article>
</div>
</div>
</aside>
<footer class="site-footer">
<section class="copyright">
        Â© 
        
            2019 - 
        
        2024 æ¸…çƒ›çš„åšå®¢
    </section>
<section class="powerby">
        Built with <a href="https://gohugo.io/" rel="noopener" target="_blank">Hugo</a> <br/>
        ä¸»é¢˜ <b><a data-version="3.11.0" href="https://github.com/CaiJimmy/hugo-theme-stack" rel="noopener" target="_blank">Stack</a></b> ç”± <a href="https://jimmycai.com" rel="noopener" target="_blank">Jimmy</a> è®¾è®¡
    </section>
</footer>
<div aria-hidden="true" class="pswp" role="dialog" tabindex="-1">
<div class="pswp__bg"></div>
<div class="pswp__scroll-wrap">
<div class="pswp__container">
<div class="pswp__item"></div>
<div class="pswp__item"></div>
<div class="pswp__item"></div>
</div>
<div class="pswp__ui pswp__ui--hidden">
<div class="pswp__top-bar">
<div class="pswp__counter"></div>
<button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title="Share"></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
<div class="pswp__preloader">
<div class="pswp__preloader__icn">
<div class="pswp__preloader__cut">
<div class="pswp__preloader__donut"></div>
</div>
</div>
</div>
</div>
<div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
<div class="pswp__share-tooltip"></div>
</div>
<button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
</button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
</button>
<div class="pswp__caption">
<div class="pswp__caption__center"></div>
</div>
</div>
</div>
</div><script crossorigin="anonymous" defer="" integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js">
</script><script crossorigin="anonymous" defer="" integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js">
</script><link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css" integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" rel="stylesheet"/><link crossorigin="anonymous" href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css" integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" rel="stylesheet"/>
</main>
</div>
<script crossorigin="anonymous" integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js">
</script><script defer="" src="/ts/main.js" type="text/javascript"></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>
</body>
</html>
